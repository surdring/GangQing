---
trigger: always
---

# Project Rules (AGENTS)

## 1) 语言
- 始终使用中文回复（除非用户明确要求使用其他语言）。所有文档必须使用中文编写。

## 2) 文档生成与落盘
- 当用户要求“生成文档/规范/模板/清单”等内容时：
  - 必须根据仓库目录结构，选择**合理的目标目录**。
  - 必须以 **Markdown（.md）** 格式在目标目录中**创建文件并写入内容**（而不是只在聊天中输出）。
  - 若用户未指定目标目录或命名：
    - 先提出 1-3 个建议路径与文件名供用户确认，再创建文件。

- **强制：文档生成后的任务提示词同步**（验收日志/审查报告除外）：
  - 触发条件：当 AI 编码助手新增或更新**非日志类文档**（例如 `docs/` 下的 API 文档、契约、规范、设计说明等）。
  - 排除范围：`reports/` 下的验收日志（`reports/YYYY-MM-DD_T{N}_*.md`）与代码审查报告（`*-review.md`）不触发该规则。
  - 强制动作：必须同步更新**后续相关任务**的提示词文件 `docs/task-prompts/*.md`：

    - 在提示词中新增或更新“权威参考文档/约束来源”段落，明确引用新文档路径（例如：`docs/api/semantic-api.md`、`docs/contracts/api-and-events-draft.md`）。
    - 若提示词包含实现要求/验收标准/错误码/请求头/隔离规则等内容，必须显式声明以这些文档为准，避免后续任务出现契约漂移。
    - 同步完成后，需在对应任务的 `# Checklist` 中勾选“文档引用已同步/Doc References Updated”（若该项存在；不存在则新增该项并勾选）。

- **文档生成失败处理**：
  - 如果 `fsWrite` 操作失败或被中止，**必须**在聊天的代码块中以完整 Markdown 格式显示所有内容
  - 代码块必须使用 ` ```markdown ` 标记
  - 内容必须完整，包含所有审查维度和结论
  - 提示用户可以直接复制内容到文件中

## 3) 任务状态标记
- 任务**只有在自动化验证通过后**方可标记完成（避免“文档已完成但代码不可运行”）：
  - 优先运行任务说明中指定的验证命令；若未指定，则运行仓库默认验证命令（按变更范围选择后端/前端）。
  - 若变更范围仅影响某个子目录（例如仅 `web/` 或仅 `backend/`），应在对应目录执行其脚本，并在验收日志中写明命令与结果。
  - 若因环境/依赖缺失导致无法运行验证，必须在任务条目中记录原因与补验收计划，**不得直接标记完成**。

- **强制：每个任务必须同时具备冒烟测试与单元测试**（覆盖驱动；两者都必须实际运行并通过）：
  - **覆盖要求（必须满足）**
    - **单元测试（Unit Test）**：覆盖核心纯逻辑/解析/校验/转换/边界条件/错误路径（结构化错误 `code/message/requestId` 等）。
    - **冒烟测试（Smoke Test）**：覆盖端到端关键链路（真实服务/真实数据库/真实外部 API），至少包含“成功路径”，并在适用时覆盖“失败路径（权限/校验/上游不可用）”。
  - **最小数量建议（按影响面；用于指导，不以数字替代覆盖）**
    - **小改动（单函数/单文件）**：单元测试 ≥ 2（正常 + 关键边界）；冒烟测试 ≥ 1（关键链路）。
    - **新增/修改对外 API/契约**：单元测试 ≥ 6（含 ≥2 个错误路径）；冒烟测试 ≥ 2（写入+查询 / 成功+失败 各至少 1）。
    - **跨模块/涉及权限/审计/证据链/写操作治理**：单元测试 ≥ 10；冒烟测试 ≥ 3（覆盖关键门禁点与回归点）。
  - **验收日志必须记录**：两类测试的命令、关键输出与结论（pass/fail），以及所覆盖的关键链路/边界点摘要。
- 标记动作：
  - `docs/tasks.md`：将对应任务条目从 `- [ ]` 更新为 `- [x]`。
  - `docs/task-prompts/*.md`：同步更新对应 Prompt 的 `# Checklist`（例如 `[x]`）。
- 完成每个任务后，必须在 `reports/` 目录中生成该任务的验收日志。
  - **验收日志命名**：`reports/YYYY-MM-DD_T{N}_short-slug.md`（例如 `reports/2025-12-22_T6_streaming-core.md`）
  - **代码审查报告命名**：`reports/YYYY-MM-DD_T{N}_short-slug-review.md`（例如 `reports/2025-12-24_T13_export-markdown-review.md`）
    - 审查报告必须以 `-review.md` 结尾，以区别于验收日志

- **强制：零遗留项原则（Zero Technical Debt Policy）**
  - **禁止任何形式的遗留项**：任务完成时不得存在任何"待补充"、"后续优化"、"已知限制"、"TODO"等遗留项
  - **审查问题必须全部解决**：
    - 🔴 阻断性问题（Blocker）：必须 100% 修复，否则不得标记完成
    - 🟠 严重问题（Critical）：必须 100% 修复，否则不得标记完成
    - 🟡 一般问题（Major）：必须 100% 修复，否则不得标记完成
    - 🟢 优化建议（Minor）：必须 100% 修复或在验收日志中证明不适用
  - **不适用问题的处理**：
    - 如果审查报告中的问题确实不适用于当前任务范围，必须在验收日志中明确说明：
      - 为什么不适用（技术原因/范围原因/依赖原因）
      - 是否需要创建新任务跟踪
      - 如果需要，新任务的编号和标题
    - 不得以"后续优化"、"推迟到下个版本"等理由搪塞
  - **文档完整性要求**：
    - API 文档必须包含所有端点的完整说明（参数、返回值、所有可能的错误码）
    - 错误码必须在 `docs/contracts/api-and-events-draft.md` 中完整枚举
    - 配置项必须在 `.env.example` 中完整列出并在文档中说明用途、默认值、获取方式
    - 所有对外契约必须有对应的 schema 定义（前端 Zod / 后端 Pydantic）
  - **迁移可回滚性验证**（如适用）：
    - 如果任务涉及数据库 schema 变更，必须验证 `upgrade -> downgrade -> upgrade` 循环成功
    - 验收日志必须记录回滚验证的命令和结果
    - 如使用 Alembic，必须确保 `downgrade` 脚本与 `upgrade` 脚本配套完整
  - **性能基准验证**（如适用）：
    - 如果任务涉及性能敏感操作（如批量写入、复杂查询），必须提供性能基准数据
    - 验收日志必须记录关键操作的响应时间（P50/P95/P99）
    - 如果性能不达标，必须优化到满足要求或调整需求
  - **验收日志强制要求**：
    - 必须包含"零遗留项声明"章节，明确列出：
      - 所有审查问题的处理结果（已修复/不适用+原因）
      - 所有文档的完整性确认（API文档/错误码/配置项）
      - 所有测试的覆盖确认（单元测试/冒烟测试/回滚测试）
    - 如果存在任何未解决项，必须阻止任务标记完成


## 4) GangQing 工程约定（约定）

1. **文档权威来源**
   - 需求（PRD）：`docs/产品需求.md`
   - 任务（Implementation Plan）：`docs/tasks.md`
   - 设计（TDD）：`docs/技术设计文档-TDD.md`

2. **工程结构（建议对齐仓库规范）**
   - 本仓库工程结构：
     - `backend/`：FastAPI 后端（API、鉴权、审计、工具链等）
     - `web/`：前端（Vite + React + TypeScript）
     - `docs/`：文档体系（PRD/TDD/任务拆解/RTM/验收）
     - `reports/`：验收日志与审查报告

3. **默认验证命令（若任务未单独指定）**
   - 后端（`backend/`，Python/FastAPI）：
     - 优先运行任务内指定命令。
     - 若任务未指定：
       - **最低限度校验**：`python -m compileall backend`
       - **单元测试**：必须运行（例如 `pytest -q`，以仓库实际为准）
       - **冒烟测试**：必须运行（例如 `backend/scripts/*_smoke_test.py` 或任务约定的 E2E 冒烟脚本）
   - 前端（`web/`，Vite/React/TS）：
     - 优先运行任务内指定命令；否则运行 `npm run build`（在 `web/` 目录）。
   - 若对应目录未提供可运行脚本或依赖缺失，必须在验收日志中明确说明原因与补验收计划，**不得**直接标记完成。

4. **全局编码规范（强制）**
   - TypeScript Strict（**禁止 `any`**）
   - 契约与校验（单一事实源）：
     - 前端/TypeScript：对外输入输出使用 **Zod** 校验并从 schema 推导类型
     - 后端/Python：对外输入输出使用 **Pydantic** 模型作为单一事实源
   - 错误消息（message）必须用 **英文**（便于日志搜索）；注释可中文
   - API 使用 **REST**；如采用流式输出，优先使用 **Server-Sent Events (SSE)**，并确保事件/分片协议可契约化校验

5. **自动化验收原则（强制）**
   - 每个任务的 Verification 优先写成**可自动化断言**（单元/集成/契约测试），避免仅“手工目测”。
   - 契约相关（REST/SSE/Events/Streaming/Citation/Error）以本仓库 `docs/` 下的权威设计文档为准，并使用 schema 做断言（前端 Zod / 后端 Pydantic）。

6. **真实集成原则（强制）**
   - **所有代码必须使用真实服务进行集成和测试**
   - **所有测试必须针对真实服务运行**（如 RAGFlow、数据库、外部 API）
   - **禁止使用 mock**：不得使用 mock 对象、mock 服务、stub 等模拟真实服务的方式进行测试
   - **单元测试例外**：仅在单元测试中，为了隔离被测试单元，可以通过依赖注入传入测试专用的实现（如 fake fetch），但必须模拟真实行为和错误场景
   - 测试环境通过环境变量配置真实服务地址
   - **严格的失败策略**：当真实服务不可用或缺少配置时，测试必须失败并记录原因
     - **禁止 skip 策略**：不得使用 `test.skip()`、`describe.skip()`、条件跳过等任何形式的测试跳过
     - **配置缺失 => 测试失败**：按照本仓库 `docs/` 规范，缺少必需配置时测试必须抛出清晰错误并失败
     - **服务不可用 => 测试失败**：真实服务连接失败时测试必须失败，不得绕过或降级
     - **环境问题必须解决**：测试失败时必须修复环境配置或服务可用性，而非跳过测试
   - 集成测试必须验证完整的端到端流程

7. **配置化开发原则（强制）**
   - **所有配置必须外部化**：URL、端口、超时时间、重试次数、API 密钥等配置项必须通过环境变量或配置文件管理
   - **禁止硬编码配置值**：代码中不得出现硬编码的 URL（如 `http://localhost:9999`）、端口号、超时时间、魔法数字等配置值
   - **使用统一的配置加载机制**：所有模块必须通过统一的配置加载函数（如 `loadRagflowConfig()`）获取配置，确保配置来源一致
   - **配置必须有 Zod 校验**：所有配置项必须定义 Zod schema 并在加载时校验，确保类型安全和完整性
   - **配置缺失时的处理**：
     - 开发/测试阶段：当检测到配置文件（`.env.local`）缺少必需的配置项时，AI 必须主动询问用户并协助补充配置
     - 运行时：关键配置缺失时必须抛出清晰的英文错误消息，说明缺失的配置项名称和获取方式
     - 可选配置可以有合理的默认值，但必须在文档中明确说明
   - **测试中的配置**：
     - 单元测试可以使用测试专用的配置对象（通过参数传入），但不得硬编码配置值
     - 集成测试必须从环境变量加载真实配置，配置缺失时测试失败
     - 测试辅助函数（如 fake fetch）可以接受配置参数，但调用方必须从配置系统获取值
   - **配置文档化**：所有配置项必须在 `.env.example` 中列出，并在 README 或相关文档中说明用途、默认值和获取方式
