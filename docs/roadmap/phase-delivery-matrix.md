# Phase 交付矩阵（MUST/SHOULD/MAY）与依赖关系
本文件用于将 Phase 1-4（L1-L4）的交付内容按 MUST/SHOULD/MAY 分层，并明确依赖关系、验收证据与风险点，作为里程碑评审的检查清单。

## 1. Phase 1（L1）：全知查询员

### 1.1 MUST（必须交付）
- **只读默认（Read-Only Default）**
  - 所有能力默认只读；Action 意图不得触发写操作。
- **证据链（Evidence Required）**
  - 数值结论必须可追溯到数据源与时间范围；不可校验必须降级。
- **审计（Audit）**
  - `query`/`tool_call` 覆盖率 100%，按 `requestId` 可检索可复核。
- **RBAC 与隔离（tenantId/projectId）**
  - 从 L1 起强制启用；跨隔离访问拦截并审计。
- **错误模型与英文 message**
  - 对外错误模型包含 `code/message/details?/retryable/requestId`，且 `message` 英文。
- **对话流式协议（SSE + WebSocket）**
  - 两种协议都需要有契约与实现路径；验收必须覆盖两条端到端链路（SSE 与 WebSocket）。

### 1.2 SHOULD（推荐交付）
- **脱敏策略框架**：定义敏感字段分级与角色映射，保证后续实现不漂移。
- **契约测试门禁**：对 evidence/audit/error/streaming 事件 schema 做自动化断言。

### 1.3 MAY（可选增强）
- Golden Dataset 雏形与回归基线（先定义格式与覆盖主题）。

### 1.4 依赖关系
- 后端基础工程（配置/结构化日志/错误模型）
- 审计事件 schema 与存储口径（PG → ES）
- 前端 Zod 契约与证据链展示组件契约

### 1.5 主要风险
- 指标口径不一致导致信任崩塌（必须版本化并写入 evidence）。
- 越权/旁路泄露（必须工具层 + 响应层双重门禁与审计）。

## 2. Phase 2（L2）：维修副驾驶

### 2.1 MUST
- **多模态证据可追溯**：文件 hash、采集时间、处理模型版本进入 evidence 与 audit。
- **建议类输出的来源约束**：建议必须引用文档/案例证据，不确定项必须显式表达。
- **跨域权限隔离**：维修角色不得旁路访问财务域敏感数据。

### 2.2 SHOULD
- Top 故障覆盖范围与评估口径（与 Golden Dataset 对齐）。

### 2.3 MAY
- 弱网/离线增强（移动端离线包与同步口径）。

### 2.4 依赖
- RAG 文档处理契约与知识库元数据规范
- 多模态输入链路的上传/存证/审计字段规范

## 3. Phase 3（L3）：生产决策辅助

### 3.1 MUST
- **物理边界/变化率校验（Guardrails）**：越界必须触发降级，并写入 evidence 与 audit。
- **时间对齐口径**：涉及 DCS 时序与业务事件对齐的规则必须可复核。

### 3.2 SHOULD
- 沙箱回放/离线仿真作为验收前置环境（强制禁写）。

### 3.3 MAY
- 主动预警与推送扩展（WebSocket 告警事件协议）。

### 3.4 依赖
- 统一语义层（实体/事件）对齐口径
- 物理约束规则库（schema）与审计事件类型

## 4. Phase 4（L4）：受控闭环（包含 OT 写入）

### 4.1 MUST
- **写操作全链路门禁**：草案→审批/多签→受控执行→回滚点→审计。
- **Kill Switch**：熔断开关可用、可审计、可观测；熔断时强制降级为仅查询。
- **RBAC 最小权限 + 白名单范围**：写权限独立于读权限；按产线/设备白名单收敛。
- **OT 写入专用通道 + OT 二次确认**：禁止直连反控；全程留痕。

### 4.2 SHOULD
- 审批超时/撤回/驳回/版本化策略完善，支持追溯到草案版本。

### 4.3 MAY
- 更复杂闭环自动化（需试点证明后逐步开放）。

### 4.4 依赖
- 审批工作流契约与审计事件体系
- 执行网关契约（白名单工具、幂等、超时、阈值限制）
- 运维与跨网域安全架构（DMZ/专用通道/二次确认）

## 5. 验收证据映射（总览）
- 证据链样例包（可验证/不可验证降级/越界）
- 审计检索导出（按 requestId 聚合 query/tool_call/approval/write_operation）
- 越权与脱敏用例对照（按角色、按 tenant/project）
- 熔断演练记录（启停、影响面验证、告警触达）
- OT 二次确认与专用通道演练记录（L4）
