# 里程碑验收清单（L1-L4）
本清单用于对 GangQing（钢擎）各里程碑（L1-L4）进行可执行验收，重点覆盖证据链、审计、RBAC/脱敏、只读默认、Kill Switch、OT 写入门禁、以及 requestId 贯穿等强制要求。

## 0. 通用验收前置（所有里程碑通用）

### 0.1 契约与 Schema（强制）
- 前端对外契约：Zod（单一事实源）。
- 后端对外契约：Pydantic（单一事实源）。
- 对外输出（含 streaming/events/evidence）在输出前必须通过 schema 序列化/断言校验。

### 0.2 错误处理（强制）
- 对外错误模型字段至少包含：
  - `code`
  - `message`（英文）
  - `details?`
  - `retryable`
  - `requestId`
- 验收点：任意错误路径均能返回结构化错误，且 `message` 可检索（英文）。

### 0.3 可观测性与上下文贯穿（强制）
- `requestId` 贯穿 HTTP→编排→工具→审计→响应。
- `tenantId/projectId` 从 L1 起强制启用并贯穿日志/审计（默认过滤）。
- 结构化日志至少包含 `requestId`，并在可用时包含 `sessionId/taskId/stepId/toolName`。

### 0.4 只读默认（强制）
- 默认只读：除非满足“权限 + 审批/多签 + 白名单 + Kill Switch 关闭”，否则禁止任何写操作。
- 验收点：无权限/无审批/熔断开启时，Action 意图必须被拦截并可审计。

### 0.5 审计（强制）
- 审计事件类型必须覆盖：
  - `query`
  - `tool_call`
  - `approval`
  - `write_operation`
- 审计存储：先 PostgreSQL 后 Elasticsearch（ES）。
- 验收点：可按 `requestId` 聚合检索并导出，完成链路复核。

## 1. L1（Phase 1）验收：全知查询员（只读查询 + 证据链）

### 1.1 功能链路
- 能完成“跨系统只读查询”的端到端链路（以试点范围内系统为准）。

### 1.2 证据链（Evidence Required）
- 对“数值型结论”必须提供：
  - 数据源（系统/表/接口/文档定位信息）
  - 时间范围（start/end）
  - 工具调用摘要（toolName、关键参数摘要、耗时）
  - 口径版本（`lineage_version`，若涉及指标口径）
- 不可校验时必须降级：
  - 输出为“仅展示数据与来源”或提示缺失/不可验证
  - 禁止展示“看似有来源但不可映射”的引用

### 1.3 审计覆盖率
- `query`/`tool_call` 审计覆盖率 100%（以“事件计数对账”证明）。
- 任意一次对话，可用 `requestId` 追溯到相关审计事件与证据链。

### 1.4 RBAC 与脱敏（最小闭环）
- 不同角色对同一请求的行为必须一致、可解释：
  - 放行 / 拒绝 / 脱敏
- 拒绝需返回结构化错误（英文 message）并写审计。

### 1.5 对话流式协议
- SSE + WebSocket 都必须具备可用路径；验收必须覆盖两条端到端链路（SSE 与 WebSocket）：
  - 事件分段可渲染
  - 流中错误可解析为结构化错误模型
  - 客户端取消可向下传播（至少验证“服务端可感知取消并停止后续输出”）

## 2. L2（Phase 2）验收：维修副驾驶（多模态诊断辅助）

### 2.1 多模态输入证据
- 上传文件必须可追溯：
  - 文件 hash
  - 采集/上传时间
  - 处理链路与模型版本
- 多模态输出必须能关联到上述证据（不可伪造）。

### 2.2 建议类输出约束
- 每条关键建议必须包含：
  - 引用来源（文档/案例/规程条款）
  - 不确定项（缺少什么数据、依赖什么假设）

### 2.3 跨域越权测试
- 维修角色访问财务域等敏感信息：必须拒绝/脱敏，并写入审计。

## 3. L3（Phase 3）验收：生产决策辅助（约束清单 + 物理边界校验）

### 3.1 物理约束与幻觉防护
- 对关键参数/变化率/边界越界：
  - 必须触发 guardrail
  - 必须降级输出并写入 evidence 与 audit

### 3.2 时间对齐口径可复核
- 涉及 DCS 时序与业务事件对齐：
  - evidence 中能看到对齐规则（事件锚点/窗口/采样频率）
  - 抽查可复核

### 3.3 沙箱/演练前置（推荐）
- 建议与策略输出优先在沙箱/回放环境验证，不触发写操作。

## 4. L4（Phase 4）验收：受控闭环（包含 OT 写入）

### 4.1 写操作全链路门禁
- 写操作必须拆分为：
  - 草案（draft）
  - 审批/多签（approval）
  - 受控执行（execution）
  - 回滚（rollback）
- 验收点：任意写操作都能提供上述阶段的状态与审计证据。

### 4.2 Kill Switch（强制）
- 开启熔断后：
  - 所有写相关能力强制降级为仅查询
  - 拦截结果可审计、可告警
- 关闭熔断后：恢复受控写能力（仍需审批/白名单等门禁）。

### 4.3 OT 写入专用通道与二次确认（强制）
- 必须证明：
  - 禁止任何直连反控路径
  - OT 写入经过“专用通道 + OT 侧二次确认”
  - OT 二次确认记录可审计可复核

### 4.4 回滚能力
- 执行前必须记录回滚点。
- 回滚动作本身必须：
  - 权限检查
  - 审计记录
  - 结果可验证

## 5. 退出准则（Release Gate）
- L1-L3：只要涉及“数值输出”，必须满足 Evidence Required 与审计可复核。
- L4：只要涉及“写/下发/控制”，必须满足 Read-Only Default + 审批/多签 + Kill Switch + 回滚 + OT 写入隔离的全部门禁。
