# 验收证据采集清单（Evidence Pack）
本清单定义里程碑验收时“需要采集哪些证据、如何复核”的最小集合，确保证据链、审计、权限、只读默认、熔断、OT 写入门禁满足可追溯与可复核要求。

## 1. 证据包总体结构（建议）
- `evidence-pack/`
  - `README.md`（证据包索引：包含版本、时间、环境、试点范围）
  - `rtm-snapshot.md`（本次验收对应的 RTM 快照/链接）
  - `samples/`
    - `l1-query-evidence.json`（一条 L1 查询证据链样例）
    - `l1-query-audit.json`（同一 requestId 对应的审计导出）
    - `l3-guardrail-evidence.json`（越界/不可校验降级样例）
    - `l4-killswitch-audit.json`（熔断启停审计）
    - `l4-ot-write-audit.json`（OT 二次确认与写入审计）
  - `screenshots/`（UI 截图/录屏：证据链展开、拒绝提示、熔断提示）
  - `exports/`（数据库/ES 导出文件，脱敏后）
  - `reports/`（测试报告、对账报告、抽样复核报告）

> 注：上述是“证据包落地形态建议”，不等于要求必须按该目录实现；关键在于证据齐全可复核。

## 2. 通用元信息（每次验收必须提供）
- 环境信息：`GANGQING_ENV`（dev/staging/prod）、版本号、部署时间。
- 范围信息：试点人群、试点系统清单、试点产线/设备白名单。
- 隔离信息：`tenantId/projectId` 生效策略说明（默认过滤、跨隔离拦截）。
- 流式协议：本次验收覆盖 SSE 还是 WebSocket（至少一种端到端）。

## 3. 证据链（Evidence）取证项

### 3.1 数值结论可追溯证明（强制）
每条数值结论必须可映射到：
- 数据源（系统/接口/表/文档定位信息）
- 时间范围（start/end）
- 工具调用摘要（toolName、关键参数摘要、耗时）
- 口径版本（`lineage_version`，如涉及指标口径）
- 数据质量（`data_quality_score` 或等价口径）

验收材料：
- 至少 3 条样例（覆盖不同系统来源）：
  - 可验证数值
  - 数据缺失/不可验证 → 降级
  - 越界/物理约束触发 → 降级

### 3.2 禁止伪造证据（强制）
- evidence id 必须来自工具/系统返回或可审计生成，不允许前端/LLM 随机拼接。
- 证据链与审计事件之间需能通过 `requestId`/`tool_call_id` 等字段关联。

验收材料：
- `requestId` → evidenceChain 的关联导出
- 随机抽查 2 条 evidence 能定位回原始来源（或来源定位信息）

## 4. 审计（Audit）取证项

### 4.1 审计覆盖率对账（强制）
- 覆盖事件类型：`query`、`tool_call`、`approval`、`write_operation`。
- 覆盖率口径：
  - 以“请求数/工具调用数/审批动作数/写操作数”为分母
  - 以“审计事件入库数”为分子

验收材料：
- PostgreSQL 中的对账 SQL 结果导出（脱敏）
- 同一时间窗下 ES 的抽样检索结果（证明可检索性，不强求强一致）

### 4.2 requestId 贯穿证明（强制）
- 任意抽取 3 条 requestId，能检索到：
  - query 事件
  - tool_call 事件
  - evidenceChain（若有数值输出）
  - approval/write_operation（若涉及写）

验收材料：
- requestId 聚合导出（PG/ES 均可）

## 5. RBAC、脱敏与隔离（tenantId/projectId）取证项

### 5.1 权限矩阵用例对照
- 同一请求在不同角色下的行为必须一致可解释：放行/拒绝/脱敏。
- 拒绝必须返回结构化错误（英文 message）并写审计。

验收材料：
- 用例表（角色 × 能力 × 预期结果 × 实际结果 × 审计 event_id）

### 5.2 多租户隔离取证（L1 起强制）
- 默认按 `tenantId/projectId` 过滤。
- 跨 tenant/project 访问：返回 `AUTH_ERROR` 或等价错误码，并记录审计。

验收材料：
- 至少 2 条跨隔离访问拦截样例（含审计导出）

## 6. 只读默认、审批/多签、回滚、熔断（Kill Switch）取证项（L4 强制）

### 6.1 只读默认门禁
- 无审批/无权限/熔断开启时，Action 意图必须被拦截，并给出可审计理由。

验收材料：
- 拦截样例（响应 + 审计）

### 6.2 审批/多签链路
- 审批动作必须全审计：submit/approve/reject/withdraw/timeout。
- 审批与草案版本必须可追溯。

验收材料：
- 同一 draft_id 的版本与审批链路导出

### 6.3 回滚
- 执行前记录回滚点；回滚动作本身也需权限+审计。

验收材料：
- rollback 事件审计导出

### 6.4 Kill Switch
- 开启熔断后，所有写相关能力强制降级为仅查询。
- 熔断启停操作必须审计，并能触发告警（如有告警体系）。

验收材料：
- 熔断启停审计导出
- 熔断期间写操作拦截证明

## 7. OT 写入专用通道与二次确认取证项（L4 强制）
- 必须证明：
  - 禁止直连反控
  - 写入经过专用通道
  - OT 侧二次确认记录可复核

验收材料：
- OT 二次确认记录（截图/日志/系统记录导出，脱敏）
- 写入审计事件（write_operation）导出

## 8. 流式协议（SSE/WebSocket）取证项
- 必须覆盖 SSE 与 WebSocket 两条端到端验收：
  - 事件可分段渲染
  - 流中错误可解析为结构化错误
  - 客户端取消可向下传播（最小验证）

验收材料：
- 抓包/录屏（SSE 与 WS 各一份）
- 事件样例（SSE 与 WS 各一份，包含 error 事件）
