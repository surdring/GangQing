`docs/tasks.md` 的生成规范与最佳实践（GangQing 项目专用）
 
 本文用于规范本仓库 `docs/tasks.md` 的编写方式，确保任务拆分**可追溯、可执行、可验收**，并与 GangQing 的工程约束保持一致。
 
 ## 1. 适用范围与目标
 
 - **适用范围**：本仓库所有开发任务（后端 FastAPI、前端 React、Agent 编排、工具链、数据层、文档与运维）。
 - **核心目标**：
   - 任务可被 IDE 识别为可勾选/可追踪的待办清单。
   - 每个任务都能追溯到 PRD/设计/契约等权威来源。
   - 每个任务都必须包含可自动化验证（至少单元测试 + 冒烟测试），并在完成后落盘验收日志。
 
 ## 2. 权威参考与 Traceability 规则（强制）
 
 `docs/tasks.md` 中每个任务必须能追溯到至少一个权威来源：
 
 - PRD：`docs/requirements.md`
 - 技术设计（最佳实践版）：`docs/design.md`

 
 **强制规则**：
 
 - 任务末尾必须包含 `_Requirements: ..._`（编号或引用路径均可）。
 - 若任务会改变对外行为（API/SSE 事件/Evidence/错误码），必须在 `_Requirements_` 中引用对应契约/文档路径。
 
 ## 3. 标准结构模板（强制）
 
 `docs/tasks.md` 必须使用如下结构（示例为模板，不代表具体任务内容）：
 
 ```markdown
 # Implementation Plan
 
 - [ ] 1. 任务标题（简明扼要）
 
   - 变更点 1（写清楚修改的模块/目录，如 backend/ 或 web/）
   - 变更点 2（写清楚对外契约变化或新增的 schema）
   - 验证：写明将要运行的单元测试与冒烟测试命令（不得缺省）
   - _Requirements: docs/产品需求.md#F1.1, docs/技术设计文档-最佳实践版.md#4, docs/contracts/api-and-events-draft.md#SSE_
 
 - [ ] 2. 下一个任务标题
 
   - ...
   - _Requirements: ..._
 ```
 
 ### 3.1 必填要素
 
 - **任务编号**：使用数字 `1.`, `2.` 作为一级任务编号。
 - **检查框**：必须用 `- [ ]` / `- [x]`.
 - **验证步骤**：必须包含“单元测试 + 冒烟测试”两类验证，并写明命令。
 - **需求映射**：必须包含 `_Requirements: ..._`.
 
 ## 4. 任务拆分原则（适配 GangQing）
 
 ### 4.1 原子性（强制）
 
 - 每个任务应是独立可验证单元。
 - 单个任务若需要修改超过 3-5 个文件，优先拆分（除非是“统一重构/契约升级”类任务）。
 
 ### 4.2 阶段化顺序（推荐）
 
 1. **契约与 Schema**（Pydantic/Zod、OpenAPI、SSE 事件、Evidence/错误模型）
 2. **核心后端逻辑**（FastAPI 路由、Service、Agent 编排、工具层）
 3. **数据层与迁移**（Postgres 表/索引/造数脚本）
 4. **前端联调**（SSE 客户端、证据面板渲染、状态机）
 5. **测试与验收**（单元 + 冒烟 + 验收日志）
 
 ### 4.3 项目关键约束必须显式写进任务（强制）
 
 如果任务涉及下列任一主题，任务描述中必须明确对应的门禁与产物：
 
 - **SSE 流式协议**：事件类型、字段、错误事件的可解析性。
 - **Evidence 证据链**：数值回答必须可追溯（数据源、时间范围、口径版本）。
 - **RBAC/脱敏**：哪些角色能看哪些字段/数据域。
 - **审计**：至少记录 query、tool_call、result/error、requestId。
 - **只读默认**：任何写操作必须进入草案/审批（L4 预留）。
 - **配置外部化**：禁止硬编码 URL/端口/超时/密钥；变更需同步 `.env.example`.
 
 ## 5. 验证与完成定义（强制）
 
 ### 5.1 “完成”的判定条件
 
 一个任务只有在以下条件都满足时才允许勾选为完成：
 
 - 单元测试实际运行并通过。
 - 冒烟测试实际运行并通过（必须依赖真实服务，如 Postgres 与 llama.cpp）。
 - 对外契约如有变更：相关文档与 schema 已同步。
 - 无遗留项：不得存在“TODO/后续补充/已知限制”等。
 

 ## 6. GangQing 项目推荐的任务类型模板
 
 ### 6.1 L1 最小闭环（Postgres 造数 + llama.cpp + SSE）
 
 - **契约任务**：定义 SSE 事件与错误模型、Evidence schema。
 - **数据任务**：创建最小数据模型与造数，保证可复现。
 - **工具任务**：实现 Postgres 只读工具（参数校验、脱敏、审计）。
 - **编排任务**：意图识别 → 工具调用 → 证据链组装 → 流式输出。
 - **联调任务**：前端从 mock 切换到真实 SSE。
 - **测试任务**：单元 + 冒烟（真实 Postgres 与 llama.cpp）。
 
 ### 6.2 L4 受控写操作（预留）
 
 - **策略任务**：Read-Only Default、HITL、多签、回滚与熔断。
 - **审计任务**：写操作全链路审计与不可抵赖。
 
 ## 7. 文档维护注意事项
 
 - 本文件只描述“如何写 tasks.md”，不应重复粘贴通用框架介绍。
 - 内容必须避免重复段落；如需扩展，优先链接到本仓库 `docs/` 的权威文档。
 
 ## 8. 总结
 
 一份合格的 `docs/tasks.md` 必须同时做到：
 
 - 可追溯（Requirements 清晰）
 - 可执行（步骤具体，边界明确）
 - 可验收（单元 + 冒烟必跑，验收日志落盘）
 - 可审计（requestId、证据链、审计覆盖）