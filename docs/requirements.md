# GangQing 需求文档

## 项目概述

**项目名称**：GangQing（钢擎）—— 钢铁工业全域认知决策系统

**项目背景**：钢铁厂现有信息化系统极其复杂（ERP、MES、DCS、LIMS、EAM等林立），数据割裂，操作门槛高。管理层难以实时掌握经营全貌，一线员工过度依赖老师傅经验。

**项目目标**：
- 提效：将跨系统查询时间从小时级降低到秒级
- 传承：固化专家经验，降低对人的依赖
- 安全：在不接触底层控制权的前提下，提供辅助决策

**核心原则**：
- 安全第一：数据不出厂、RBAC 权限、审计留痕
- 证据驱动：所有回答必须可追溯到数据源
- 人机协同：AI 是副驾驶，人是最终决策者
- 私有化部署：模型与数据均在内网
- 渐进式演进：从只读查询到受控写操作

## 用户画像

### P1 厂长/高管
- **关注点**：利润、产量、安全
- **特征**：不看复杂报表，只问结果
- **使用场景**：经营决策、异常预警、成本分析

### P2 生产调度员
- **关注点**：排产进度、物流瓶颈、异常处理
- **特征**：需要实时数据、快速响应
- **使用场景**：排产优化、异常处置、交接班

### P3 设备维修工
- **关注点**：故障原因、维修方案、备件库存
- **特征**：需现场移动作业、多模态输入
- **使用场景**：故障诊断、维修指引、备件查询

### P4 财务人员
- **关注点**：实时成本、原料价格波动对利润的影响
- **特征**：需要精确数据、口径一致
- **使用场景**：成本分析、预算管理、财务报表

## 功能需求

### 模块一：用户认证与权限管理（基础设施）

#### R1.1 用户认证
**用户故事**：作为系统用户，我需要通过安全的方式登录系统，以便访问我有权限的功能。

**验收标准**：
- WHEN 用户提供有效的用户名和密码，THEN 系统应生成 JWT token 并返回
- WHEN 用户提供无效的凭证，THEN 系统应返回 AUTH_ERROR 错误
- WHEN token 过期，THEN 系统应要求用户重新登录
- IF 系统检测到异常登录行为，THEN 应记录审计日志并可选触发告警

**优先级**：P0（必须）
**依赖**：无
**实施阶段**：L1

#### R1.2 基于角色的访问控制（RBAC）
**用户故事**：作为系统管理员，我需要为不同角色配置不同的权限，以便控制用户可以访问的数据和功能。

**验收标准**：
- WHEN 用户尝试访问资源，THEN 系统应检查用户角色是否有权限
- WHEN 维修工尝试查询财务报表，THEN 系统应返回 FORBIDDEN 错误
- WHEN 销售人员尝试查看核心工艺参数，THEN 系统应返回 FORBIDDEN 错误
- IF 用户角色变更，THEN 新权限应立即生效

**优先级**：P0（必须）
**依赖**：R1.1
**实施阶段**：L1

#### R1.3 数据域隔离
**用户故事**：作为系统架构师，我需要确保用户只能访问其权限范围内的数据域，以防止数据泄露。

**验收标准**：
- WHEN 用户查询数据，THEN 系统应自动应用数据域过滤
- WHEN 用户尝试访问其他产线的数据，THEN 系统应返回空结果或 FORBIDDEN 错误
- IF 查询涉及敏感字段，THEN 系统应根据角色进行脱敏处理

**优先级**：P0（必须）
**依赖**：R1.2
**实施阶段**：L1

### 模块二：全知经营助手（Management Pilot）

#### R2.1 自然语言查询
**用户故事**：作为厂长，我希望用自然语言提问，系统能理解我的意图并返回准确答案，而不需要学习复杂的查询语法。

**验收标准**：
- WHEN 用户输入"昨天二号高炉的吨钢成本是多少"，THEN 系统应返回准确的数值和单位
- WHEN 用户输入模糊查询，THEN 系统应识别意图并调用相应工具
- IF 查询意图不明确，THEN 系统应请求用户澄清
- WHEN 查询完成，THEN 响应时间应 < 10秒（P95）

**优先级**：P0（必须）
**依赖**：R1.2
**实施阶段**：L1

#### R2.2 证据链生成（强制）
**用户故事**：作为厂长，我需要知道 AI 回答的依据是什么，以便验证数据的可信度。

**验收标准**：
- WHEN 系统返回数值类回答，THEN 必须包含数据源、时间范围、提取时间
- WHEN 系统返回计算结果，THEN 必须包含计算公式版本和口径版本
- WHEN 用户点击证据链，THEN 应展示完整的数据来源和计算过程
- IF 数据缺失或不完整，THEN 系统应在证据链中标注不确定项

**优先级**：P0（必须）
**依赖**：R2.1
**实施阶段**：L1

#### R2.3 成本分析与对比
**用户故事**：作为厂长，我希望快速了解成本构成和变化趋势，以便做出经营决策。

**验收标准**：
- WHEN 用户询问"昨天吨钢成本对比上月主要贵在哪里"，THEN 系统应返回成本构成对比和主要差异项
- WHEN 系统生成成本分析，THEN 应包含瀑布图或对比图表
- WHEN 成本异常波动，THEN 系统应高亮显示异常项并给出可能原因
- IF 涉及多个成本项，THEN 应按影响程度排序

**优先级**：P0（必须）
**依赖**：R2.2
**实施阶段**：L1

#### R2.4 异常主动推送
**用户故事**：作为调度员，我希望系统能主动发现异常并推送告警，而不是等我去查询。

**验收标准**：
- WHEN 原料库存低于安全阈值，THEN 系统应主动推送告警
- WHEN 设备出现异常报警，THEN 系统应推送到相关人员
- WHEN 成本超标，THEN 系统应推送给厂长和财务
- IF 告警未及时处理，THEN 系统应升级告警级别

**优先级**：P1（重要）
**依赖**：R2.1
**实施阶段**：L2

#### R2.5 智能交接班
**用户故事**：作为调度员，我希望系统能自动汇总本班次的关键信息，以便快速完成交接班。

**验收标准**：
- WHEN 班次结束，THEN 系统应自动生成交接班数字日报
- WHEN 日报生成，THEN 应包含异常事件、未闭环报警、参数调整、遗留待办
- WHEN 用户询问"上一班谁动过3号风机的参数"，THEN 系统应返回操作人、时间、原因
- IF 有临时参数调整，THEN 应在日报中高亮显示

**优先级**：P1（重要）
**依赖**：R2.1, R11.1（审计日志）
**实施阶段**：L2

### 模块三：设备诊疗专家（Maintenance Expert）

#### R3.1 多模态故障诊断
**用户故事**：作为维修工，我希望能通过拍照或录音的方式让系统帮我诊断故障，而不需要手工输入复杂的描述。

**验收标准**：
- WHEN 用户上传轴承照片，THEN 系统应识别故障类型并给出诊断结论
- WHEN 用户上传设备异响录音，THEN 系统应分析频谱并给出可能原因
- WHEN 诊断完成，THEN 应给出置信度和备选诊断
- IF 置信度低于阈值，THEN 系统应建议人工复核

**优先级**：P1（重要）
**依赖**：R1.2
**实施阶段**：L2

#### R3.2 维修方案推荐
**用户故事**：作为维修工，我希望系统能根据故障类型推荐维修方案和所需备件。

**验收标准**：
- WHEN 系统诊断出故障，THEN 应推荐维修方案和步骤
- WHEN 推荐方案，THEN 应列出所需备件型号和库存情况
- WHEN 有多个方案，THEN 应按优先级排序并说明理由
- IF 备件库存不足，THEN 应提示并建议采购

**优先级**：P1（重要）
**依赖**：R3.1
**实施阶段**：L2

#### R3.3 设备历史查询
**用户故事**：作为维修工，我希望快速查询设备的维修历史，以便了解设备状态和故障规律。

**验收标准**：
- WHEN 用户询问"这台轧机上次大修是什么时候"，THEN 系统应返回大修时间和更换部件
- WHEN 查询设备历史，THEN 应包含维修记录、故障记录、参数变更记录
- WHEN 发现故障规律，THEN 系统应主动提示（如"该设备每3个月出现类似故障"）
- IF 设备即将到达维护周期，THEN 系统应提前提醒

**优先级**：P1（重要）
**依赖**：R2.1
**实施阶段**：L2

### 模块四：生产工艺智库（Process Knowledge Base）

#### R4.1 工艺参数优化建议
**用户故事**：作为工艺员，我希望系统能根据原料变化推荐工艺参数调整方案，以保证产品质量。

**验收标准**：
- WHEN 用户询问"矿石品位变了，炉温该怎么调"，THEN 系统应检索历史相似批次并给出建议
- WHEN 给出建议，THEN 应包含参数范围、调整理由、历史案例引用
- WHEN 建议涉及多个参数，THEN 应说明参数间的关联关系
- IF 缺少历史数据，THEN 系统应提示不确定性并建议人工决策

**优先级**：P1（重要）
**依赖**：R2.1
**实施阶段**：L3

#### R4.2 规程合规检查
**用户故事**：作为安全员，我希望系统能实时监听操作指令并拦截违反工艺红线的操作，以防止安全事故。

**验收标准**：
- WHEN 调度员下达违反工艺红线的指令，THEN 系统应立即拦截并提示风险
- WHEN 拦截操作，THEN 应引用具体的规程条款和风险说明
- WHEN 操作接近红线但未违反，THEN 系统应给出警告提示
- IF 紧急情况需要越权操作，THEN 应进入审批流程

**优先级**：P0（必须）
**依赖**：R2.1
**实施阶段**：L3

#### R4.3 工艺知识检索
**用户故事**：作为新员工，我希望能快速查询工艺规范和操作手册，以便学习和参考。

**验收标准**：
- WHEN 用户询问工艺问题，THEN 系统应检索知识库并返回相关内容
- WHEN 返回结果，THEN 应包含规范条款、操作步骤、注意事项
- WHEN 有多个相关结果，THEN 应按相关性排序
- IF 知识库中没有答案，THEN 系统应明确告知并建议咨询专家

**优先级**：P2（可选）
**依赖**：R2.1
**实施阶段**：L2

### 模块五：受控操作与变更治理（Controlled Actions）

#### R5.1 只读默认（Read-Only Default）
**用户故事**：作为系统架构师，我需要确保系统默认只提供建议而不执行写操作，以防止误操作。

**验收标准**：
- WHEN 用户请求涉及写操作，THEN 系统应默认拒绝并提示需要授权
- WHEN 系统识别出写操作意图，THEN 应明确告知用户这是写操作并需要审批
- IF 用户没有写操作权限，THEN 系统应返回 FORBIDDEN 错误
- WHEN 系统不确定是否为写操作，THEN 应按只读处理

**优先级**：P0（必须）
**依赖**：R1.2
**实施阶段**：L1

#### R5.2 写操作草案生成
**用户故事**：作为调度员，我希望系统能生成排产草案供我审核，而不是直接执行。

**验收标准**：
- WHEN 用户请求"生成今晚电炉的峰谷电价优化排产草案"，THEN 系统应生成可编辑的草案
- WHEN 草案生成，THEN 应列出约束条件、目标函数、预期效果
- WHEN 草案展示，THEN 应包含甘特图或时序对比图
- IF 草案违反约束，THEN 系统应标注冲突并给出调整建议

**优先级**：P1（重要）
**依赖**：R5.1
**实施阶段**：L4

#### R5.3 审批与多签
**用户故事**：作为调度长，我需要审批下属提交的排产变更，确保变更合理且符合规范。

**验收标准**：
- WHEN 用户提交草案，THEN 系统应根据变更类型路由到相应审批人
- WHEN 涉及工艺红线，THEN 必须工艺员确认
- WHEN 涉及安全连锁，THEN 必须安全员确认
- IF 审批人拒绝，THEN 系统应记录拒绝原因并通知提交人

**优先级**：P1（重要）
**依赖**：R5.2
**实施阶段**：L4

#### R5.4 受控执行与回滚
**用户故事**：作为系统管理员，我需要确保写操作可以安全执行并在出现问题时快速回滚。

**验收标准**：
- WHEN 审批通过，THEN 系统应通过安全网关执行写操作
- WHEN 执行前，THEN 系统应创建回滚点
- WHEN 执行过程中出现异常，THEN 系统应自动回滚或进入熔断状态
- IF 用户请求回滚，THEN 系统应一键回滚到上一个确认版本

**优先级**：P1（重要）
**依赖**：R5.3
**实施阶段**：L4

#### R5.5 模拟仿真与培训
**用户故事**：作为培训师，我希望能在沙箱环境中让新员工练习操作，而不影响真实生产。

**验收标准**：
- WHEN 用户进入沙箱模式，THEN 界面应显示明显的沙箱标识
- WHEN 用户在沙箱中操作，THEN 系统应模拟执行并给出推演结果
- WHEN 操作违反规范，THEN 系统应给出风险提示和规程引用
- IF 操作导致严重后果，THEN 系统应展示后果并记录为培训案例

**优先级**：P2（可选）
**依赖**：R5.1
**实施阶段**：L4

### 模块六：流式交互与实时反馈

#### R6.1 SSE 流式输出
**用户故事**：作为用户，我希望在系统处理复杂查询时能看到实时进度，而不是长时间等待。

**验收标准**：
- WHEN 系统处理查询，THEN 应通过 SSE 流式输出进度事件
- WHEN 输出进度，THEN 应包含当前阶段和预计耗时
- WHEN 调用工具，THEN 应输出 tool.call 和 tool.result 事件
- IF 处理时间超过 5 秒，THEN 必须输出至少一次进度更新

**优先级**：P0（必须）
**依赖**：R2.1
**实施阶段**：L1

#### R6.2 证据链增量更新
**用户故事**：作为用户，我希望在系统生成回答的同时能看到证据链的构建过程。

**验收标准**：
- WHEN 系统调用工具获取数据，THEN 应实时输出 evidence.update 事件
- WHEN 证据链更新，THEN 前端应实时渲染到 Context Panel
- WHEN 回答完成，THEN 证据链应完整且可追溯
- IF 证据链缺失，THEN 系统应输出 warning 事件

**优先级**：P0（必须）
**依赖**：R6.1, R2.2
**实施阶段**：L1

#### R6.3 错误流式处理
**用户故事**：作为用户，我希望在系统出错时能立即看到错误信息，而不是等到最后才知道失败。

**验收标准**：
- WHEN 系统遇到错误，THEN 应立即输出 error 事件
- WHEN 输出错误，THEN 应包含 code、message、requestId、retryable
- WHEN 错误可恢复，THEN 系统应尝试降级或重试
- IF 错误不可恢复，THEN 系统应输出 final 事件并终止流

**优先级**：P0（必须）
**依赖**：R6.1
**实施阶段**：L1

### 模块七：数据层与造数

#### R7.1 Postgres 数据库设计
**用户故事**：作为系统架构师，我需要设计合理的数据模型来支持查询和分析功能。

**验收标准**：
- WHEN 数据库初始化，THEN 应创建所有必需的表和索引
- WHEN 表设计，THEN 应包含设备维表、物料维表、产量事实表、能耗事实表、成本事实表、报警事件表、维修工单表、指标口径仓库、审计日志表
- WHEN 查询执行，THEN 应有合理的索引支持
- IF 数据量大，THEN 应考虑分区策略

**优先级**：P0（必须）
**依赖**：无
**实施阶段**：L1

#### R7.2 造数脚本
**用户故事**：作为开发者，我需要生成模拟数据来支持开发和测试。

**验收标准**：
- WHEN 运行造数脚本，THEN 应生成可复现的模拟数据
- WHEN 数据生成，THEN 应覆盖核心场景（成本、产量、能耗、故障、维修）
- WHEN 数据生成，THEN 应包含异常和边界情况
- IF 使用相同种子，THEN 应生成相同的数据集

**优先级**：P0（必须）
**依赖**：R7.1
**实施阶段**：L1

#### R7.3 指标口径仓库
**用户故事**：作为数据分析师，我需要确保所有人使用相同的指标口径，避免"同名不同口径"的问题。

**验收标准**：
- WHEN 定义指标，THEN 应记录指标名、版本、计算公式、数据源、责任人
- WHEN 指标变更，THEN 应创建新版本并保留历史版本
- WHEN 系统计算指标，THEN 必须引用指标口径版本
- IF 指标口径不一致，THEN 系统应拒绝计算并提示

**优先级**：P0（必须）
**依赖**：R7.1
**实施阶段**：L1

### 模块八：工具与适配层

#### R8.1 Postgres 查询工具
**用户故事**：作为系统，我需要一个安全的 Postgres 查询工具来支持数据查询。

**验收标准**：
- WHEN 工具调用，THEN 应只允许 SELECT 查询
- WHEN 查询执行，THEN 应应用 RBAC 和数据域过滤
- WHEN 查询完成，THEN 应返回结构化结果和证据对象
- IF 查询超时，THEN 应返回 UPSTREAM_TIMEOUT 错误

**优先级**：P0（必须）
**依赖**：R7.1, R1.2
**实施阶段**：L1

#### R8.2 工具参数校验
**用户故事**：作为系统架构师，我需要确保所有工具调用都经过严格的参数校验。

**验收标准**：
- WHEN 工具被调用，THEN 应使用 Pydantic 模型校验参数
- WHEN 参数无效，THEN 应返回 VALIDATION_ERROR 错误
- WHEN 参数包含敏感信息，THEN 应在审计日志中脱敏
- IF 参数缺失，THEN 应返回清晰的错误消息

**优先级**：P0（必须）
**依赖**：R8.1
**实施阶段**：L1

#### R8.3 工具超时与重试
**用户故事**：作为系统架构师，我需要确保工具调用有合理的超时和重试策略。

**验收标准**：
- WHEN 工具调用，THEN 应设置合理的超时时间
- WHEN 调用超时，THEN 应返回 UPSTREAM_TIMEOUT 错误
- WHEN 调用失败且可重试，THEN 应自动重试（最多 3 次）
- IF 重试仍失败，THEN 应返回最后一次错误

**优先级**：P1（重要）
**依赖**：R8.1
**实施阶段**：L1

### 模块九：模型推理层

#### R9.1 llama.cpp 接入
**用户故事**：作为系统架构师，我需要接入本地部署的 llama.cpp 模型来支持自然语言理解。

**验收标准**：
- WHEN 系统启动，THEN 应成功连接到 llama.cpp 服务
- WHEN 模型推理，THEN 应设置合理的超时时间
- WHEN 推理完成，THEN 应返回结构化输出
- IF 模型不可用，THEN 系统应返回 UPSTREAM_UNAVAILABLE 错误

**优先级**：P0（必须）
**依赖**：无
**实施阶段**：L1

#### R9.2 并发控制
**用户故事**：作为系统架构师，我需要限制模型推理的并发数，避免系统过载。

**验收标准**：
- WHEN 并发请求超过限制，THEN 应将请求放入队列
- WHEN 队列已满，THEN 应返回 SERVICE_UNAVAILABLE 错误
- WHEN 请求在队列中等待，THEN 应定期输出进度事件
- IF 等待时间过长，THEN 应允许用户取消请求

**优先级**：P1（重要）
**依赖**：R9.1
**实施阶段**：L2

#### R9.3 输出结构化校验
**用户故事**：作为系统架构师，我需要确保模型输出符合预期的结构化格式。

**验收标准**：
- WHEN 模型输出，THEN 应使用 Pydantic 模型校验
- WHEN 输出无效，THEN 应重试（最多 3 次）
- WHEN 重试仍失败，THEN 应返回 CONTRACT_VIOLATION 错误
- IF 输出部分有效，THEN 应尝试降级处理

**优先级**：P1（重要）
**依赖**：R9.1
**实施阶段**：L1

### 模块十：安全设计

#### R10.1 提示词注入防护
**用户故事**：作为安全工程师，我需要防止用户通过提示词注入攻击系统。

**验收标准**：
- WHEN 用户输入包含注入特征，THEN 系统应识别并拒绝
- WHEN 系统指令和用户输入混合，THEN 应逻辑隔离
- WHEN 检测到注入尝试，THEN 应记录审计日志
- IF 注入成功绕过，THEN 应触发告警

**优先级**：P0（必须）
**依赖**：R2.1
**实施阶段**：L1

#### R10.2 敏感信息脱敏
**用户故事**：作为安全工程师，我需要确保敏感信息不会泄露到日志或输出中。

**验收标准**：
- WHEN 输出包含敏感字段，THEN 应根据角色脱敏
- WHEN 记录审计日志，THEN 应脱敏参数中的敏感信息
- WHEN 前端展示证据链，THEN 应默认脱敏
- IF 用户有权限，THEN 可以展开查看原始数据

**优先级**：P0（必须）
**依赖**：R1.2
**实施阶段**：L1

#### R10.3 输出安全校验
**用户故事**：作为安全工程师，我需要确保系统输出不包含系统提示词或敏感信息。

**验收标准**：
- WHEN 系统输出，THEN 应检查是否包含系统提示词特征
- WHEN 检测到敏感信息，THEN 应过滤或脱敏
- WHEN 输出异常长，THEN 应截断并记录告警
- IF 输出包含恶意内容，THEN 应拒绝输出并记录

**优先级**：P0（必须）
**依赖**：R2.1
**实施阶段**：L1

### 模块十一：审计与日志

#### R11.1 审计日志记录
**用户故事**：作为合规官，我需要记录所有用户操作和系统行为，以便审计和追溯。

**验收标准**：
- WHEN 用户发起查询，THEN 应记录 requestId、userId、query、timestamp
- WHEN 工具被调用，THEN 应记录 toolName、parameters（脱敏）、result、duration
- WHEN 系统返回响应，THEN 应记录 response 摘要和 evidence 引用
- IF 操作失败，THEN 应记录 error code 和 message

**优先级**：P0（必须）
**依赖**：R2.1
**实施阶段**：L1

#### R11.2 审计日志不可篡改
**用户故事**：作为合规官，我需要确保审计日志不可被篡改，以保证审计的可信度。

**验收标准**：
- WHEN 审计日志写入，THEN 应使用 append-only 模式
- WHEN 日志存储，THEN 应有权限控制（只有审计员可读）
- WHEN 日志查询，THEN 应记录查询操作本身
- IF 检测到篡改尝试，THEN 应触发告警

**优先级**：P0（必须）
**依赖**：R11.1
**实施阶段**：L1

#### R11.3 结构化日志
**用户故事**：作为运维工程师，我需要结构化的日志来支持日志分析和问题排查。

**验收标准**：
- WHEN 记录日志，THEN 应使用 JSON 格式
- WHEN 日志包含 requestId，THEN 应贯穿整个调用链
- WHEN 日志包含错误，THEN 应包含 stack trace
- IF 日志包含敏感信息，THEN 应脱敏

**优先级**：P1（重要）
**依赖**：R11.1
**实施阶段**：L1

### 模块十二：可观测性

#### R12.1 OpenTelemetry 集成
**用户故事**：作为运维工程师，我需要使用 OpenTelemetry 来追踪请求链路和性能指标。

**验收标准**：
- WHEN 请求处理，THEN 应创建 trace 和 span
- WHEN span 创建，THEN 应包含 requestId、sessionId、operation
- WHEN span 结束，THEN 应记录 duration 和 status
- IF span 失败，THEN 应记录 error 信息

**优先级**：P1（重要）
**依赖**：R2.1
**实施阶段**：L2

#### R12.2 性能指标收集
**用户故事**：作为运维工程师，我需要收集关键性能指标来监控系统健康状况。

**验收标准**：
- WHEN 系统运行，THEN 应收集请求量、错误率、延迟（P50/P95/P99）
- WHEN 工具调用，THEN 应收集工具调用延迟和失败率
- WHEN 模型推理，THEN 应收集推理延迟和队列长度
- IF 指标异常，THEN 应触发告警

**优先级**：P1（重要）
**依赖**：R12.1
**实施阶段**：L2

#### R12.3 健康检查
**用户故事**：作为运维工程师，我需要健康检查端点来监控系统和依赖服务的状态。

**验收标准**：
- WHEN 调用健康检查端点，THEN 应返回系统状态和依赖服务状态
- WHEN 依赖服务不可用，THEN 应标记为 unhealthy
- WHEN 系统过载，THEN 应标记为 degraded
- IF 健康检查失败，THEN 应触发告警

**优先级**：P1（重要）
**依赖**：无
**实施阶段**：L1

### 模块十三：前端交互层

#### R13.1 三栏式布局
**用户故事**：作为用户，我希望界面清晰易用，能快速找到我需要的功能。

**验收标准**：
- WHEN 用户打开应用，THEN 应显示左侧导航栏、中间对话区、右侧证据面板
- WHEN 用户切换会话，THEN 应在导航栏中高亮当前会话
- WHEN 用户点击证据链，THEN 应在右侧面板展开详情
- IF 屏幕较小，THEN 应自动调整布局

**优先级**：P0（必须）
**依赖**：无
**实施阶段**：L1

#### R13.2 SSE 流式渲染
**用户故事**：作为用户，我希望能实时看到系统的处理进度和回答内容。

**验收标准**：
- WHEN 系统输出 message.delta 事件，THEN 应实时渲染到对话区
- WHEN 系统输出 progress 事件，THEN 应显示进度指示器
- WHEN 系统输出 evidence.update 事件，THEN 应更新证据面板
- IF 连接断开，THEN 应提示用户并尝试重连

**优先级**：P0（必须）
**依赖**：R6.1, R13.1
**实施阶段**：L1

#### R13.3 证据链可视化
**用户故事**：作为用户，我希望能直观地看到数据来源和计算过程。

**验收标准**：
- WHEN 回答包含数值，THEN 应显示为胶囊组件（Trust Pill）
- WHEN 用户悬停胶囊，THEN 应显示数据源和提取时间
- WHEN 用户点击胶囊，THEN 应在右侧面板展开完整证据链
- IF 数据不确定，THEN 应显示虚线边框并提示

**优先级**：P0（必须）
**依赖**：R2.2, R13.1
**实施阶段**：L1

#### R13.4 图表动态生成
**用户故事**：作为用户，我希望系统能自动生成图表来展示数据，而不是只有文字。

**验收标准**：
- WHEN 回答涉及成本对比，THEN 应生成瀑布图
- WHEN 回答涉及趋势分析，THEN 应生成折线图
- WHEN 回答涉及占比分析，THEN 应生成饼图或柱状图
- IF 数据不适合图表展示，THEN 应使用表格

**优先级**：P1（重要）
**依赖**：R2.3, R13.1
**实施阶段**：L2

#### R13.5 移动端适配
**用户故事**：作为维修工，我希望能在防爆平板或手机上使用系统。

**验收标准**：
- WHEN 在移动端打开，THEN 应显示适配的布局
- WHEN 用户使用语音输入，THEN 应支持语音识别
- WHEN 用户上传照片，THEN 应支持拍照和相册选择
- IF 网络不稳定，THEN 应支持离线缓存关键功能

**优先级**：P1（重要）
**依赖**：R13.1
**实施阶段**：L2

### 模块十四：非功能性需求

#### R14.1 性能要求
**用户故事**：作为用户，我希望系统响应迅速，不让我等待太久。

**验收标准**：
- WHEN 用户使用语音交互发起请求，THEN 首次可感知响应时间应 < 2秒（P95）
- WHEN 用户发起简单查询，THEN 响应时间应 < 2秒（P95）
- WHEN 用户发起跨系统复杂分析，THEN 端到端完成时间应 < 30秒（P95）
- WHEN 系统处理超过 5 秒，THEN 应输出进度更新
- IF 系统过载，THEN 应返回 SERVICE_UNAVAILABLE 错误

**优先级**：P0（必须）
**依赖**：R2.1
**实施阶段**：L1

#### R14.2 可用性要求
**用户故事**：作为用户，我希望系统稳定可靠，不经常出故障。

**验收标准**：
- WHEN 系统运行，THEN 核心查询可用性应 >= 99.9%
- WHEN 依赖服务不可用，THEN 应降级处理并明确提示
- WHEN 系统故障，THEN 应在 5 分钟内恢复或切换到备用
- IF 故障无法恢复，THEN 应通知运维团队

**优先级**：P0（必须）
**依赖**：R12.3
**实施阶段**：L2

#### R14.3 数据一致性
**用户故事**：作为用户，我希望系统返回的数据是准确和一致的。

**验收标准**：
- WHEN 系统返回数值，THEN 必须来自真实数据源
- WHEN 涉及计算，THEN 必须使用统一的指标口径
- WHEN 数据不一致，THEN 系统应拒绝返回并提示
- IF 数据质量低，THEN 应在证据链中标注

**优先级**：P0（必须）
**依赖**：R2.2, R7.3
**实施阶段**：L1

#### R14.4 幻觉检测与降级
**用户故事**：作为用户，我希望系统不会编造数据或给出不可靠的建议。

**验收标准**：
- WHEN 系统生成数值，THEN 应检查是否有数据源支持
- WHEN 数值超出合理区间，THEN 应触发幻觉检测
- WHEN 检测到幻觉，THEN 应降级为"仅展示数据与来源"
- IF 无法验证，THEN 应明确告知不确定性

**优先级**：P0（必须）
**依赖**：R2.2
**实施阶段**：L1

#### R14.5 私有化部署
**用户故事**：作为安全官，我需要确保所有数据和模型都在内网，不出厂。

**验收标准**：
- WHEN 系统部署，THEN 所有组件应在内网
- WHEN 模型推理，THEN 应使用本地部署的模型
- WHEN 数据存储，THEN 应在本地数据库
- IF 需要外网访问，THEN 应通过物理隔离网关

**优先级**：P0（必须）
**依赖**：无
**实施阶段**：L1

### 模块十五：编排引擎（Orchestration Engine）

#### R15.1 意图识别与任务路由
**用户故事**：作为系统架构师，我需要系统能区分“查询”、“分析”、“预警”与“操作”意图，并路由到正确的处理链路。

**验收标准**：
- WHEN 用户输入请求，THEN 系统应输出意图分类结果（query/analyze/alert/action）与置信度
- WHEN 意图为 query/analyze，THEN 系统应只允许调用只读工具链
- WHEN 意图为 action，THEN 系统必须进入只读默认流程并提示需要授权与审批
- IF 意图不明确，THEN 系统应向用户发起澄清问题而非猜测执行

**优先级**：P0（必须）
**依赖**：R5.1, R6.1
**实施阶段**：L1

#### R15.2 RAG 检索增强（设备手册/规程/故障库）
**用户故事**：作为维修工/工艺员，我希望系统在回答规程与故障问题时能引用真实文档来源，而不是凭空生成。

**验收标准**：
- WHEN 用户提问涉及规程/手册/故障库，THEN 系统应执行检索并返回可追溯引用（文档名、章节/页码、片段ID）
- WHEN 系统输出建议类结论，THEN 必须附带至少 1 条检索证据或明确声明“no evidence found”
- IF 检索不到相关内容，THEN 系统应明确告知并建议转人工或补充资料
- WHEN 文档更新，THEN 新文档应可被检索到且不影响既有引用的可追溯性

**优先级**：P1（重要）
**依赖**：R2.2, R14.5
**实施阶段**：L2

#### R15.3 工具链注册与 Function Calling（跨系统封装）
**用户故事**：作为系统架构师，我需要把 SAP/MES/DCS/EAM 等系统能力封装成可控工具，以便编排引擎可靠调用并形成证据链。

**验收标准**：
- WHEN 系统需要外部数据，THEN 必须通过工具调用获取而非模型“臆测”
- WHEN 工具被调用，THEN 必须记录 toolName、参数摘要（脱敏）、耗时、状态与 evidence 引用
- WHEN 工具返回数据，THEN 系统应将数据与证据对象绑定到本次 requestId
- IF 工具返回结果不符合契约，THEN 系统应返回 CONTRACT_VIOLATION 并记录审计

**优先级**：P0（必须）
**依赖**：R8.2, R9.3, R11.1
**实施阶段**：L1

#### R15.4 Token 预算、配额与模型路由（SLM/LLM）
**用户故事**：作为系统管理员，我需要控制推理成本，并把简单查询路由到小模型、复杂分析路由到大模型。

**验收标准**：
- WHEN 用户请求为简单查询，THEN 系统应优先使用小模型或模板化工具查询
- WHEN 用户请求为复杂分析，THEN 系统应路由到大模型并输出可观测的路由原因
- WHEN 超出配额或预算，THEN 系统应返回 FORBIDDEN 或 SERVICE_UNAVAILABLE，并给出可执行的降级建议
- WHEN 高频问题被重复询问，THEN 系统应支持缓存并返回缓存命中信息（可审计）

**优先级**：P1（重要）
**依赖**：R15.1, R9.2, R11.1
**实施阶段**：L2

#### R15.5 纠错反馈闭环（RLHF for Industry）
**用户故事**：作为业务用户，我希望能对 AI 的回答进行纠错，帮助系统持续改进。

**验收标准**：
- WHEN 用户对回答点赞/点踩，THEN 系统应记录反馈并绑定 requestId
- WHEN 用户提交纠错内容，THEN 系统应写入待审核队列并记录提交人、时间与引用证据
- WHEN 纠错通过审核，THEN 应进入知识库/规则库并纳入 Golden Dataset 回归集
- IF 纠错内容缺少依据，THEN 系统应要求补充引用或标注为“unverified”

**优先级**：P1（重要）
**依赖**：R11.1, R15.2
**实施阶段**：L2

### 模块十六：统一语义层与数据质量（Data Infrastructure）

#### R16.1 实体与 ID 映射（设备/物料/批次/订单）
**用户故事**：作为系统架构师，我需要建立统一实体ID，才能把不同系统的同一对象关联起来。

**验收标准**：
- WHEN 系统接入新数据源，THEN 必须能将设备/物料/炉次/订单映射到统一ID
- WHEN 用户跨系统查询同一对象，THEN 系统应基于统一ID聚合并避免重复/错配
- IF 映射缺失或冲突，THEN 系统应返回 EVIDENCE_MISMATCH 并提示需要补齐映射
- WHEN 映射变更，THEN 应版本化记录并可追溯历史映射

**优先级**：P0（必须）
**依赖**：R7.1, R8.1
**实施阶段**：L1

#### R16.2 事件模型（生产事件抽象与时间对齐）
**用户故事**：作为数据分析师，我需要用统一事件模型对齐 OT 时序数据与 MES 业务事件，避免误判。

**验收标准**：
- WHEN 系统处理时序数据，THEN 必须基于事件模型进行窗口/锚点对齐
- WHEN 系统生成证据链，THEN 必须展示对齐规则、锚点事件与时间窗口
- IF 对齐失败或缺少事件，THEN 系统应返回 EVIDENCE_MISSING 或输出 warning 事件
- WHEN 新增事件类型，THEN 应保持向后兼容并可追溯版本

**优先级**：P0（必须）
**依赖**：R2.2, R6.2
**实施阶段**：L1

#### R16.3 数据质量评估前置（Data Sanitation）
**用户故事**：作为合规官/数据负责人，我需要在生成结论前评估数据质量，避免基于不可信数据输出。

**验收标准**：
- WHEN 系统读取关键数据源，THEN 应计算并记录数据质量等级（缺失/漂移/异常/延迟）
- WHEN 数据质量低于阈值，THEN 系统应拒绝给出确定性数值结论并提示原因
- WHEN 证据链展示数据，THEN 必须包含数据质量等级与计算时间
- IF 检测到疑似造假/异常尖峰，THEN 系统应触发告警并记录审计

**优先级**：P0（必须）
**依赖**：R2.2, R11.1
**实施阶段**：L1

#### R16.4 知识图谱增强（可选）
**用户故事**：作为维修工，我希望系统能基于“设备-故障-现象-备件-事件”进行多跳关联，提升排障效率。

**验收标准**：
- WHEN 用户查询故障与备件关联，THEN 系统应能返回多跳链路与每跳证据来源
- WHEN 系统推荐备件，THEN 必须可追溯到故障历史与备件BOM/库存证据
- IF 推理链路缺少证据，THEN 系统应降级为仅展示已知关联与来源

**优先级**：P2（可选）
**依赖**：R16.1, R15.2
**实施阶段**：L3

### 模块十七：LLMOps 评估与防护栏（Evaluation & Guardrails）

#### R17.1 Golden Dataset 回归与发布门禁
**用户故事**：作为模型运营人员，我需要在模型/Prompt/工具变更后自动回归评估，确保指标不下降才允许发布。

**验收标准**：
- WHEN 模型或 Prompt 或工具链发生变更，THEN 必须触发 Golden Dataset 全量回归
- WHEN 回归完成，THEN 应生成评估报告（准确率/拒答率/升级人工比例）并记录版本号
- IF 任一核心指标下降超过阈值，THEN 必须阻止发布并给出差异样本清单
- WHEN 发布通过，THEN 应记录发布证据（commit/version、数据集版本、评估摘要）

**优先级**：P1（重要）
**依赖**：R11.1
**实施阶段**：L2

#### R17.2 高风险意图识别与策略化拦截
**用户故事**：作为安全工程师，我需要对高风险意图、越权行为与写操作倾向进行策略化检测与拦截。

**验收标准**：
- WHEN 系统检测到越权/敏感查询，THEN 必须返回 FORBIDDEN 并记录审计
- WHEN 系统检测到写操作倾向或高风险指令，THEN 必须返回 GUARDRAIL_BLOCKED 并提示进入审批
- WHEN 触发拦截，THEN 证据链中应记录拦截规则ID与命中原因（不包含敏感细节）
- IF 用户持续尝试绕过，THEN 系统应提升风险级别并可触发告警

**优先级**：P0（必须）
**依赖**：R1.2, R10.1, R11.1
**实施阶段**：L1

#### R17.3 物理约束与关键数值一致性校验（Hallucination Detection）
**用户故事**：作为安全官，我需要系统对关键数值进行物理边界/变化率校验，避免幻觉导致误判。

**验收标准**：
- WHEN 系统输出关键数值（温度/压力/能耗/产量等），THEN 必须校验是否有数据源与合理区间支持
- WHEN 检测到越界或变化率异常，THEN 系统应返回 GUARDRAIL_BLOCKED 或降级为“仅展示数据与来源”
- WHEN 发生降级，THEN 系统应在证据链中记录触发规则与阈值版本
- IF 无法完成校验，THEN 系统应明确告知不确定性并建议人工复核

**优先级**：P0（必须）
**依赖**：R14.4, R2.2
**实施阶段**：L1

### 模块十八：现场环境适应性（抗噪与离线）

#### R18.1 抗噪语音交互与自动降级
**用户故事**：作为维修工，我希望在高噪声环境下系统仍可用，必要时自动切换到文字交互。

**验收标准**：
- WHEN 环境噪声超过阈值，THEN 系统应提示语音识别可能不可靠并建议切换输入方式
- WHEN 语音识别置信度低于阈值，THEN 系统应自动降级为文字输入并保留上下文
- WHEN 发生降级，THEN 系统应记录审计与可观测日志（不含音频原始内容）

**优先级**：P1（重要）
**依赖**：R11.1, R13.5
**实施阶段**：L2

#### R18.2 弱网与离线缓存（关键资料）
**用户故事**：作为现场人员，我希望在弱网/离线环境下仍能查到关键资料（维修手册、SOP、常用故障排查流程）。

**验收标准**：
- WHEN 网络不可用，THEN 移动端应进入离线模式并提示可用缓存范围
- WHEN 用户查询已缓存资料，THEN 系统应返回离线结果并标注“offline data”
- WHEN 网络恢复，THEN 系统应自动同步并更新缓存索引
- IF 用户请求未缓存资料，THEN 系统应明确告知并提供可执行替代方案

**优先级**：P1（重要）
**依赖**：R13.5, R14.5
**实施阶段**：L2

## 实施路线图

### Phase 1：全知查询员（L1 / MVP）

**目标**：打通核心报表，实现"一句话查数据"，上线证据链

**包含需求**：
- R1.1 用户认证
- R1.2 基于角色的访问控制
- R1.3 数据域隔离
- R2.1 自然语言查询
- R2.2 证据链生成
- R2.3 成本分析与对比
- R5.1 只读默认
- R6.1 SSE 流式输出
- R6.2 证据链增量更新
- R6.3 错误流式处理
- R7.1 Postgres 数据库设计
- R7.2 造数脚本
- R7.3 指标口径仓库
- R8.1 Postgres 查询工具
- R8.2 工具参数校验
- R8.3 工具超时与重试
- R9.1 llama.cpp 接入
- R9.3 输出结构化校验
- R10.1 提示词注入防护
- R10.2 敏感信息脱敏
- R10.3 输出安全校验
- R11.1 审计日志记录
- R11.2 审计日志不可篡改
- R11.3 结构化日志
- R12.3 健康检查
- R13.1 三栏式布局
- R13.2 SSE 流式渲染
- R13.3 证据链可视化
- R14.1 性能要求
- R14.3 数据一致性
- R14.4 幻觉检测与降级
- R14.5 私有化部署
- R15.1、R15.3、R16.1、R16.2、R16.3、R17.2、R17.3

**验收指标**：
- 跨系统查询耗时 P95 < 10秒
- 关键指标回答准确率 >= 99%
- 审计日志覆盖率 100%
- SSE 联调成功，前端可实时渲染
- 数值回答可追溯，证据链完整

**预计工期**：8-12 周

### Phase 2：维修副驾驶（L2）

**目标**：接入设备文档与故障库，实现多模态诊断辅助

**包含需求**：
- R2.4 异常主动推送
- R2.5 智能交接班
- R3.1 多模态故障诊断
- R3.2 维修方案推荐
- R3.3 设备历史查询
- R4.3 工艺知识检索
- R9.2 并发控制
- R12.1 OpenTelemetry 集成
- R12.2 性能指标收集
- R13.4 图表动态生成
- R13.5 移动端适配
- R14.2 可用性要求
- R15.2、R15.4、R15.5、R17.1、R18.1、R18.2

**验收指标**：
- 常见故障 Top20 覆盖
- MTTR 下降可量化
- 建议引用来源覆盖率 100%
- 移动端可用性 >= 99%

**预计工期**：6-8 周

### Phase 3：生产决策辅助（L3）

**目标**：接入 DCS 实时数据，提供工艺参数优化建议

**包含需求**：
- R4.1 工艺参数优化建议
- R4.2 规程合规检查

**验收指标**：
- 在离线回放/沙箱仿真中达到既定节能或质量波动下降目标
- 建议具备约束清单与证据链
- 规程合规检查准确率 >= 95%

**预计工期**：8-10 周

### Phase 4：受控闭环（L4 / 可选）

**目标**：支持有限域的写操作，并具备多签、回滚、熔断

**包含需求**：
- R5.2 写操作草案生成
- R5.3 审批与多签
- R5.4 受控执行与回滚
- R5.5 模拟仿真与培训
- R16.4

**验收前置条件**：
- 权限体系与审计完善
- 安全网关与沙箱仿真通过
- 试点产线/设备范围明确

**验收指标**：
- 写操作审批流程完整
- 回滚成功率 100%
- 沙箱模拟准确率 >= 90%

**预计工期**：10-12 周

## 风险与控制

### 风险矩阵

| 风险点 | 描述 | 影响 | 概率 | 控制措施 |
|--------|------|------|------|----------|
| 模型幻觉 | Agent 编造工艺参数或虚假报警 | 高 | 中 | 引入 RAG 机制；强制附带参考来源；关键参数需人工二次核实 |
| 误操作 | Agent 错误调用写接口导致停产 | 高 | 低 | 只读默认；写操作必须经过草案→审批→受控执行；具备回滚与熔断 |
| 数据泄露 | 敏感配方泄露 | 高 | 低 | 私有化部署；敏感词过滤；审计日志记录 |
| 口径不一致 | 同一指标不同部门口径不同 | 中 | 高 | 建立指标口径仓库；版本化管理；强制引用口径版本 |
| 时间对齐错误 | OT时序与MES事件错配 | 中 | 中 | 引入事件模型与时间对齐策略；在证据链中展示对齐规则 |
| 算力成本失控 | 私有化大模型推理成本高 | 中 | 中 | Token预算与配额管理；简单查询路由到小模型；高频问题做缓存 |
| 过度依赖 | 一线员工丧失独立判断能力 | 中 | 中 | 设置培训与考核机制；定期盲测/演练；关键建议强制确认 |
| 性能瓶颈 | 并发请求导致系统过载 | 中 | 中 | 并发控制；队列管理；降级策略 |
| 依赖服务不可用 | Postgres/llama.cpp 不可用 | 高 | 低 | 健康检查；降级处理；告警机制 |

## 成功指标

### 经营侧 KPI
- 吨钢成本：可查询、可追溯、可对比
- 吨钢能耗：实时监控、异常告警
- 批次毛利：自动计算、口径统一
- 订单准交率：实时跟踪
- 库存周转天数：趋势分析

### 生产侧 KPI
- 良品率/降级率：实时监控、异常告警
- 关键工序节拍偏差：自动检测
- 异常处置时长：缩短 30%

### 设备侧 KPI
- 非计划停机时长：减少 20%
- MTTR：缩短 25%
- MTBF：提升 15%
- 缺件导致的停机次数：减少 40%

### 系统侧 KPI
- 查询响应时间：P95 < 10秒
- 系统可用性：>= 99.9%
- 审计覆盖率：100%
- 数值回答准确率：>= 99%
- 证据链完整率：100%

## 附录

### 术语表

- **SSE**：Server-Sent Events，服务端推送事件
- **Evidence**：证据链，包含数据源、时间范围、计算口径等
- **HITL**：Human-in-the-loop，人在回路
- **RBAC**：Role-based access control，基于角色的访问控制
- **Lineage**：指标口径版本与血缘
- **RAG**：Retrieval-Augmented Generation，检索增强生成
- **MTTR**：Mean Time To Repair，平均修复时间
- **MTBF**：Mean Time Between Failures，平均故障间隔时间
- **Trust Pill**：证据链胶囊，用于展示数据来源的 UI 组件

### 错误码清单

- `VALIDATION_ERROR`：参数校验失败
- `AUTH_ERROR`：认证失败
- `FORBIDDEN`：权限不足
- `NOT_FOUND`：资源不存在
- `UPSTREAM_TIMEOUT`：上游服务超时
- `UPSTREAM_UNAVAILABLE`：上游服务不可用
- `CONTRACT_VIOLATION`：契约违反
- `GUARDRAIL_BLOCKED`：防护栏拦截
- `EVIDENCE_MISSING`：证据链缺失
- `EVIDENCE_MISMATCH`：证据链不匹配
- `SERVICE_UNAVAILABLE`：服务不可用

### 参考文档

- 产品需求文档：`docs/产品需求.md`
- 技术设计文档：`docs/技术设计文档-最佳实践版.md`
- 项目现状分析：`docs/项目现状分析.md`
- 编码规范：`docs/coding-standards.md`
- 全局编码规范：`docs/全局编码规范.md`

