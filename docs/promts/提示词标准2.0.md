
# 提示词标准（Prompt Standard）

## 1. 核心理念与架构

本文档定义了 GangQing 项目中任务提示词（Task Prompt）的编写标准。

**核心模式：Umbrella (总控) + Sub-task (执行)**

| 维度 | **Umbrella Task (雨伞/总任务)** | **Sub-task (子任务)** |
| :--- | :--- | :--- |
| **角色定位** | 🏗️ **架构师 / 技术负责人** | 🧱 **高级开发工程师** |
| **核心目标** | 建立上下文、制定计划、统一规范、识别风险 | 编写代码、通过测试、交付功能 |
| **行为模式** | **只动脑，不动手**。分析依赖，拆解步骤。 | **只动手，少废话**。逐个击破，原子提交。 |
| **禁止事项** | **严禁输出具体实现代码**（防止幻觉与上下文溢出）。 | 严禁扩大范围，严禁使用 Mock 替代真实服务（除非必要）。 |
| **交付物** | ✅ 执行计划 (Execution Plan)<br>✅ 依赖图谱<br>✅ 文件结构规划<br>✅ 接口契约 (Schema) | 📦 源代码文件<br>📦 测试文件<br>📦 运行通过的截图/日志 |

---

## 2. 标准工作流 (The Workflow)

为了确保质量与可控性，必须严格遵守以下 **"Planning -> Execution -> Verification"** 循环：

1.  **Phase 1: 规划 (Umbrella)**
    *   用户发送 **Umbrella 提示词**。
    *   AI 分析需求，输出 **《执行蓝图》**（含详细的步骤拆解 1.1, 1.2...）。
    *   *人类介入*：审查计划，确认没有遗漏依赖，确认技术选型正确。

2.  **Phase 2: 执行 (Sub-tasks)**
    *   用户发送 **子任务 1.1 提示词**。
    *   AI 编写代码并自测。
    *   *人类介入*：验收代码与测试结果。
    *   用户发送 **子任务 1.2 提示词** ...（循环直至完成）。

3.  **Phase 3: 验收 (Umbrella Verification)**
    *   所有子任务完成后，用户参考 Umbrella 的 **Verification 章节**。
    *   运行整体集成测试，确认系统作为整体工作正常。

---

## 3. 提示词编写模板

### A. Umbrella 提示词模板 (架构师模式)

> **关键点**：此提示词必须强迫 AI **停止写代码的冲动**，转而专注于设计与规划。

```markdown
### Task {N} - {任务组名称}（Umbrella）

\`\`\`markdown
# Context
你是 GangQing（钢擎）项目的负责落地与验收的工程师。
你正在执行第 {N} 组任务：{任务组名称}。
你的角色是 **技术负责人/架构师**。
你的目标是制定任务组 {N} 的详细执行计划，并定义技术规范与验收口径。

# Critical Rules (核心约束)
- **NO CODE IMPLEMENTATION**: 在此阶段**禁止**输出任何具体的函数实现或业务代码。
- **PLANNING ONLY**: 你的输出应该聚焦于“怎么做”、“分几步”、“文件结构如何”、“接口长什么样”。
- **Technology Standards**: 
  - TypeScript Strict (No Any).
  - 前端：对外 I/O 与配置使用 Zod 作为单一事实源（schema -> type）。
  - 后端：对外 I/O 与工具参数使用 Pydantic 作为单一事实源。
  - 错误信息（`message`）必须为英文；对外错误必须结构化：`code` + `message` + `requestId` + `retryable` + `details?`。
  - **Evidence-First**: 数值结论/关键建议必须可追溯到证据链（数据源、时间范围、口径版本、工具调用、数据质量）。
  - **Read-Only Default**: 默认只读；任何写操作必须走“草案 -> 审批/多签 -> 受控执行 -> 回滚点 -> 审计”。
  - **RBAC & Audit**: 所有接口/工具必须做 RBAC 权限检查并记录审计事件，贯穿 `requestId`。
  - **Streaming**: 若有长耗时任务，优先使用 SSE/流式事件输出阶段进度与可解析错误事件。

# References
- PRD: docs/产品需求.md
- TDD: docs/技术设计文档-TDD.md
- tasks: docs/tasks.md（Task {N}.1-{N}.M）
- contracts: docs/contracts/api-and-events-draft.md
- api docs: docs/api/*.md

# Execution Plan (执行蓝图)

1) {子模块 1 名称}（Task {N}.1）
- Goal: {简述目标}
- Key Decisions: {关键技术决策，如目录结构、库的选择}
- Deliverables: {该步骤产出的关键文件或模块}

2) {子模块 2 名称}（Task {N}.2）
- Goal: {简述目标}
- Dependencies: {依赖 Task {N}.1 的什么产出}

...

# Deliverables Definition (交付物定义)
- [ ] **Directory Structure**: 明确新增/修改的目录树。
- [ ] **Environment Variables**: 明确需要的 ENV 及其校验 Schema（前端 Zod / 后端 Pydantic 或统一配置加载约定）。
- [ ] **API Contracts**: 核心接口的输入输出定义（必须与 `docs/contracts/api-and-events-draft.md` 对齐）。
- [ ] **Evidence Contract**: 证据链数据结构（Evidence/EvidenceChain）与可追溯字段（数据源、时间范围、口径版本、数据质量）。
- [ ] **Auth & RBAC**: 鉴权方式、角色/权限点、拒绝策略与审计字段。
- [ ] **Error Model**: 错误码枚举与结构化错误响应/事件。
- [ ] **Observability**: `requestId` 贯穿方案，关键日志字段与审计事件类型。

# Verification Plan (整体验收)
- 自动化断言：
  - {集成测试场景 1}
  - {集成测试场景 2}

# Output Requirement
请输出一份详细的 **Markdown 执行计划**，包含上述所有章节。
**不要写代码**，请确认你理解了全局设计后再输出计划。
\`\`\`
```

---

### B. Sub-task 提示词模板 (工程师模式)

> **关键点**：此提示词必须强迫 AI **立即产出可运行的代码**，并包含自我验证步骤。

```markdown
### Task {N}.{M} - {子任务标题}

\`\`\`markdown
# Context
你是 GangQing（钢擎）项目的负责落地与验收的工程师。
你正在执行 {任务组名称} 下的子任务：{N}.{M} - {子任务标题}。
你的角色是 **高级开发工程师**。
你的目标是编写代码，完成该具体功能，并确保通过测试。

# Critical Rules (核心约束)
- **TypeScript Strict**: 禁止 `any`（若改动前端）。
- **Schema First**: 
  - 前端：对外 I/O、SSE 事件、配置使用 Zod 校验。
  - 后端：对外 I/O、工具参数、Evidence、审计事件使用 Pydantic 校验。
- **Evidence-First**: 任何数值类输出必须来自工具/API 原始数据并写入证据链；不可验证则降级为“仅展示数据与来源/不确定项”。
- **Real Integration (No Skip)**: 测试必须连接真实服务（DB/Redis/LLM/外部系统）。
  - 配置缺失或服务不可用：**测试必须失败**并给出清晰英文错误（不得 `skip`）。
  - 禁止使用 mock/stub 替代真实服务（单元测试允许通过依赖注入提供等价 fake 实现，但必须模拟真实错误语义）。
- **Structured Errors**: 对外错误必须结构化（`code`/`message`/`requestId`/`retryable`/`details?`），其中 `message` 必须为英文。
- **RBAC & Audit**: 任何敏感查询/工具调用/写操作必须做 RBAC 校验并记录审计，日志包含 `requestId`/`toolName`/`stepId`（如有）。
- **Read-Only Default**: 未显式授权与审批前不得执行写操作；写操作仅生成草案与审批材料。

# References
- PRD: docs/产品需求.md
- TDD: docs/技术设计文档-TDD.md
- tasks: docs/tasks.md（{N}.{M}）
- contracts: docs/contracts/api-and-events-draft.md

# Execution Plan (具体步骤)

1) 定义数据结构与契约
- Files: {src/config/..., src/types/...}
- Action: 定义 Zod Schema，确保类型安全。

2) 实现核心逻辑
- Files: {src/services/..., src/routes/...}
- Action: 编写业务逻辑，处理错误边界。

3) 编写测试用例
- Files: {tests/...}
- Action: 编写单元测试与集成测试。

# Verification (验收标准)
- **Automated Tests**:
  - `bun test {测试文件名}` 必须通过。
  - 覆盖率要求：Happy Path + 至少 2 个 Edge Cases (如超时、格式错误)。
- **Manual Verification**:
  - {具体的 Curl 命令或操作步骤}

# Output Requirement
- 输出所有修改或创建的 **文件完整内容** (Source Code)。
- 输出 **测试运行命令** 和 **预期通过的日志截图/文本**。
\`\`\`
```

---

## 4. 编写质量检查清单 (Quality Checklist)

在生成提示词文档后，请对照以下标准进行自检：

### ✅ Umbrella 检查点
*   [ ] 是否包含了 `# Critical Rules` 并明确禁止写代码？
*   [ ] `# Execution Plan` 是否覆盖了该任务组下的所有子任务（{N}.1 到 {N}.M）？
*   [ ] 是否定义了全局性的技术标准（Schema 单一事实源、结构化错误、证据链、只读默认、RBAC/审计、配置外部化）？
*   [ ] 是否包含最终的集成验收标准？

### ✅ Sub-task 检查点
*   [ ] 是否明确列出了 **Target Files**（要修改哪些文件）？
*   [ ] 验收标准中是否包含具体的 **自动化测试断言**？
*   [ ] 是否强调了 **真实环境集成 (Real Integration)** 而非 Mock，并且明确“不可 skip”？
*   [ ] 是否包含了契约校验要求（前端 Zod / 后端 Pydantic）？
*   [ ] 是否包含证据链生成/展示/可追溯字段要求（如适用）？
*   [ ] 是否包含鉴权/RBAC/审计字段与结构化错误要求（如适用）？

---
