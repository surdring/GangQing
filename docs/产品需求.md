
### 产品需求文档 (PRD)

#### 项目名称：GangQing —— 钢铁工业全域认知决策系统

#### 1. 项目背景与目标
*   **背景：** 钢铁厂现有信息化系统极其复杂（ERP、MES、DCS、LIMS、EAM等林立），数据割裂，操作门槛高。管理层难以实时掌握经营全貌，一线员工过度依赖老师傅经验。
*   **目标：** 构建一个基于私有化大模型的Agent系统，作为全厂唯一的智能化交互入口。
    *   **提效：** 将跨系统查询时间从小时级降低到秒级。
    *   **传承：** 固化专家经验，降低对人的依赖。
    *   **安全：** 在不接触底层控制权的前提下，提供辅助决策。

#### 1.1 成功指标（可量化）
*   **经营侧（示例KPI）：** 吨钢成本、吨钢能耗、批次毛利、订单准交率、库存周转天数。
*   **生产侧（示例KPI）：** 良品率/降级率、关键工序节拍偏差、异常处置时长。
*   **设备侧（示例KPI）：** 非计划停机时长、MTTR、MTBF、缺件导致的停机次数。
*   **价值公式（用于立项与复盘）：**
    *   收益 = (吨钢能耗下降 * 产量 * 能源单价) + (停机小时减少 * 小时产值) + (降级品减少 * 价差) + (库存资金占用下降 * 资金成本)

#### 2. 用户画像 (Personas)
*   **P1 厂长/高管：** 关注利润、产量、安全。不看复杂报表，只问结果。
*   **P2 生产调度员：** 关注排产进度、物流瓶颈、异常处理。
*   **P3 设备维修工：** 关注故障原因、维修方案、备件库存。需现场移动作业。
*   **P4 财务人员：** 关注实时成本、原料价格波动对利润的影响。

#### 3. 产品架构 (The "Hamburger" Model)

*   **交互层 (Frontend Agent)：**
    *   支持 PC 端（管理驾驶舱）+ 移动端（防爆平板/手机）。
    *   LUI 自然语言交互（语音/文字/图片上传）。
*   **大脑层 (Orchestration Engine)：**
    *   **意图识别：** 区分“查询”、“分析”、“预警”与“操作”。
    *   **RAG (检索增强)：** 挂载设备手册、历史故障库、工艺规范。
    *   **工具链 (Function Calling)：** 封装 SAP、Siemens PCS7、宝信MES等系统接口。
    *   **证据链 (Evidence)：** 对每次回答/建议强制生成可审计记录：数据源、时间范围、工具调用、关键约束检查、置信度与不确定项。
*   **模型运营与评估层 (LLMOps & Evaluation)：**
    *   **Golden Dataset（金标准测试集）：** 覆盖钢铁行业术语、常见故障、SOP问答、关键指标口径。每次模型微调或 Prompt/工具变更后必须全量回归，指标不下降方可发布。
    *   **自动化评估与防护栏 (Evaluation & Guardrails)：** 对高风险意图、关键数值与越权行为设置策略与检测；发布前后监控“准确率/拒答率/升级人工比例”。
    *   **Hallucination Detection（幻觉检测）：** 对输出中的关键数值与物理边界进行实时一致性校验（如温度/压力变化率、合理区间），触发降级为“仅展示数据与来源”或转人工复核。
*   **数据层 (Data Infrastructure)：**
    *   工业数据湖（汇聚 IT 结构化数据 + OT 时序数据）。
    *   私有化部署的垂类大模型（Fine-tuned on steel industry data）。
    *   **统一语义层（必须交付的基础设施）：**
        *   **实体与ID映射：** 设备（EAM/点位/DCS Tag）、物料（ERP编码）、炉次/批次（MES）、订单（ERP）建立统一ID与映射表。
        *   **事件模型：** 抽象关键生产事件（开炉/出铁/出钢/浇次/换包/换辊/停机/报警等），用于把时序数据与业务数据对齐。
        *   **指标口径仓库：** 对核心KPI（如吨钢能耗、实时毛利）固化计算公式、数据源、责任人、版本与血缘，避免“同名不同口径”。
    *   **知识图谱 (Knowledge Graph，可选增强)：** 以“设备-故障-现象-备件-工艺-事件”为主干，补强多跳推理与跨系统关联（如从停机事件追溯到故障件型号并联动库存）。

#### 4. 核心功能需求 (Functional Requirements)

##### 模块一：全知经营助手 (Management Pilot)
*   **F1.1 自然语言BI：**
    *   *User:* “告诉我昨天二号高炉的吨钢成本是多少？对比上个月主要贵在哪里？”
    *   *Agent Action:* 调取MES产量、DCS能耗、ERP原料价 -> 计算分摊 -> 生成对比图表 -> 文字总结：“贵在焦炭价格上涨15%。”
*   **F1.2 异常主动推送：**
    *   *Logic:* 监控到原料库存低于安全阈值，且未来三天有大额订单。
    *   *Agent Action:* 主动弹窗：“警报：铁矿石库存仅够维持2天生产，建议立即启动采购流程。”
*   **F1.3 结果可追溯（强制）：**
    *   *User:* “你刚才说焦炭贵在哪里？依据是什么？”
    *   *Agent Action:* 展示证据链：引用的ERP采购单范围、价格曲线、分摊公式版本、计算中间结果、所用时间窗口。
*   **F1.4 智能交接班 (Smart Shift Handover)：**
    *   *Logic:* 钢厂24小时连续生产，交接班信息易遗漏。
    *   *Agent Action:* 自动汇总本班次“异常事件/未闭环报警/临时参数调整/遗留待办”，生成《交接班数字日报》；支持追溯“谁在何时因何原因做了什么变更”。
    *   *User:* “上一班谁动过3号风机的参数？为什么要动？” -> Agent 调取审计日志与证据链回答。

##### 模块二：设备诊疗专家 (Maintenance Expert)
*   **F2.1 多模态故障诊断：**
    *   *User:* 拍摄一张损坏轴承的照片，或上传一段异响录音。
    *   *Agent Action:* 视觉/听觉识别 -> 检索知识库 -> “看起来是内圈疲劳剥落。建议检查润滑系统，并更换型号为SKF-123的轴承。”
*   **F2.2 关联数据查询：**
    *   *User:* “这台轧机上次大修是什么时候？换了什么件？”
    *   *Agent Action:* 调取 EAM 历史记录并朗读关键信息。

##### 模块三：生产工艺智库 (Process Knowledge Base)
*   **F3.1 参数设定辅助：**
    *   *User:* “现在的矿石品位变了，炉温该怎么调？”
    *   *Agent Action:* 检索历史相似批次的生产日志（Best Practice） -> “建议提高鼓风量至X，炉顶温度控制在Y范围。”
*   **F3.2 规程合规检查：**
    *   *Logic:* 实时监听操作指令。
    *   *Agent Action:* 若调度员下达了违反工艺红线的指令，Agent立即拦截并提示风险。

##### 模块四：受控操作与变更治理 (Controlled Actions)
*   **F4.1 只读默认（Read-Only Default）：**
    *   *Logic:* 未显式授权与审批的场景，Agent仅提供建议，不执行写操作。
*   **F4.2 写操作草案（Write-Prepare）：**
    *   *User:* “把今晚电炉排产按峰谷电价优化一下。”
    *   *Agent Action:* 生成可编辑“排产草案”，列出约束（订单优先级、设备能力、换炉/换钢种成本）、目标函数（成本/交期/能耗权重）。
*   **F4.3 审批与多签（Write-Approve）：**
    *   *Logic:* 调度变更需调度长确认；涉及工艺红线需工艺员确认；涉及安全连锁需安全员确认。
*   **F4.4 受控执行与回滚（Write-Execute & Rollback）：**
    *   *Logic:* 通过安全网关下发写接口；支持一键回滚到上一个已确认版本；执行过程可观测、可熔断。
*   **F4.5 模拟仿真与培训 (Simulation & Training Mode)：**
    *   *场景:* 新员工培训、应对罕见事故演练、上线前变更验证。
    *   *Agent Action:* 基于历史案例与规则库构建“虚拟演练场/沙箱回放”；用户输入处置方案，Agent 给出推演结果与风险提示，并引用规程条款与历史相似案例。

#### 5. 非功能性需求 (NFR)
*   **安全性 (Security)：**
    *   **数据不出厂：** 模型本地部署，物理隔离外网。
    *   **RBAC 权限：** 维修工不能问“财务报表”，销售不能看“核心工艺参数”。
    *   **审计与留痕：** 所有查询/建议/写操作生成不可篡改审计日志（用户、时间、数据范围、执行结果）。
*   **准确性 (Accuracy)：**
    *   对于数值类查询，严禁模型“幻觉”。必须精准调用 API 返回原始数据，并标注数据来源（如：数据来自 SAP-Module MM）。
    *   对于建议类输出，必须给出证据链与不确定项；缺少关键数据时应拒答或提示补齐数据。
*   **实时性 (Latency)：**
    *   语音交互响应 < 2秒。
    *   复杂数据分析 < 30秒（需提供进度条）。
*   **可靠性 (Reliability)：**
    *   核心查询可用性 >= 99.9%；外部系统不可用时降级（缓存/只读/延迟处理）并明确提示。
*   **环境适应性 (Environmental Adaptation)：**
    *   **抗噪设计：** 现场噪声大时需支持工业级降噪策略与可选硬件（抗噪耳机/骨传导等），否则语音交互应自动降级为文字交互。
    *   **弱网与离线 (Offline Mode)：** 屏蔽区/地下室等弱网环境下，移动端支持离线缓存关键资料（维修手册、SOP、常用故障排查流程），网络恢复后自动同步。
*   **交互形态 (LUI + GUI 融合)：**
    *   趋势图、热力图、BOM/备件清单等场景，Agent 应直接调出可交互 GUI 组件而非仅文字描述；支持“屏显指引/圈选提问”（用户指着图上波峰提问）。

#### 6. 风险与控制 (Risk Management)
| 风险点 | 描述 | 控制措施 |
| :--- | :--- | :--- |
| **模型幻觉** | Agent 编造工艺参数或虚假报警。 | 引入 RAG（检索增强）机制；在回答中强制附带“参考来源”链接；关键参数需人工二次核实。 |
| **误操作** | Agent 错误调用写接口导致停产。 | **原则：Read-Only Default。** 写操作必须经过：草案 -> 审批/多签 -> 受控执行；并具备阈值限制、回滚与熔断。 |
| **数据泄露** | 敏感配方泄露。 | 严格的私有化部署；对输出内容进行敏感词过滤和审计日志记录。 |
| **口径不一致** | 同一指标不同部门口径不同，导致信任崩塌。 | 建立“指标口径仓库”，对核心KPI版本化管理并强制引用口径版本。 |
| **时间对齐错误** | OT时序与MES事件错配导致误判。 | 引入事件模型与时间对齐策略（窗口/锚点事件），并在证据链中展示对齐规则。 |
| **算力成本失控** | 私有化大模型推理成本高，全员无限制使用导致ROI变差。 | Token预算与配额管理；简单查询路由到小模型（SLM），复杂分析路由到大模型；对高频问题做缓存与模板化工具查询。 |
| **过度依赖（De-skilling）** | 一线员工遇事只问AI，丧失独立判断与应急能力。 | 设置培训与考核机制；在非紧急场景定期进行“盲测/演练”；对关键建议强制要求用户确认“已理解风险点”。 |

#### 7. 实施路线图 (Roadmap)

*   **Phase 1：全知查询员 (L1 / MVP)**
    *   打通 ERP/MES 核心报表。
    *   实现“一句话查数据”。
    *   上线“证据链”：所有数值回答必须可追溯到数据源与时间范围。
    *   目标：替代晨会繁琐的PPT汇报。
    *   验收指标（示例）：跨系统查询耗时P95 < 10秒；关键指标回答准确率 >= 99%；审计日志覆盖率 100%。
*   **Phase 2：维修副驾驶 (L2)**
    *   接入设备文档与故障库。
    *   实现多模态诊断辅助。
    *   目标：缩短平均故障修复时间 (MTTR)。
    *   验收指标（示例）：常见故障Top20覆盖；MTTR下降可量化；建议引用来源覆盖率 100%。
*   **Phase 3：生产决策辅助 (L3)**
    *   接入 DCS 实时数据。
    *   提供工艺参数优化建议。
    *   目标：提升良品率，降低能耗。
    *   验收指标（示例）：在离线回放/沙箱仿真中达到既定节能或质量波动下降目标；建议具备约束清单与证据链。
*   **Phase 4：受控闭环（L4 / 可选，需强约束）**
    *   支持有限域的写操作（如工单生成、备件领料草案、排产草案下发），并具备多签、回滚、熔断。
    *   目标：在“责任可界定”的前提下实现闭环提效。
    *   验收前置条件：权限体系与审计完善；安全网关与沙箱仿真通过；试点产线/设备范围明确。



#### 8. 实施与运营补充 (Implementation & Operations)
*   **反馈闭环（RLHF for Industry）：**
    *   在每次回答/建议下提供“点赞/点踩/纠错”入口。
    *   “纠错”内容进入待审核队列，通过审核后以高权重进入知识库/规则库，并纳入 Golden Dataset 回归。
*   **数据质量评估前置 (Data Sanitation)：**
    *   在 Phase 1 之前进行数据质量评估（缺失、漂移、异常、人工造假风险、口径一致性）。
    *   对不可置信历史数据宁可舍弃或隔离，不直接用于训练与结论生成；在证据链中标注“数据质量等级”。


---

### 9. 界面设计方案

**PC端（管理/调度）** 和 **移动端（现场/维修）** 的高保真界面设计方案。

设计核心理念遵循：**LUI（自然语言交互）引导 + GUI（图形界面）呈现 + 证据链（信任可视化）。**

---

### 9.1 设计风格与规范 (Design System)

*   **色调 (Color Palette)：**
    *   **背景：** `Deep Steel Blue` (#0F172A) —— 工业暗黑模式，适合中控室大屏和低光照环境，减少视觉疲劳。
    *   **主色：** `Molten Orange` (#F97316) —— 代表钢铁/高温，用于AI激活状态、关键操作按钮。
    *   **辅助色：**
        *   `Safety Green` (#22C55E) —— 正常、运行中、效益正向。
        *   `Alert Red` (#EF4444) —— 报警、停机、亏损、越权拦截。
        *   `Tech Blue` (#3B82F6) —— 数据链接、引用来源、常规信息。
*   **字体与图标：** 使用高辨识度的无衬线字体（如 DIN Next 或 Inter），关键数值放大显示。图标采用实心工业风格。
*   **交互原则：** “AI 永远是副驾驶，人是最终决策者”。所有写操作需二次确认。

---

### 9.2 PC端界面设计：全域指挥舱 (The Command Center)
**适用画像：** P1 厂长、P2 调度员、P4 财务

#### 9.2.1 整体布局 (Layout)
界面分为三栏式布局：
*   **左侧导航栏 (Sidebar)：** 极简设计。包含：新对话、历史会话（按“交接班/日期”分组）、收藏的仪表盘、沙箱模式入口。
*   **中间主交互区 (Main Stage)：** 类似 ChatGPT 但具备“卡片化”输出能力的对话流。
*   **右侧详情/证据面板 (Context Panel)：** **(核心差异点)** 用于展示证据链、原始报表、PDF文档预览或操作审批流。
    
#### 9.2.2 核心场景界面展示

**场景 A：F1.1 自然语言 BI —— 厂长查成本**
*   **用户输入：** “昨天二号高炉吨钢成本为何超标？”
*   **AI 回答卡片 (中间区)：**
    *   **摘要：** “昨日二号高炉吨钢成本 2850元，超标 4.2%。主要原因是焦炭采购价上涨 15%。”
    *   **动态图表：** 自动生成一张“成本构成瀑布图 (Waterfall Chart)”，红色柱状高亮显示“焦炭”部分。
    *   **引用标签：** 文字末尾带有 `[数据源: SAP-CO 09:00]` 和 `[计算公式: V2.1]` 的蓝色胶囊标签。
*   **证据链展开 (右侧面板)：**
    *   点击引用标签，右侧面板滑出。
    *   展示：ERP 采购订单详情（包含价格曲线）、成本分摊计算过程、同行业对比参考值。
    *   **信任增强：** 底部显示“置信度：高 (数据完整)”。

**场景 B：F4.2 排产变更与审批 —— 调度员排产**
*   **用户输入：** “生成今晚电炉的峰谷电价优化排产草案。”
*   **AI 响应 (中间区)：**
    *   **状态栏：** 显示黄色横幅 `⚠️ 模拟草案模式 - 未执行`。
    *   **排产甘特图：** 可交互的甘特图组件，展示调整前后的时序对比。
    *   **关键指标卡：** 预计节省电费：¥12,000 | 预计延误风险：低。
    *   **操作区：** 两个按钮 —— [ 🛠️ 编辑参数 ] [ ✅ 提交审批 ]。
*   **审批流 (右侧面板)：**
    *   点击“提交审批”后，显示“审批链”：调度长（待办） -> 能源科（抄送）。
    *   **安全网关：** 若操作违反工艺红线，按钮置灰，并弹出红色警告框：“无法提交：违反《电炉冶炼规程》第3.2条（温度过低风险）”。

**场景 C：F1.4 智能交接班 —— 晨会模式**
*   **界面形态：** 类似于“每日头条”的聚合页。
*   **内容模块：**
    *   **异常事件回顾：** “昨夜班 03:15 3号风机振动报警（已处理）”。
    *   **参数变更审计：** “张三 将 炉顶压力 调整为 0.22MPa（原因：应对原料波动）”。
    *   **待办事项：** 自动生成的 To-Do List，支持勾选。

---

### 9.3 移动端界面设计：现场作业助手 (Field Assistant)
**适用画像：** P3 维修工、P2 现场调度
**设备载体：** 防爆平板 / 工业手机

#### 9.3.1 首页与导航
*   **底部导航 (Bottom Nav)：**
    1.  **智问 (Chat)：** 语音优先的大按钮。
    2.  **巡检 (Scan)：** 聚合扫码、拍照、NFC识别。
    3.  **工单 (Tasks)：** 待办任务与维修记录。
    4.  **我的 (Profile)：** 离线包管理、技能认证。

#### 9.3.2 核心场景界面展示

**场景 D：F2.1 多模态故障诊断 —— 维修工听音诊病**
*   **交互方式：**
    *   用户点击“智问” -> 长按麦克风 -> 说：“这台电机声音不对，你听听。” -> (录音5秒)。
*   **AI 响应界面：**
    *   **声纹分析图：** 显示频谱图，并圈出异常频段。
    *   **诊断结论：** “检测到 1200Hz 啸叫，疑似 **轴承内圈磨损** (置信度 85%) 或 **润滑不足** (置信度 40%)。”
    *   **行动建议 (Action Buttons)：**
        *   [ 📖 查看 SKF-123 更换视频 ] (点击播放)
        *   [ 📦 查备件库存 ] (显示：仓库A-03架，库存2件)
        *   [ ➕ 发起维修工单 ]

**场景 E：F2.2 离线模式与 AR 辅助 (弱网环境)**
*   **状态感知：** 顶部状态栏显示 `📡 离线模式 (已缓存基础库)`。
*   **AR 扫码：**
    *   用户使用“巡检”功能扫描设备二维码。
    *   **HUD 覆盖层：** 在摄像头画面上悬浮显示：
        *   设备名称：精轧机 F1
        *   当前状态：运行中 (绿点)
        *   核心参数：油温 45℃ (实时性：5分钟前)
        *   **最近维修：** 3天前（更换油封）。
*   **SOP 引导：**
    *   点击“维修指引”，屏幕右侧滑出 Checkbox 列表（步骤1...步骤2...），用户每做完一步需点击勾选，支持拍照上传作为完工证据。

---

### 9.4 特殊组件设计 (UX Components)

#### 9.4.1 证据链胶囊 (Trust Pill)
在 AI 的每一次回答中，关键数据不以纯文本展示，而是封装在胶囊组件中：
*   **外观：** `[ 2850元/吨 | SAP ]`
*   **交互：** 鼠标悬停显示 Tooltip：“数据表：CO_PA_Daily；提取时间：14:30”。
*   **异常态：** 若数据缺失或模型不确定，显示虚线边框胶囊 `[ ? 数据推算中 ]`，并提示“由于 DCS 掉线，此数据基于历史均值估算”。

#### 9.4.2 沙箱模拟器 (Simulation Sandbox) - F4.5
*   **视觉隐喻：** 界面周围出现 **黄色/黑色条纹警示框**，背景水印显示 "SIMULATION MODE"。
*   **操作：** 用户可以随意拉动滑块调整参数（如：大幅降低风量）。
*   **结果：** AI 不会下发指令，而是预测后果：“警告：此操作将在 20分钟后导致炉凉，预计损失产量 500吨。”

#### 9.4.3 纠错反馈栏 (RLHF Loop)
*   每个 AI 回答的右下角不仅有 👍/👎，还有一个 `[ ✏️ 纠错 ]` 按钮。
*   点击纠错，弹出简易表单：“AI 说错了什么？正确的是什么？”
*   这是构建 **Golden Dataset** 的关键入口，设计上要极简，鼓励一线员工点击。

---

### 9.5 交互流程示意图 (User Flow Example)

**异常处理闭环：**

1.  **Push (主动触发)：** AI 监控到库存预警 -> 手机端弹出红色通知 "🚨 铁矿石库存告急"。
2.  **LUI (对话)：** 用户点击通知 -> 进入对话界面 -> AI 给出建议 "建议紧急采购 5000吨，供应商A有现货"。
3.  **Check (核实)：** 用户点击 "供应商A" 胶囊 -> 右侧展开历史供货质量报告 (证据链)。
4.  **Action (决策)：** 用户输入 "按建议生成采购申请" -> AI 生成草案卡片。
5.  **Review (审批)：** 用户点击 [ ✅ 提交 ] -> 流程转入 ERP 审批流 -> 界面反馈 "已发送给采购经理"。

