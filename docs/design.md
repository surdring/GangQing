# GangQing 设计文档

## 1. 概述

### 1.1 项目背景

GangQing（钢擎）是一个钢铁工业全域认知决策系统，旨在解决钢铁厂信息化系统复杂、数据割裂、操作门槛高的问题。系统通过自然语言交互方式，为管理层、生产调度员、设备维修工和财务人员提供统一的数据查询和辅助决策能力。

### 1.2 核心原则

- **安全第一**：数据不出厂、RBAC 权限、审计留痕
- **证据驱动**：所有回答必须可追溯到数据源
- **人机协同**：AI 是副驾驶，人是最终决策者
- **私有化部署**：模型与数据均在内网
- **渐进式演进**：从只读查询到受控写操作

### 1.3 设计目标

- 将跨系统查询时间从小时级降低到秒级
- 固化专家经验，降低对人的依赖
- 在不接触底层控制权的前提下，提供辅助决策
- 建立"可验证—不可验证降级"的可靠输出机制

### 1.4 权威参考文档

- 需求文档：`.kiro/specs/gangqing/requirements.md`
- 产品需求文档：`docs/产品需求.md`
- 技术设计文档：`docs/技术设计文档-最佳实践版.md`
- 对外契约草案：`docs/contracts/api-and-events-draft.md`
- 项目现状分析：`docs/项目现状分析.md`

### 1.5 非目标（本版不覆盖）

- 不规定某一家外部系统（ERP/MES/DCS/LIMS/EAM 等）的字段级接口细节与映射规则细节（由工具与适配层按系统独立文档化）。
- 不在本文中给出任何代码示例或实现片段。
- 不在 L1 阶段引入写操作能力（仅描述 L4 预留的治理框架与门禁）。

### 1.6 范围与分期（L1→L4）

- **L1（最小闭环：只读查询）**
  - 真实 Postgres（造数）+ 只读工具
  - SSE 流式交互
  - 证据链（Evidence）强制与增量更新
  - RBAC + 数据域隔离 + 脱敏
  - 审计落库与 requestId 全链路贯穿
- **L2（诊断/多模态/可观测增强）**
  - 文档库与检索增强（RAG）
  - 并发控制、配额与模型路由
  - OpenTelemetry traces/metrics
  - 移动端弱网/离线与语音降级
- **L3（决策辅助与防护栏增强）**
  - 物理边界/变化率 guardrail 更严格
  - 规程合规检查与红线拦截
  - 事件模型与时间对齐在更多链路落地
- **L4（受控写操作）**
  - 草案→审批/多签→受控执行→回滚→审计全链路
  - HITL 中断/继续、幂等与熔断

### 1.7 关键不变式与强制约束

- **只读默认（Read-Only Default）**：任何不明确或高风险请求必须按只读处理；写操作只能进入 L4 治理流程。
- **证据驱动（Evidence-First）**：任何数值型结论必须可追溯到数据源、时间范围、提取时间；涉及计算必须绑定口径版本；不满足则降级。
- **错误结构化（English Message）**：对外错误响应与 SSE error 事件必须包含稳定 `code` 与英文 `message`，并携带 `requestId`。
- **真实服务测试（No Mock for Integration）**：冒烟/集成测试必须连真实 FastAPI + 真实 Postgres + 真实 llama.cpp；配置缺失或依赖不可用必须失败。

## 2. 系统架构

### 2.1 总体架构

系统采用分层架构设计，从上到下分为：

1. **交互层**：Web/移动端界面
2. **API 网关层**：FastAPI 服务
3. **编排层**：Agent 运行时与意图识别
4. **工具与适配层**：数据库查询工具与外部系统连接器
5. **数据层**：Postgres 数据库
6. **模型推理层**：llama.cpp 本地模型
7. **可观测与审计层**：日志、追踪、指标收集

### 2.2 交互层设计

#### 2.2.1 三栏式布局

- **左侧导航栏**：会话列表、功能导航
- **中间对话区**：用户输入与系统回答的流式展示
- **右侧证据面板（Context Panel）**：证据链可视化展示

#### 2.2.2 通信协议

- 采用 SSE（Server-Sent Events）流式协议
- 支持实时进度反馈和增量内容渲染
- 断线自动重连机制

### 2.3 API 网关层设计

#### 2.3.1 核心职责

- 用户认证与会话管理（JWT token）
- RBAC 权限检查
- SSE 事件编排与流控
- 请求上下文贯穿（requestId 生成与传递）
- 统一错误模型输出

#### 2.3.2 请求处理流程

1. 接收用户请求（携带 sessionId、用户身份、问题文本）
2. 生成 requestId 并创建 SSE 流
3. 调用编排层处理请求
4. 流式输出处理进度和结果
5. 记录审计日志

### 2.4 编排层设计

#### 2.4.1 意图识别

系统支持以下意图类型：

- **QUERY**：只读查询（L1 优先）
- **ANALYZE**：分析与对比（L1/L2）
- **ALERT**：预警与主动推送（L2/L3）
- **ACTION_PREPARE**：生成草案（L4 预留）
- **ACTION_EXECUTE**：执行写操作（L4 严格受控）

#### 2.4.2 策略路由

- **默认只读**：任何不明确的请求一律按 QUERY/ANALYZE 处理
- **高风险意图拦截**：涉及写入、权限提升、绕过审计的请求必须拒绝或进入 HITL
- **模型行为约束**：模型只负责生成计划与解释，不直接执行未授权工具调用

#### 2.4.3 工具选择与调用

- 根据意图和用户权限选择可用工具
- 参数校验与脱敏
- 超时与重试控制
- 证据链构建

### 2.5 工具与适配层设计

#### 2.5.1 工具统一规范

每个工具必须具备：

- 参数 schema 校验（Pydantic 模型）
- 超时与重试策略
- 权限检查（RBAC + 数据域）
- 脱敏（字段级/行级策略）
- 输出证据对象（Evidence Citation + Tool Call Trace）
- 结构化日志与审计字段

#### 2.5.2 L1 Postgres 查询工具

- **只读查询**：仅允许 SELECT，禁止写入
- **查询模板化**：避免模型自由拼接 SQL
- **字段白名单**：按角色限制可查询字段
- **行级安全**：支持多租户/项目隔离

#### 2.5.3 工具扩展机制

- L2+：ERP/MES/DCS/EAM 等系统连接器
- 统一接口规范
- 配置化工具注册

### 2.6 数据层设计

#### 2.6.1 数据模型

**维度表**：
- `dim_equipment`：设备维表（设备ID、名称、产线、关键属性）
- `dim_material`：物料维表（物料ID、名称、类别）

**事实表**：
- `fact_production_daily`：日产量事实表
- `fact_energy_daily`：日能耗事实表
- `fact_cost_daily`：日成本事实表
- `fact_alarm_event`：报警/事件表
- `fact_maintenance_workorder`：维修工单表

**元数据表**：
- `metric_lineage`：指标口径仓库
- `audit_log`：审计日志

#### 2.6.2 造数策略

- **可复现性**：同一版本的种子与脚本生成同样数据
- **场景覆盖**：成本、产量、能耗、故障、维修
- **异常与边界**：缺失值、延迟到达、重复记录、极端波动

### 2.7 模型推理层设计

#### 2.7.1 llama.cpp 接入

- 本地私有化部署
- 统一适配层接入
- 支持模型替换

#### 2.7.2 关键工程点

- **并发控制**：限制并发与队列长度
- **超时策略**：区分模型推理超时与工具调用超时
- **上下文管理**：短上下文优先，预留上下文工程能力
- **输出约束**：强制结构化输出，校验不通过则重试或降级

### 2.8 可观测与审计层设计

#### 2.8.1 审计日志

- 用户查询（query）
- 工具调用（tool_call，参数摘要脱敏）
- 响应结果（response 摘要 + evidence 引用）
- 错误（error code/message/requestId）
- 审批动作与写操作（L4 预留）

#### 2.8.2 可观测性

- **Trace**：http.request、intent.classify、tool.postgres.query、llm.generate、evidence.build
- **Metrics**：请求量、错误率、P95/P99 延迟、工具调用延迟、模型推理延迟
- **日志**：结构化 JSON 日志，包含 requestId 贯穿

### 2.9 配置与密钥管理（强制：配置外部化）

- **配置来源**：所有 URL、端口、超时、重试次数、模型路由策略、配额、开关（如 kill switch）必须外部化（环境变量或配置文件），禁止硬编码。
- **配置校验**：服务启动时必须完成配置完整性与类型校验；关键配置缺失必须快速失败，并在日志中给出英文错误消息（不得泄露密钥）。
- **密钥与凭证**：
  - 模型与数据库凭证仅由服务端持有；前端不得持有高权限凭证。
  - 工具调用凭证按“工具粒度”隔离，遵循最小权限原则。
- **审计与脱敏**：配置与密钥不得写入审计日志；日志中如需记录配置项，只允许记录配置项名称与非敏感摘要。

## 3. 核心功能设计

### 3.1 用户认证与权限管理

#### 3.1.1 用户认证（R1.1）

- JWT token 生成与验证
- token 过期处理
- 异常登录行为检测与审计

#### 3.1.2 RBAC 权限控制（R1.2）

- 角色定义：厂长/高管、生产调度员、设备维修工、财务人员
- 权限矩阵：角色与资源/操作的映射关系
- 权限检查：每次请求前验证用户角色与权限

#### 3.1.3 数据域隔离（R1.3）

- 自动应用数据域过滤
- 跨产线数据访问控制
- 敏感字段脱敏

### 3.2 自然语言查询

#### 3.2.1 查询处理流程（R2.1）

1. 接收用户自然语言输入
2. 意图识别与分类
3. 工具选择与参数提取
4. 工具调用与结果获取
5. 证据链构建
6. 回答生成与流式输出

#### 3.2.2 性能要求

- 简单查询响应时间 < 2秒（P95）
- 复杂分析完成时间 < 30秒（P95）
- 处理超过 5 秒必须输出进度更新

### 3.3 证据链生成

#### 3.3.1 证据链结构（R2.2）

**结论条目（Claims）**：
- 每条关键结论/关键数值成为单独 claim

**数据源引用（Citations）**：
- source_system：数据来源系统
- table_or_report：表/视图/报表名称
- time_range：时间范围
- filters：关键过滤条件（脱敏）
- extracted_at：提取时间

**计算口径（Lineage）**：
- metric_name：指标名称
- lineage_version：口径版本
- formula_id：计算公式ID

**工具调用轨迹（Tool Calls）**：
- toolName：工具名称
- durationMs：执行时长
- status：执行状态
- error：错误信息（如有）

**置信度与不确定项（Confidence / Uncertainty）**：
- confidence：高/中/低
- uncertainties：缺失数据、质量问题、假设条件

#### 3.3.2 证据链约束规则

- 所有数值回答必须可追溯到一个或多个 citations
- 每个 citation 必须包含明确时间范围
- 涉及指标计算必须引用 lineage_version
- 不满足则必须降级并输出 warning 事件

### 3.4 成本分析与对比

#### 3.4.1 成本分析功能（R2.3）

- 成本构成分解
- 时间维度对比（日/周/月）
- 异常波动检测
- 主要差异项识别

#### 3.4.2 可视化展示

- 瀑布图：成本构成对比
- 折线图：成本趋势分析
- 柱状图：成本项对比

### 3.5 流式交互与实时反馈

#### 3.5.1 SSE 事件模型（R6.1）

**统一字段**：
- requestId：链路追踪 ID
- sessionId：会话 ID
- timestamp：事件时间
- type：事件类型
- payload：事件载荷

**事件类型**：
- progress：阶段进度
- message.delta：回答流式增量
- tool.call：工具调用开始
- tool.result：工具结果摘要
- evidence.update：证据链增量更新
- warning：降级/不确定项提示
- error：结构化错误
- final：结束事件

#### 3.5.2 证据链增量更新（R6.2）

- 工具调用时实时输出 evidence.update 事件
- 前端实时渲染到 Context Panel
- 回答完成时证据链完整且可追溯

#### 3.5.3 错误流式处理（R6.3）

- 遇到错误立即输出 error 事件
- 包含 code、message、requestId、retryable
- 可恢复错误尝试降级或重试
- 不可恢复错误输出 final 事件并终止流

### 3.6 只读默认与受控操作

#### 3.6.1 只读默认策略（R5.1）

- 系统默认只提供建议，不执行写操作
- 识别出写操作意图时明确告知并提示需要审批
- 用户没有写操作权限时返回 FORBIDDEN 错误
- 不确定是否为写操作时按只读处理

#### 3.6.2 写操作草案生成（R5.2，L4 预留）

- 生成可编辑的草案
- 列出约束条件、目标函数、预期效果
- 包含甘特图或时序对比图
- 标注冲突并给出调整建议

#### 3.6.3 审批与多签（R5.3，L4 预留）

- 根据变更类型路由到相应审批人
- 涉及工艺红线必须工艺员确认
- 涉及安全连锁必须安全员确认
- 记录拒绝原因并通知提交人

#### 3.6.4 受控执行与回滚（R5.4，L4 预留）

- 通过安全网关执行写操作
- 执行前创建回滚点
- 执行过程中出现异常自动回滚或进入熔断状态
- 支持一键回滚到上一个确认版本

### 3.7 设备诊疗专家（Maintenance Expert，L2）

对应需求：R3.1（多模态诊断）、R3.2（维修方案推荐）、R3.3（设备历史查询）。

- **多模态输入边界**：图片/音频等输入必须与系统指令逻辑隔离；任何外部内容作为检索/上下文输入时必须执行间接注入防护与脱敏策略。
- **诊断输出约束**：
  - 必须包含置信度与备选诊断；低置信度必须建议人工复核。
  - 推荐维修方案必须绑定来源（历史工单/手册条款/故障库片段）与证据链引用。
- **设备历史查询**：统一实体 ID 映射后才能跨系统聚合；映射缺失/冲突必须返回 `EVIDENCE_MISMATCH`。

### 3.8 生产工艺智库（Process Knowledge Base，L2/L3）

对应需求：R4.1（工艺参数优化建议）、R4.2（规程合规检查）、R4.3（工艺知识检索）。

- **规程合规检查（强制）**：
  - 对“违反红线”的请求必须拦截，输出 `GUARDRAIL_BLOCKED`，并在证据链中记录命中规则 ID 与原因摘要（不含敏感细节）。
  - 对“接近红线”的请求输出 `warning` 事件，提示风险与规程引用。
- **建议类结论证据要求**：建议必须附带至少 1 条可追溯引用；检索不到证据必须明确声明并建议转人工或补充资料。

### 3.9 编排引擎（Orchestration Engine，L1 起）

对应需求：R15.1（意图识别与任务路由）、R15.3（工具链注册与 Function Calling）、R15.4（预算/配额/路由）、R15.5（纠错反馈闭环）。

- **意图识别输出**：必须产出意图类别与置信度；意图不明确时必须发起澄清，不得猜测执行。
- **工具调用门禁**：
  - 可用工具集合由“角色 + 意图 + 数据域”三重约束决定。
  - 工具参数必须在服务端校验；工具输出必须进行契约校验与脱敏。
- **配额与路由**：超出预算/配额时必须返回 `FORBIDDEN` 或 `SERVICE_UNAVAILABLE`，并输出可执行的降级建议。
- **纠错闭环**：反馈必须绑定 `requestId`，并引用证据链；缺少依据的纠错必须标注为未验证并要求补充。

### 3.10 LLMOps 评估与防护栏（Guardrails）

对应需求：R17.1（Golden Dataset 回归与发布门禁）、R17.2（高风险意图拦截）、R17.3（物理约束一致性校验）。

- **发布门禁**：模型/Prompt/工具链变更必须触发 Golden Dataset 回归；核心指标下降必须阻止发布并产出差异清单与版本证据。
- **高风险拦截**：越权/敏感查询必须返回 `FORBIDDEN` 并记录审计；写操作倾向必须返回 `GUARDRAIL_BLOCKED` 并提示进入审批。
- **关键数值一致性校验**：关键数值必须具备数据源与合理区间支持；越界/变化率异常必须阻断或降级为“仅展示数据与来源”。

### 3.11 现场环境适应性（L2）

对应需求：R18.1（抗噪语音交互与自动降级）、R18.2（弱网与离线缓存）。

- **语音降级**：置信度低于阈值必须自动降级为文字输入，并记录审计与可观测日志（不得记录原始音频）。
- **弱网策略**：SSE 断线需明确提示与可恢复重连策略；离线模式必须标注“offline data”并限制可用范围。

## 4. 安全设计

### 4.1 威胁模型

- **直接提示词注入**：诱导泄露系统指令、绕过规则
- **间接注入**：来自知识库/文件的恶意指令（L2+ 重点）
- **数据外泄**：批量导出敏感数据、Embedding/检索泄露
- **过度代理**：未授权的工具/写操作调用

### 4.2 安全防线

#### 4.2.1 提示词注入防护（R10.1）

- 结构化输入分区：系统指令/用户输入/工具结果/外部内容逻辑隔离
- 识别注入特征并拒绝
- 检测到注入尝试记录审计日志
- 注入成功绕过触发告警

#### 4.2.2 敏感信息脱敏（R10.2）

- 按角色配置字段级脱敏
- 审计日志中脱敏参数中的敏感信息
- 前端证据链展示默认脱敏
- 有权限用户可展开查看原始数据

#### 4.2.3 输出安全校验（R10.3）

- 检查是否包含系统提示词特征
- 检测到敏感信息过滤或脱敏
- 输出异常长截断并记录告警
- 输出包含恶意内容拒绝输出并记录

#### 4.2.4 工具调用白名单

- 按意图与角色控制可用工具
- 参数级校验
- 输出过滤/校验

#### 4.2.5 HITL（人在回路）

- 对高风险意图或写操作必须进入审批（L4）
- 支持中断/继续与持久化执行

### 4.3 私有化部署

- 模型与数据均在内网
- 外网访问需物理隔离网关
- 本地部署 llama.cpp 模型
- 本地 Postgres 数据库

### 4.4 数据域隔离与脱敏落地（强制）

- **数据域隔离**：任何工具查询必须默认叠加数据域过滤；检测到跨域访问时必须返回 `AUTH_ERROR` 或 `FORBIDDEN`（按接口契约约定），并写入审计。
- **脱敏策略**：按角色执行字段级脱敏；前端证据链展示默认脱敏，仅在具备权限时可展开查看原始数据。
- **批量导出限制**：对大批量敏感数据导出倾向应触发策略拦截与审计，并可按配置启用更严格的速率限制。

## 5. 数据质量与准确性

### 5.1 关键数值不可幻觉

#### 5.1.1 数值类回答约束

- 必须绑定数据源、时间范围、口径版本
- 必须可追溯到一个或多个 citations
- 涉及指标计算必须引用 lineage_version

#### 5.1.2 不可验证降级

- 缺少关键数据时不允许生成确定性数值
- 必须输出不确定项并提示补齐数据
- 输出 warning 事件
- 最终回答中以"不确定/需要补齐数据"表达

#### 5.1.3 一致性校验（L3+ 强制）

- 关键指标/关键物理量有合理区间与变化率边界
- 检测到越界或变化率异常返回 GUARDRAIL_BLOCKED 或降级
- 在证据链中记录触发规则与阈值版本

### 5.2 指标口径仓库（R7.3）

- 记录指标名、版本、计算公式、数据源、责任人
- 指标变更创建新版本并保留历史版本
- 系统计算指标必须引用指标口径版本
- 指标口径不一致拒绝计算并提示

### 5.3 实体与 ID 映射（R16.1）

- 建立统一实体ID（设备/物料/炉次/订单）
- 跨系统查询基于统一ID聚合
- 映射缺失或冲突返回 EVIDENCE_MISMATCH
- 映射变更版本化记录并可追溯

### 5.4 事件模型与时间对齐（R16.2）

- 基于事件模型进行窗口/锚点对齐
- 证据链展示对齐规则、锚点事件与时间窗口
- 对齐失败或缺少事件返回 EVIDENCE_MISSING 或输出 warning 事件
- 新增事件类型保持向后兼容并可追溯版本

### 5.5 数据质量评估前置（R16.3）

- 计算并记录数据质量等级（缺失/漂移/异常/延迟）
- 数据质量低于阈值拒绝给出确定性数值结论并提示原因
- 证据链展示数据质量等级与计算时间
- 检测到疑似造假/异常尖峰触发告警并记录审计

### 5.6 数据一致性拒答策略（强制）

- 当同一指标存在多口径且无法确定口径版本时，必须拒绝输出确定性结论，并提示需要指定口径或补齐口径仓库条目。
- 当关键输入数据存在冲突（例如同一时间窗出现互斥记录）且无法裁决时，必须降级为“展示冲突数据与来源”，不得编造“正确值”。

## 6. 错误处理

### 6.1 统一错误模型

对外错误必须结构化并可被前端解析：

- **code**：稳定错误码
- **message**：英文错误描述
- **details**：结构化上下文（禁止敏感信息）
- **retryable**：是否可重试
- **requestId**：链路追踪 ID

### 6.2 错误码清单

- `VALIDATION_ERROR`：参数校验失败
- `AUTH_ERROR`：认证失败
- `FORBIDDEN`：权限不足
- `NOT_FOUND`：资源不存在
- `UPSTREAM_TIMEOUT`：上游服务超时
- `UPSTREAM_UNAVAILABLE`：上游服务不可用
- `CONTRACT_VIOLATION`：契约违反
- `GUARDRAIL_BLOCKED`：防护栏拦截
- `EVIDENCE_MISSING`：证据链缺失
- `EVIDENCE_MISMATCH`：证据链不匹配
- `SERVICE_UNAVAILABLE`：服务不可用

### 6.3 错误处理策略

- 上游不可用返回结构化错误
- 可恢复错误尝试降级或重试
- 不可恢复错误输出 final 事件并终止流
- 所有错误记录审计日志

### 6.4 SSE 错误输出规则（强制）

- 发生错误必须尽快输出 `error` 事件，内容为结构化错误模型（含 `code`、英文 `message`、`requestId`、`retryable`）。
- 对不可恢复错误：必须在 `error` 后输出 `final` 并终止流。
- 对可恢复错误：可以重试或降级，但必须输出 `warning` 或 `progress` 描述降级/重试阶段，并在审计中记录重试次数与最终结果。

## 7. 测试策略

### 7.1 单元测试

覆盖重点：

- 证据链组装规则（数值必须有 citation 与时间范围）
- 错误模型映射（英文 message + 稳定 code）
- RBAC 拦截（越权请求必须失败并审计）
- SSE 事件序列化契约（事件类型与字段完整性）

### 7.2 冒烟测试

必须使用真实服务：

- 启动真实 FastAPI 服务
- 使用真实 Postgres 实例（包含造数数据）
- 使用真实 llama.cpp 推理服务

验证链路：

- 成本查询成功链路（SSE 流式输出 + evidence.update）
- 权限不足/上游超时失败链路（结构化 error 事件）

### 7.3 集成测试

- 端到端用户流程测试
- 跨模块集成点测试
- 真实服务集成测试（禁止 mock）

### 7.4 契约测试

- 前端 Zod schema 校验
- 后端 Pydantic 模型校验
- SSE 事件契约校验

### 7.5 测试强制约束（与验收绑定）

- **禁止跳过**：不得使用任何形式的跳过策略（如条件跳过/标记跳过）。配置缺失或真实服务不可用必须导致测试失败，并输出清晰英文错误。
- **真实依赖**：冒烟/集成测试必须使用真实依赖；单元测试允许通过依赖注入传入“具备真实错误行为”的测试实现，但不得用 mock 掩盖真实失败模式。

## 8. 实施路线图

### 8.1 Phase 1：全知查询员（L1 / MVP）

**目标**：打通核心报表，实现"一句话查数据"，上线证据链

**包含需求**：
- R1.1 用户认证
- R1.2 基于角色的访问控制
- R1.3 数据域隔离
- R2.1 自然语言查询
- R2.2 证据链生成
- R2.3 成本分析与对比
- R5.1 只读默认
- R6.1 SSE 流式输出
- R6.2 证据链增量更新
- R6.3 错误流式处理
- R7.1 Postgres 数据库设计
- R7.2 造数脚本
- R7.3 指标口径仓库
- R8.1 Postgres 查询工具
- R8.2 工具参数校验
- R8.3 工具超时与重试
- R9.1 llama.cpp 接入
- R9.3 输出结构化校验
- R10.1 提示词注入防护
- R10.2 敏感信息脱敏
- R10.3 输出安全校验
- R11.1 审计日志记录
- R11.2 审计日志不可篡改
- R11.3 结构化日志
- R12.3 健康检查
- R13.1 三栏式布局
- R13.2 SSE 流式渲染
- R13.3 证据链可视化
- R14.1 性能要求
- R14.3 数据一致性
- R14.4 幻觉检测与降级
- R14.5 私有化部署
- R15.1 意图识别与任务路由
- R15.3 工具链注册与 Function Calling
- R16.1 实体与 ID 映射
- R16.2 事件模型与时间对齐
- R16.3 数据质量评估前置
- R17.2 高风险意图识别与策略化拦截
- R17.3 物理约束与关键数值一致性校验

**验收指标**：
- 跨系统查询耗时 P95 < 10秒
- 关键指标回答准确率 >= 99%
- 审计日志覆盖率 100%
- SSE 联调成功，前端可实时渲染
- 数值回答可追溯，证据链完整

**预计工期**：8-12 周

### 8.2 Phase 2：维修副驾驶（L2）

**目标**：接入设备文档与故障库，实现多模态诊断辅助

**包含需求**：
- R2.4 异常主动推送
- R2.5 智能交接班
- R3.1 多模态故障诊断
- R3.2 维修方案推荐
- R3.3 设备历史查询
- R4.3 工艺知识检索
- R9.2 并发控制
- R12.1 OpenTelemetry 集成
- R12.2 性能指标收集
- R13.4 图表动态生成
- R13.5 移动端适配
- R14.2 可用性要求
- R15.2 RAG 检索增强
- R15.4 Token 预算、配额与模型路由
- R15.5 纠错反馈闭环
- R17.1 Golden Dataset 回归与发布门禁
- R18.1 抗噪语音交互与自动降级
- R18.2 弱网与离线缓存

**验收指标**：
- 常见故障 Top20 覆盖
- MTTR 下降可量化
- 建议引用来源覆盖率 100%
- 移动端可用性 >= 99%

**预计工期**：6-8 周

### 8.3 Phase 3：生产决策辅助（L3）

**目标**：接入 DCS 实时数据，提供工艺参数优化建议

**包含需求**：
- R4.1 工艺参数优化建议
- R4.2 规程合规检查

**验收指标**：
- 在离线回放/沙箱仿真中达到既定节能或质量波动下降目标
- 建议具备约束清单与证据链
- 规程合规检查准确率 >= 95%

**预计工期**：8-10 周

### 8.4 Phase 4：受控闭环（L4 / 可选）

**目标**：支持有限域的写操作，并具备多签、回滚、熔断

**包含需求**：
- R5.2 写操作草案生成
- R5.3 审批与多签
- R5.4 受控执行与回滚
- R5.5 模拟仿真与培训
- R16.4 知识图谱增强

**验收前置条件**：
- 权限体系与审计完善
- 安全网关与沙箱仿真通过
- 试点产线/设备范围明确

**验收指标**：
- 写操作审批流程完整
- 回滚成功率 100%
- 沙箱模拟准确率 >= 90%

**预计工期**：10-12 周

## 9. 风险与控制

### 9.1 风险矩阵

| 风险点 | 描述 | 影响 | 概率 | 控制措施 |
|--------|------|------|------|----------|
| 模型幻觉 | Agent 编造工艺参数或虚假报警 | 高 | 中 | 引入 RAG 机制；强制附带参考来源；关键参数需人工二次核实 |
| 误操作 | Agent 错误调用写接口导致停产 | 高 | 低 | 只读默认；写操作必须经过草案→审批→受控执行；具备回滚与熔断 |
| 数据泄露 | 敏感配方泄露 | 高 | 低 | 私有化部署；敏感词过滤；审计日志记录 |
| 口径不一致 | 同一指标不同部门口径不同 | 中 | 高 | 建立指标口径仓库；版本化管理；强制引用口径版本 |
| 时间对齐错误 | OT时序与MES事件错配 | 中 | 中 | 引入事件模型与时间对齐策略；在证据链中展示对齐规则 |
| 算力成本失控 | 私有化大模型推理成本高 | 中 | 中 | Token预算与配额管理；简单查询路由到小模型；高频问题做缓存 |
| 过度依赖 | 一线员工丧失独立判断能力 | 中 | 中 | 设置培训与考核机制；定期盲测/演练；关键建议强制确认 |
| 性能瓶颈 | 并发请求导致系统过载 | 中 | 中 | 并发控制；队列管理；降级策略 |
| 依赖服务不可用 | Postgres/llama.cpp 不可用 | 高 | 低 | 健康检查；降级处理；告警机制 |

## 10. 成功指标

### 10.1 经营侧 KPI

- 吨钢成本：可查询、可追溯、可对比
- 吨钢能耗：实时监控、异常告警
- 批次毛利：自动计算、口径统一
- 订单准交率：实时跟踪
- 库存周转天数：趋势分析

### 10.2 生产侧 KPI

- 良品率/降级率：实时监控、异常告警
- 关键工序节拍偏差：自动检测
- 异常处置时长：缩短 30%

### 10.3 设备侧 KPI

- 非计划停机时长：减少 20%
- MTTR：缩短 25%
- MTBF：提升 15%
- 缺件导致的停机次数：减少 40%

### 10.4 系统侧 KPI

- 查询响应时间：P95 < 10秒
- 系统可用性：>= 99.9%
- 审计覆盖率：100%
- 数值回答准确率：>= 99%
- 证据链完整率：100%

## 11. 技术栈

### 11.1 后端技术栈

- **Web 框架**：FastAPI
- **数据库**：PostgreSQL
- **模型推理**：llama.cpp（本地部署）
- **数据校验**：Pydantic
- **日志**：结构化 JSON 日志
- **可观测性**：OpenTelemetry（建议）

### 11.2 前端技术栈

- **框架**：React
- **构建工具**：Vite
- **语言**：TypeScript（Strict 模式）
- **数据校验**：Zod
- **状态管理**：React Hooks
- **UI 组件**：自定义组件（三栏式布局、Trust Pill、Context Panel）

### 11.3 通信协议

- **API**：REST
- **流式输出**：SSE（Server-Sent Events）
- **认证**：JWT token

## 12. 部署架构

### 12.1 部署模式

- **私有化部署**：所有组件部署在内网
- **物理隔离**：外网访问需通过物理隔离网关
- **高可用**：支持多实例部署（L2+）

### 12.2 组件部署

- **Web 前端**：静态文件部署（Nginx）
- **API 网关**：FastAPI 服务（Gunicorn/Uvicorn）
- **数据库**：PostgreSQL（主从复制，L2+）
- **模型推理**：llama.cpp 服务（本地部署）
- **可观测性**：日志收集、追踪、指标收集（L2+）

### 12.3 网络架构

- **内网隔离**：模型与数据均在内网
- **访问控制**：基于 RBAC 的访问控制
- **审计日志**：所有操作记录审计日志

## 13. 数据流设计

### 13.1 L1 只读查询数据流

1. 前端发起对话请求（携带 sessionId、用户身份、问题文本）
2. 后端生成 requestId 并创建 SSE 流
3. 编排层完成：
   - 意图识别
   - 工具调用（Postgres）
   - 结果整理
   - 证据链组装
   - 生成回答
4. 过程中逐步输出 SSE 事件：
   - progress：阶段进度
   - tool_call：工具调用开始
   - tool_result：工具结果摘要
   - message.delta：回答流式增量
   - evidence.update：证据链增量更新
5. 结束输出 final 事件
6. 落库审计（查询、工具调用、响应摘要）

### 13.2 L4 受控写操作数据流（预留）

1. 用户请求写操作
2. 系统识别写操作意图
3. 生成草案（prepare）
4. 路由到审批人（approve）
5. 审批通过后受控执行（execute）
6. 创建回滚点（rollback point）
7. 记录审计日志
8. 返回执行结果

## 14. 扩展性设计

### 14.1 工具扩展

- 统一工具接口规范
- 配置化工具注册
- 支持 ERP/MES/DCS/EAM 等系统连接器

### 14.2 模型扩展

- 统一模型适配层
- 支持模型替换
- 支持多模型路由（SLM/LLM）

### 14.3 数据源扩展

- 统一数据源接口
- 支持多数据源聚合
- 支持知识库/文档库（RAG）

## 15. 术语表

- **SSE**：Server-Sent Events，服务端推送事件
- **Evidence**：证据链，包含数据源、时间范围、计算口径等
- **HITL**：Human-in-the-loop，人在回路
- **RBAC**：Role-based access control，基于角色的访问控制
- **Lineage**：指标口径版本与血缘
- **RAG**：Retrieval-Augmented Generation，检索增强生成
- **MTTR**：Mean Time To Repair，平均修复时间
- **MTBF**：Mean Time Between Failures，平均故障间隔时间
- **Trust Pill**：证据链胶囊，用于展示数据来源的 UI 组件
- **Context Panel**：证据面板，用于展示证据链的 UI 组件
- **Guardrail**：防护栏，用于拦截高风险操作的安全机制

## 16. 参考文档

- 需求文档：`.kiro/specs/gangqing/requirements.md`
- 技术设计文档：`docs/技术设计文档-最佳实践版.md`
- 产品需求文档：`docs/产品需求.md`
- 对外契约草案：`docs/contracts/api-and-events-draft.md`
- 项目现状分析：`docs/项目现状分析.md`
- 编码规范：`docs/coding-standards.md`
- 全局编码规范：`docs/全局编码规范.md`
- RBAC 矩阵：`docs/security/rbac-matrix.md`
- 防护栏与熔断开关：`docs/security/guardrails-and-kill-switch.md`
- 审计日志规范：`docs/security/audit-logging-spec.md`
- 数据脱敏策略：`docs/security/data-masking-policy.md`
- 需求追溯矩阵：`docs/rtm/requirements-traceability-matrix.md`
- 里程碑验收清单：`docs/acceptance/milestone-acceptance-checklist.md`
- 验收证据包：`docs/acceptance/acceptance-evidence-pack.md`

## 17. 附录：设计决策记录

### 17.1 为什么选择 SSE 而不是 WebSocket？

- SSE 更适合"服务端单向流式输出"，与 L1-L3 的对话与过程解释匹配
- 易于穿透企业网络与网关
- 易于在浏览器端实现
- 支持自动重连
- HTTP/2 下性能优异

### 17.2 为什么选择 Postgres 而不是其他数据库？

- 成熟稳定，企业级支持
- 支持复杂查询与分析
- 支持 JSON 类型（证据链存储）
- 支持行级安全（RLS）
- 支持向量索引（L2+ RAG）

### 17.3 为什么选择 llama.cpp 而不是其他推理引擎？

- 本地部署，满足"数据不出厂"
- 性能优异，支持量化
- 易于集成
- 社区活跃

### 17.4 为什么采用"只读默认"策略？

- 防止误操作导致停产
- 符合"安全第一"原则
- 为 L4 受控写操作预留扩展空间
- 降低系统风险

### 17.5 为什么强制要求证据链？

- 防止模型幻觉
- 提供可审计、可复盘、可解释的依据
- 符合"证据驱动"原则
- 提升用户信任度

### 17.6 需求 → 设计要点 → 验收证据（对照表）

| 需求ID | 需求摘要 | 设计要点（本文落点） | 验收证据（可自动化/可审计） |
|---|---|---|---|
| R1.1 | 用户认证（JWT） | `3.1.1`；`2.3.1`（网关职责） | REST 登录成功/失败用例；失败返回结构化错误（含 `requestId`）；审计记录“登录/失败”事件（若纳入审计范围） |
| R1.2 | RBAC 权限控制 | `3.1.2`；`2.5.1`（工具门禁）；`4.4`（数据域与脱敏落地） | 越权访问返回 `FORBIDDEN`；审计记录包含 `userId/role/requestId` 与拒绝原因摘要；冒烟测试覆盖“越权失败链路” |
| R1.3 | 数据域隔离 | `3.1.3`；`4.4` | 跨域访问被过滤或拒绝（按契约）；审计中记录命中数据域策略；证据链引用仅来自允许域 |
| R2.1 | 自然语言查询 | `3.2.1`；`13.1` 数据流；`3.9` 意图识别与工具调用门禁 | 冒烟测试覆盖“成本/产量等查询成功链路”；SSE 事件序列完整（`progress`→`tool.call`→`tool.result`→`message.delta`→`final`） |
| R2.2 | 证据链生成（强制） | `3.3`；`5.1`；`5.6`；`13.1` | 单元测试覆盖“数值必须绑定 citation+time_range+lineage_version”；SSE 输出 `evidence.update`；最终回答可在 Context Panel 展开证据 |
| R2.3 | 成本分析与对比 | `3.4`；`5.2`（口径仓库） | 端到端链路返回成本构成与差异项；证据链包含指标口径版本；异常波动触发 `warning`（如适用） |
| R5.1 | 只读默认（Read-Only Default） | `1.7`；`3.6.1`；`3.9`（策略路由）；`17.4` | 请求包含写入倾向时不执行写操作；返回 `GUARDRAIL_BLOCKED` 或进入审批提示（按阶段）；审计记录拦截规则 ID 与原因摘要 |
| R6.1 | SSE 流式输出 | `3.5.1`；`13.1` | 处理超过阈值持续输出 `progress`；前端可流式渲染 `message.delta`；断连可恢复策略可验证 |
| R6.2 | 证据链增量更新 | `3.5.2`；`3.3` | 工具调用后持续输出 `evidence.update`；最终证据链完整且可追溯 |
| R6.3 | 错误流式处理 | `3.5.3`；`6.4` | SSE 发生错误时立即输出 `error`（含 `code/message/requestId/retryable`），不可恢复错误后必须 `final`；审计记录错误码与阶段 |
| R7.1 | Postgres 数据库设计 | `2.6.1` | 数据库初始化后核心表/索引可用；查询 P95 性能符合 `3.2.2`/`R14.1` 指标 |
| R7.2 | 造数脚本 | `2.6.2` | 数据可复现（同种子同数据）；覆盖异常/边界数据用于验证降级与 guardrail；冒烟测试依赖该数据集 |
| R7.3 | 指标口径仓库 | `5.2`；`3.3` | 指标计算必须携带 `lineage_version`；口径不一致/缺失时拒答或降级（`5.6`） |
| R8.1 | Postgres 查询工具（只读） | `2.5.2`；`2.5.1` | 仅允许只读查询；所有查询自动叠加 RBAC/数据域；超时映射 `UPSTREAM_TIMEOUT`；工具调用产出证据对象 |
| R8.2 | 工具参数校验 | `2.5.1`；`3.9` | 参数无效返回 `VALIDATION_ERROR`；审计中参数摘要脱敏；契约测试校验工具输入/输出 schema |
| R8.3 | 工具超时与重试 | `2.5.1`；`6.3`；`6.4` | 可重试错误记录重试次数；超时返回 `UPSTREAM_TIMEOUT` 且 `retryable=true`（按策略）；SSE 过程有进度/告警事件 |
| R9.1 | llama.cpp 接入 | `2.7.1` | 健康检查可区分模型不可用（`UPSTREAM_UNAVAILABLE`）；推理超时可观测；冒烟测试使用真实 llama.cpp |
| R9.3 | 输出结构化校验 | `2.7.2`；`6.1`（错误模型） | 输出不符合结构时重试或返回 `CONTRACT_VIOLATION`；审计记录“校验失败”阶段与最终处理结果 |
| R10.1 | 提示词注入防护 | `4.2.1`；`4.1` | 检测到注入返回结构化错误或拦截；审计记录注入尝试事件（不含敏感原文） |
| R10.2 | 敏感信息脱敏 | `4.2.2`；`4.4` | 对外输出与证据链默认脱敏；具备权限才可展开；审计日志参数摘要脱敏 |
| R10.3 | 输出安全校验 | `4.2.3` | 输出包含系统提示词/敏感信息特征时过滤或拒绝；审计记录触发原因摘要 |
| R11.1 | 审计日志记录 | `2.8.1`；`6.3`；`13.1` | 每次请求均落库审计（覆盖 query/tool_call/response 摘要/error）；审计可按 `requestId` 追溯全链路 |
| R11.2 | 审计日志不可篡改 | `2.8.1` | 审计存储与权限采用 append-only 与访问控制；查询审计日志本身也要被审计（按规范） |
| R11.3 | 结构化日志 | `2.8.2`；`2.3.1`（requestId 贯穿） | 结构化日志包含 `requestId/sessionId/toolName/status/errorCode`；可通过日志聚合定位失败阶段 |
| R12.3 | 健康检查 | `3.2.2`（可靠性约束引用） | 健康检查返回依赖状态（Postgres/llama.cpp 等）；不可用时标记 degraded/unhealthy 并触发告警（如配置） |
| R14.1 | 性能要求（P95） | `3.2.2`；`2.8.2`（metrics） | 指标采集含 P50/P95/P99；冒烟/压测脚本（如存在）产出可审计结果；SSE 超过阈值必须有 `progress` |
| R14.3 | 数据一致性 | `5.6`；`3.3.2` | 数据不一致时拒答或降级为展示冲突与来源；证据链标注不确定项 |
| R14.4 | 幻觉检测与降级 | `5.1`；`3.10`；`5.6` | 关键数值缺少证据时不输出确定值；触发 `warning` 并在证据链记录原因；必要时返回 `GUARDRAIL_BLOCKED` |
| R14.5 | 私有化部署 | `4.3`；`12` | 部署清单证明模型与数据在内网；外网访问受物理隔离策略约束；审计与日志在内网留存 |
| R15.1 | 意图识别与任务路由 | `2.4.1`；`3.9` | 意图不明确必须澄清；写操作倾向必须被策略拦截；审计记录 intent 与路由结果 |
| R15.3 | 工具链注册与 Function Calling | `2.5.3`；`3.9` | 工具调用必须产出 `tool.call/tool.result` 事件与证据对象；契约违规返回 `CONTRACT_VIOLATION` |
| R16.1 | 实体与 ID 映射 | `5.3` | 跨系统聚合基于统一 ID；映射缺失/冲突返回 `EVIDENCE_MISMATCH` 并可追溯版本 |
| R16.2 | 事件模型与时间对齐 | `5.4` | 证据链必须展示对齐规则与锚点事件；对齐失败返回 `EVIDENCE_MISSING` 或输出 `warning` |
| R16.3 | 数据质量评估前置 | `5.5` | 关键数据读取时记录质量等级；质量低拒绝输出确定性结论并提示原因；审计记录质量评估结果摘要 |
| R17.2 | 高风险意图识别与拦截 | `3.10`；`4.1`；`4.2` | 越权/敏感查询返回 `FORBIDDEN`；写操作倾向返回 `GUARDRAIL_BLOCKED`；证据链记录规则 ID 与命中原因摘要 |
| R17.3 | 物理约束与一致性校验 | `3.10`；`5.1.3` | 关键数值越界/变化率异常触发阻断或降级；证据链记录阈值版本；审计记录触发原因 |

## 18. 变更历史

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| 1.0 | 2025-01-XX | 初始版本 | - |

---

**文档状态**：草稿
**最后更新**：2025-01-XX
**审核状态**：待审核

