# GangQing 任务开发顺序指南

## 文档说明

本文档基于以下三个核心文档生成：
- `docs/requirements.md`：需求文档（定义了 R1.1-R18.2 共 60+ 个功能需求）
- `docs/design.md`：设计文档（定义了系统架构、核心功能设计、安全设计等）
- `docs/tasks.md`：任务清单（定义了 L1-L4 共 56 个实施任务）

本文档按照依赖关系、优先级和技术风险，将任务重新组织为合理的开发顺序，帮助团队高效推进项目。

## 开发原则

1. **依赖优先**：先完成被依赖的基础设施，再构建上层功能
2. **风险前置**：技术风险高的任务尽早验证
3. **价值驱动**：优先实现核心价值链路，快速验证可行性
4. **增量交付**：每个阶段都能产出可演示的功能
5. **测试驱动**：每个任务完成后必须通过单元测试和冒烟测试

## L1 阶段：最小闭环（只读查询 + SSE + 证据链 + 安全与审计）

### 第一批：基础设施层（Week 1-2）

**目标**：建立项目骨架、数据基础和契约规范

#### 1.1 建立项目级对外契约基线（任务 1）
- **优先级**：P0（最高）
- **依赖**：无
- **产物**：
  - `docs/contracts/api-and-events-draft.md`（SSE 事件、错误码、Evidence schema）
  - `docs/api/openapi.yaml`（对话入口、错误响应、SSE 说明）
- **验证**：契约文档完整性检查
- **关联需求**：R6.1, R6.2, R6.3, R2.2
- **为什么第一**：契约是所有模块的接口规范，必须最先定义

#### 1.2 设计并落地 Postgres 最小数据模型（任务 5）
- **优先级**：P0
- **依赖**：无
- **产物**：数据库迁移脚本、表结构、索引
- **验证**：`backend/scripts/postgres_schema_smoke_test.py`
- **关联需求**：R7.1
- **为什么第二**：数据层是所有查询的基础

#### 1.3 实现可复现造数脚本（任务 6）
- **优先级**：P0
- **依赖**：任务 5
- **产物**：造数脚本、测试数据集
- **验证**：`backend/scripts/seed_data_smoke_test.py`
- **关联需求**：R7.2
- **为什么第三**：测试数据是开发和测试的基础

#### 1.4 指标口径仓库（任务 7）
- **优先级**：P0
- **依赖**：任务 5
- **产物**：口径仓库表、版本管理机制
- **验证**：`backend/scripts/metric_lineage_smoke_test.py`
- **关联需求**：R7.3
- **为什么第四**：口径仓库是证据链的核心组件

### 第二批：后端核心层（Week 2-3）

**目标**：建立后端服务骨架、认证授权和基础工具

#### 2.1 建立后端工程骨架（任务 2）
- **优先级**：P0
- **依赖**：任务 1
- **产物**：FastAPI 应用骨架、路由分层、结构化日志
- **验证**：`python -m compileall backend && python backend/scripts/start_server_and_healthcheck.py`
- **关联需求**：设计文档 2.3, 2.8
- **为什么第五**：后端骨架是所有后端功能的基础

#### 2.2 建立认证与权限（任务 3）
- **优先级**：P0
- **依赖**：任务 2
- **产物**：JWT 登录、RBAC 中间件
- **验证**：`backend/scripts/auth_smoke_test.py`
- **关联需求**：R1.1, R1.2
- **为什么第六**：认证是所有受保护接口的前置条件

#### 2.3 落地数据域隔离与脱敏策略（任务 4）
- **优先级**：P0
- **依赖**：任务 3
- **产物**：数据域过滤、字段脱敏规则
- **验证**：`backend/scripts/rbac_and_masking_smoke_test.py`
- **关联需求**：R1.3, R10.2
- **为什么第七**：数据安全是工具层的前置条件

#### 2.4 健康检查与运行态自检（任务 18）
- **优先级**：P0
- **依赖**：任务 2
- **产物**：健康检查端点、依赖状态监控
- **验证**：`python backend/scripts/start_server_and_healthcheck.py`
- **关联需求**：R12.3
- **为什么第八**：健康检查是运维的基础

### 第三批：工具层与模型层（Week 3-4）

**目标**：实现数据查询工具和模型推理能力

#### 3.1 实现 Postgres 只读查询工具（任务 8）
- **优先级**：P0
- **依赖**：任务 4, 任务 5, 任务 6
- **产物**：只读查询工具、证据对象输出
- **验证**：`backend/scripts/postgres_tool_smoke_test.py`
- **关联需求**：R8.1
- **为什么第九**：查询工具是核心功能的基础

#### 3.2 工具参数 schema 校验与契约校验（任务 9）
- **优先级**：P0
- **依赖**：任务 8
- **产物**：Pydantic 模型校验、契约测试
- **验证**：`backend/scripts/contract_validation_smoke_test.py`
- **关联需求**：R8.2, R9.3
- **为什么第十**：参数校验是工具安全的保障

#### 3.3 工具超时与重试策略（任务 10）
- **优先级**：P1
- **依赖**：任务 8
- **产物**：超时控制、重试机制
- **验证**：`backend/scripts/tool_timeout_retry_smoke_test.py`
- **关联需求**：R8.3
- **为什么第十一**：超时重试是系统可靠性的保障

#### 3.4 接入 llama.cpp 推理服务（任务 11）
- **优先级**：P0
- **依赖**：任务 2
- **产物**：llama.cpp 适配层、错误映射
- **验证**：`backend/scripts/llamacpp_smoke_test.py`
- **关联需求**：R9.1
- **为什么第十二**：模型推理是 AI 能力的核心

### 第四批：编排层与证据链（Week 4-5）

**目标**：实现意图识别、工具编排和证据链生成

#### 4.1 实现意图识别与策略路由（任务 12）
- **优先级**：P0
- **依赖**：任务 11
- **产物**：意图分类器、策略路由
- **验证**：`backend/scripts/intent_routing_smoke_test.py`
- **关联需求**：R15.1
- **为什么第十三**：意图识别是编排的入口

#### 4.2 编排层：工具链注册与 Function Calling（任务 13）
- **优先级**：P0
- **依赖**：任务 12, 任务 8
- **产物**：工具注册、Function Calling
- **验证**：`backend/scripts/tool_registry_smoke_test.py`
- **关联需求**：R15.3
- **为什么第十四**：工具编排是核心能力

#### 4.3 证据链引擎（任务 14）
- **优先级**：P0
- **依赖**：任务 13, 任务 7
- **产物**：证据链组装、增量更新
- **验证**：`backend/scripts/evidence_smoke_test.py`
- **关联需求**：R2.2, R6.2
- **为什么第十五**：证据链是系统可信度的核心

### 第五批：SSE 流式输出（Week 5-6）

**目标**：实现流式交互和实时反馈

#### 5.1 SSE 服务端输出（任务 15）
- **优先级**：P0
- **依赖**：任务 14
- **产物**：SSE 事件序列、错误处理
- **验证**：`backend/scripts/sse_smoke_test.py`
- **关联需求**：R6.1, R6.3
- **为什么第十六**：SSE 是用户体验的核心

### 第六批：安全与审计（Week 6-7）

**目标**：实现安全防护和审计日志

#### 6.1 高风险意图/提示词注入防护（任务 16）
- **优先级**：P0
- **依赖**：任务 12
- **产物**：注入检测、策略拦截
- **验证**：`backend/scripts/security_guardrail_smoke_test.py`
- **关联需求**：R10.1, R10.3, R17.2
- **为什么第十七**：安全防护是系统上线的前提

#### 6.2 审计落库与不可篡改策略（任务 17）
- **优先级**：P0
- **依赖**：任务 15
- **产物**：审计日志表、append-only 策略
- **验证**：`backend/scripts/audit_log_smoke_test.py`
- **关联需求**：R11.1, R11.2
- **为什么第十八**：审计是合规的基础

### 第七批：前端交互层（Week 7-8）

**目标**：实现前端界面和流式渲染

#### 7.1 前端三栏式布局 + SSE 流式渲染 + 证据链可视化（任务 19）
- **优先级**：P0
- **依赖**：任务 15
- **产物**：三栏布局、SSE 客户端、Context Panel
- **验证**：`npm -C web run build && backend/scripts/web_sse_e2e_smoke_test.py`
- **关联需求**：R13.1, R13.2, R13.3
- **为什么第十九**：前端是用户交互的入口

#### 7.2 前端 SSE 客户端状态机（任务 46）
- **优先级**：P0
- **依赖**：任务 19
- **产物**：SSE 连接管理、断线重连
- **验证**：`npm -C web test`
- **关联需求**：R13.2, R6.3
- **为什么第二十**：客户端状态机是可靠性的保障

#### 7.3 前端 Context Panel 强化（任务 47）
- **优先级**：P0
- **依赖**：任务 19
- **产物**：证据缺失/降级态 UI
- **验证**：`npm -C web test`
- **关联需求**：R6.2, R14.4, R13.3
- **为什么第二十一**：Context Panel 是证据链的可视化

### 第八批：跨阶段任务（Week 8）

**目标**：完善配置管理和契约测试

#### 8.1 配置外部化与配置校验（任务 43）
- **优先级**：P0
- **依赖**：任务 2
- **产物**：`.env.example`、配置校验
- **验证**：`backend/scripts/config_validation_smoke_test.py`
- **关联需求**：设计文档 2.9, R14.5
- **为什么第二十二**：配置外部化是部署的前提

#### 8.2 契约测试体系（任务 44）
- **优先级**：P0
- **依赖**：任务 1, 任务 9, 任务 19
- **产物**：前端 Zod + 后端 Pydantic 契约测试
- **验证**：`backend/scripts/contract_tests_smoke_test.py`
- **关联需求**：设计文档 7.4, R9.3
- **为什么第二十三**：契约测试是接口稳定性的保障

#### 8.3 统一语义层（实体与 ID 映射）（任务 56）
- **优先级**：P0
- **依赖**：任务 5
- **产物**：映射表、冲突检测
- **验证**：`backend/scripts/semantic_id_mapping_smoke_test.py`
- **关联需求**：R16.1
- **为什么第二十四**：统一 ID 是跨系统聚合的基础

### L1 阶段总结

**预计工期**：8 周

**验收指标**：
- 跨系统查询耗时 P95 < 10秒
- 关键指标回答准确率 >= 99%
- 审计日志覆盖率 100%
- SSE 联调成功，前端可实时渲染
- 数值回答可追溯，证据链完整

**里程碑**：
- Week 2：数据层和契约完成
- Week 4：后端核心功能完成
- Week 6：编排层和证据链完成
- Week 8：前端和端到端链路打通

---

## L2 阶段：诊断/多模态/可观测增强

### 第一批：模型推理增强（Week 9-10）

**目标**：实现并发控制、配额管理和模型路由

#### 9.1 模型推理适配层（任务 45）
- **优先级**：P0
- **依赖**：任务 11
- **产物**：统一 llama.cpp 适配器、并发/配额/观测
- **验证**：`backend/scripts/llamacpp_smoke_test.py && backend/scripts/concurrency_cancel_smoke_test.py`
- **关联需求**：R9.1, R9.2, R15.4
- **为什么第一**：模型推理增强是 L2 的基础

#### 9.2 模型并发控制与排队（任务 21）
- **优先级**：P1
- **依赖**：任务 45
- **产物**：并发控制、队列管理、取消机制
- **验证**：`backend/scripts/concurrency_cancel_smoke_test.py`
- **关联需求**：R9.2
- **为什么第二**：并发控制是性能的保障

#### 9.3 Token 预算/配额与模型路由（任务 22）
- **优先级**：P1
- **依赖**：任务 45
- **产物**：配额管理、模型路由、缓存策略
- **验证**：`backend/scripts/quota_routing_smoke_test.py`
- **关联需求**：R15.4
- **为什么第三**：配额管理是成本控制的关键

### 第二批：RAG 与知识库（Week 10-11）

**目标**：实现文档检索和知识增强

#### 10.1 RAG 文档库与检索增强（任务 20）
- **优先级**：P1
- **依赖**：任务 45
- **产物**：文档摄取、检索、引用
- **验证**：`backend/scripts/rag_smoke_test.py`
- **关联需求**：R15.2
- **为什么第四**：RAG 是知识增强的核心

### 第三批：可观测性（Week 11-12）

**目标**：实现链路追踪和性能监控

#### 11.1 OpenTelemetry traces/metrics（任务 26）
- **优先级**：P1
- **依赖**：任务 15
- **产物**：Trace、Metrics 采集
- **验证**：`backend/scripts/otel_smoke_test.py`
- **关联需求**：R12.1, R12.2
- **为什么第五**：可观测性是运维的基础

#### 11.2 性能与可靠性体系（任务 42）
- **优先级**：P0
- **依赖**：任务 26
- **产物**：性能基线、压测报告
- **验证**：`backend/scripts/performance_baseline_smoke_test.py`
- **关联需求**：R14.1, R14.2
- **为什么第六**：性能基线是 SLA 的保障

### 第四批：业务功能增强（Week 12-14）

**目标**：实现告警、交接班、图表等业务功能

#### 12.1 异常主动推送与告警升级（任务 23）
- **优先级**：P1
- **依赖**：任务 15
- **产物**：告警规则、推送通道
- **验证**：`backend/scripts/alerting_smoke_test.py`
- **关联需求**：R2.4
- **为什么第七**：告警是主动运维的基础

#### 12.2 智能交接班（任务 24）
- **优先级**：P1
- **依赖**：任务 17
- **产物**：班次摘要、异常汇总
- **验证**：`backend/scripts/shift_handover_smoke_test.py`
- **关联需求**：R2.5
- **为什么第八**：交接班是生产管理的刚需

#### 12.3 管理驾驶舱/自然语言 BI（任务 48）
- **优先级**：P1
- **依赖**：任务 19, 任务 7
- **产物**：成本瀑布图、趋势图
- **验证**：`backend/scripts/bi_query_smoke_test.py && npm -C web run build`
- **关联需求**：R2.3, R13.4
- **为什么第九**：BI 是管理决策的核心

#### 12.4 前端图表动态生成 + 移动端适配（任务 27）
- **优先级**：P1
- **依赖**：任务 48
- **产物**：图表组件、移动端适配
- **验证**：`npm -C web run build && backend/scripts/mobile_weaknet_smoke_test.py`
- **关联需求**：R13.4, R13.5, R18.1, R18.2
- **为什么第十**：移动端是现场作业的刚需

### 第五批：多模态与设备诊疗（Week 14-15）

**目标**：实现多模态输入和设备诊断

#### 13.1 多模态上传管线（任务 49）
- **优先级**：P1
- **依赖**：任务 20
- **产物**：图片/音频上传、多模态解析
- **验证**：`backend/scripts/multimodal_smoke_test.py`
- **关联需求**：R3.1
- **为什么第十一**：多模态是设备诊断的基础

#### 13.2 设备多模态诊断（任务 25）
- **优先级**：P1
- **依赖**：任务 49
- **产物**：故障诊断、维修方案推荐
- **验证**：`backend/scripts/maintenance_multimodal_smoke_test.py`
- **关联需求**：R3.1, R3.2, R3.3
- **为什么第十二**：设备诊断是维修的核心

#### 13.3 设备诊疗专家外部系统接入（任务 50）
- **优先级**：P1
- **依赖**：任务 25
- **产物**：EAM 连接器、工单查询
- **验证**：`backend/scripts/eam_connector_smoke_test.py`
- **关联需求**：R3.2, R3.3
- **为什么第十三**：外部系统接入是数据完整性的保障

### 第六批：反馈与评估（Week 15-16）

**目标**：实现反馈闭环和质量评估

#### 14.1 纠错反馈闭环（任务 28）
- **优先级**：P1
- **依赖**：任务 17
- **产物**：反馈收集、审核入库
- **验证**：`backend/scripts/feedback_loop_smoke_test.py`
- **关联需求**：R15.5
- **为什么第十四**：反馈闭环是持续改进的基础

#### 14.2 Golden Dataset 回归与发布门禁（任务 29）
- **优先级**：P1
- **依赖**：任务 28
- **产物**：回归测试、发布门禁
- **验证**：`backend/scripts/golden_dataset_regression_smoke_test.py`
- **关联需求**：R17.1
- **为什么第十五**：质量门禁是发布的保障

#### 14.3 Token 预算与配额增强（任务 51）
- **优先级**：P1
- **依赖**：任务 22
- **产物**：缓存策略、高频问题模板化
- **验证**：`backend/scripts/quota_and_cache_smoke_test.py`
- **关联需求**：R15.4
- **为什么第十六**：成本优化是长期运营的关键

#### 14.4 GUI/LUI 融合（任务 52）
- **优先级**：P2
- **依赖**：任务 48
- **产物**：圈选提问、证据定位高亮
- **验证**：`npm -C web run build && backend/scripts/web_sse_e2e_smoke_test.py`
- **关联需求**：R13.4
- **为什么第十七**：交互增强是用户体验的提升

### L2 阶段总结

**预计工期**：8 周（Week 9-16）

**验收指标**：
- 常见故障 Top20 覆盖
- MTTR 下降可量化
- 建议引用来源覆盖率 100%
- 移动端可用性 >= 99%

**里程碑**：
- Week 10：模型推理增强完成
- Week 12：可观测性完成
- Week 14：业务功能增强完成
- Week 16：多模态和反馈闭环完成

---

## L3 阶段：决策辅助与防护栏增强

### 第一批：防护栏增强（Week 17-18）

**目标**：实现规程合规检查和物理约束校验

#### 15.1 规程合规检查与红线拦截（任务 30）
- **优先级**：P0
- **依赖**：任务 20
- **产物**：规程检查、红线拦截
- **验证**：`backend/scripts/sop_compliance_smoke_test.py`
- **关联需求**：R4.2
- **为什么第一**：规程合规是安全的红线

#### 15.2 物理边界/变化率一致性校验（任务 32）
- **优先级**：P0
- **依赖**：任务 14
- **产物**：物理约束校验、变化率检测
- **验证**：`backend/scripts/physical_guardrail_smoke_test.py`
- **关联需求**：R17.3, R14.4
- **为什么第二**：物理约束是防幻觉的关键

### 第二批：决策辅助（Week 18-19）

**目标**：实现工艺参数优化建议

#### 16.1 工艺参数优化建议（任务 31）
- **优先级**：P1
- **依赖**：任务 20, 任务 30
- **产物**：参数优化建议、历史案例引用
- **验证**：`backend/scripts/process_optimization_smoke_test.py`
- **关联需求**：R4.1
- **为什么第三**：工艺优化是决策辅助的核心

### 第三批：数据质量增强（Week 19-20）

**目标**：实现事件对齐和数据质量评估

#### 17.1 事件模型与时间对齐深化（任务 33）
- **优先级**：P0
- **依赖**：任务 14
- **产物**：事件对齐、时间窗口
- **验证**：`backend/scripts/time_alignment_smoke_test.py`
- **关联需求**：R16.2
- **为什么第四**：时间对齐是数据准确性的保障

#### 17.2 数据质量评估前置（任务 34）
- **优先级**：P0
- **依赖**：任务 14
- **产物**：数据质量评分、降级策略
- **验证**：`backend/scripts/data_quality_smoke_test.py`
- **关联需求**：R16.3
- **为什么第五**：数据质量是结论可信度的基础

#### 17.3 知识图谱增强（任务 35）
- **优先级**：P2
- **依赖**：任务 20, 任务 56
- **产物**：多跳关联、证据追溯
- **验证**：`backend/scripts/knowledge_graph_smoke_test.py`
- **关联需求**：R16.4
- **为什么第六**：知识图谱是复杂推理的基础

### 第四批：工具链扩展（Week 20-22）

**目标**：接入更多外部系统

#### 18.1 工具链扩展（任务 53）
- **优先级**：P1
- **依赖**：任务 13
- **产物**：ERP/MES/DCS/LIMS 连接器
- **验证**：`backend/scripts/connectors_integration_smoke_test.py`
- **关联需求**：R15.3
- **为什么第七**：工具链扩展是数据完整性的保障

#### 18.2 数据基础设施演进（任务 54）
- **优先级**：P1
- **依赖**：任务 33
- **产物**：时序数据接入、冷热分层
- **验证**：`backend/scripts/timeseries_smoke_test.py`
- **关联需求**：R16.2
- **为什么第八**：时序数据是事件对齐的基础

### L3 阶段总结

**预计工期**：6 周（Week 17-22）

**验收指标**：
- 在离线回放/沙箱仿真中达到既定节能或质量波动下降目标
- 建议具备约束清单与证据链
- 规程合规检查准确率 >= 95%

**里程碑**：
- Week 18：防护栏增强完成
- Week 20：决策辅助和数据质量增强完成
- Week 22：工具链扩展完成

---

## L4 阶段：受控写操作

### 第一批：只读默认强化（Week 23）

**目标**：强化只读默认策略

#### 19.1 只读默认门禁强化（任务 36）
- **优先级**：P0
- **依赖**：任务 12
- **产物**：写意图识别、强制审批流程
- **验证**：`backend/scripts/read_only_default_smoke_test.py`
- **关联需求**：R5.1
- **为什么第一**：只读默认是写操作的前提

### 第二批：草案与审批（Week 24-25）

**目标**：实现写操作草案生成和审批流程

#### 19.2 写操作草案生成（任务 37）
- **优先级**：P1
- **依赖**：任务 36
- **产物**：草案生成、约束清单、影响评估
- **验证**：`backend/scripts/action_prepare_smoke_test.py`
- **关联需求**：R5.2
- **为什么第二**：草案是审批的前提

#### 19.3 审批与多签（任务 38）
- **优先级**：P1
- **依赖**：任务 37
- **产物**：审批路由、多签机制、状态机
- **验证**：`backend/scripts/approval_multisig_smoke_test.py`
- **关联需求**：R5.3
- **为什么第三**：审批是写操作的门禁

### 第三批：受控执行与回滚（Week 25-26）

**目标**：实现安全执行和回滚机制

#### 19.4 受控执行与回滚（任务 39）
- **优先级**：P1
- **依赖**：任务 38
- **产物**：安全网关、回滚点、幂等机制
- **验证**：`backend/scripts/controlled_execute_and_rollback_smoke_test.py`
- **关联需求**：R5.4
- **为什么第四**：受控执行是写操作的核心

#### 19.5 写操作 Kill Switch 与熔断（任务 40）
- **优先级**：P1
- **依赖**：任务 39
- **产物**：Kill Switch、熔断机制
- **验证**：`backend/scripts/kill_switch_smoke_test.py`
- **关联需求**：设计文档 2.9, R5.4
- **为什么第五**：Kill Switch 是紧急止损的手段

### 第四批：沙箱与培训（Week 26-27）

**目标**：实现沙箱仿真和培训模式

#### 19.6 沙箱仿真与培训模式（任务 41）
- **优先级**：P2
- **依赖**：任务 39
- **产物**：沙箱环境、模拟执行、培训案例
- **验证**：`backend/scripts/sandbox_training_smoke_test.py`
- **关联需求**：R5.5
- **为什么第六**：沙箱是安全培训的基础

### L4 阶段总结

**预计工期**：5 周（Week 23-27）

**验收指标**：
- 写操作审批流程完整
- 回滚成功率 100%
- 沙箱模拟准确率 >= 90%

**验收前置条件**：
- 权限体系与审计完善
- 安全网关与沙箱仿真通过
- 试点产线/设备范围明确

**里程碑**：
- Week 23：只读默认强化完成
- Week 25：草案与审批完成
- Week 27：受控执行和沙箱完成

---

## 跨阶段持续任务

### 持续任务 1：生产级发布与回归门禁（任务 55）

**优先级**：P0
**开始时间**：L1 完成后（Week 9 起）
**持续时间**：贯穿 L2-L4
**产物**：CI 流水线、版本化发布、回滚策略
**验证**：`backend/scripts/full_pipeline_smoke_test.py && npm -C web run build`
**关联需求**：R17.1, 设计文档 7, 8
**为什么重要**：发布门禁是质量保障的最后一道防线

**实施建议**：
- Week 9：建立 CI 基础流水线（单元测试 + 冒烟测试）
- Week 12：加入契约测试和性能基线测试
- Week 16：加入 Golden Dataset 回归测试
- Week 20：完善版本化发布和回滚策略

---

## 任务依赖关系图

### L1 核心依赖链

```markdown
任务1（契约基线） ├─→ 任务2（后端骨架） │ ├─→ 任务3（认证权限） │ │ ├─→ 任务4（数据域隔离） │ │ │ ├─→ 任务8（查询工具） │ │ │ │ ├─→ 任务9（参数校验） │ │ │ │ ├─→ 任务10（超时重试） │ │ │ │ └─→ 任务13（工具编排） │ │ │ │ └─→ 任务14（证据链） │ │ │ │ └─→ 任务15（SSE输出） │ │ │ │ ├─→ 任务16（安全防护） │ │ │ │ ├─→ 任务17（审计日志） │ │ │ │ └─→ 任务19（前端） │ │ │ └─→ 任务56（统一ID） │ │ └─→ 任务12（意图识别） │ │ └─→ 任务13（工具编排） │ ├─→ 任务11（llama.cpp） │ │ └─→ 任务12（意图识别） │ └─→ 任务18（健康检查） └─→ 任务43（配置外部化）

任务5（数据模型） ├─→ 任务6（造数脚本） ├─→ 任务7（口径仓库） │ └─→ 任务14（证据链） ├─→ 任务8（查询工具） └─→ 任务56（统一ID）
```

### L3 核心依赖链

```markdown
任务20（RAG） ├─→ 任务30（规程合规） │ └─→ 任务31（工艺优化） └─→ 任务35（知识图谱）

任务14（证据链） ├─→ 任务32（物理约束） ├─→ 任务33（事件对齐） │ └─→ 任务54（时序数据） └─→ 任务34（数据质量）

任务13（工具编排） └─→ 任务53（工具链扩展）


```


### L4 核心依赖链

```markdown
任务12（意图识别） └─→ 任务36（只读默认强化） └─→ 任务37（草案生成） └─→ 任务38（审批多签） └─→ 任务39（受控执行） ├─→ 任务40（Kill Switch） └─→ 任务41（沙箱培训）
```


---

## 风险管理与应对策略

### 高风险任务识别

#### 1. llama.cpp 接入（任务 11）
**风险**：模型推理不稳定、性能不达标
**应对**：
- Week 3 提前验证 llama.cpp 性能
- 准备降级方案（模板化查询）
- 建立性能基线测试

#### 2. 证据链引擎（任务 14）
**风险**：证据链逻辑复杂、难以测试
**应对**：
- 先实现简单场景（单工具调用）
- 逐步增加复杂度（多工具、嵌套）
- 建立完善的单元测试

#### 3. SSE 流式输出（任务 15）
**风险**：前后端联调困难、断线重连不稳定
**应对**：
- 先实现简单的 SSE 流
- 使用 mock 数据测试前端
- 建立端到端冒烟测试

#### 4. 多模态上传（任务 49）
**风险**：图片/音频处理复杂、性能问题
**应对**：
- 限制文件大小和格式
- 使用异步处理
- 建立性能监控

#### 5. 受控执行与回滚（任务 39）
**风险**：回滚机制复杂、可能失败
**应对**：
- 先在沙箱环境验证
- 建立完善的回滚测试
- 准备人工介入方案

---

## 资源配置建议

### 团队配置

#### L1 阶段（8 周）
- **后端开发**：3 人
  - 1 人负责基础设施（任务 1-7）
  - 1 人负责工具层和编排层（任务 8-14）
  - 1 人负责 SSE 和安全（任务 15-18）
- **前端开发**：2 人
  - 1 人负责布局和 SSE 客户端（任务 19, 46）
  - 1 人负责 Context Panel 和契约测试（任务 47, 44）
- **测试工程师**：1 人
  - 负责冒烟测试和契约测试
- **架构师/Tech Lead**：1 人
  - 负责技术决策和风险管理

#### L2 阶段（8 周）
- **后端开发**：3 人
  - 1 人负责模型推理增强（任务 45, 21, 22）
  - 1 人负责 RAG 和多模态（任务 20, 49, 25）
  - 1 人负责可观测性和业务功能（任务 26, 23, 24）
- **前端开发**：2 人
  - 1 人负责图表和移动端（任务 48, 27）
  - 1 人负责交互增强（任务 52）
- **测试工程师**：1 人
- **架构师/Tech Lead**：1 人

#### L3 阶段（6 周）
- **后端开发**：2 人
  - 1 人负责防护栏和决策辅助（任务 30-32）
  - 1 人负责数据质量和工具链（任务 33-35, 53-54）
- **测试工程师**：1 人
- **架构师/Tech Lead**：1 人

#### L4 阶段（5 周）
- **后端开发**：2 人
  - 1 人负责草案和审批（任务 36-38）
  - 1 人负责受控执行和沙箱（任务 39-41）
- **测试工程师**：1 人
- **架构师/Tech Lead**：1 人

### 技能要求

#### 后端开发
- **必须**：Python、FastAPI、PostgreSQL、Pydantic
- **重要**：SSE、JWT、RBAC、审计日志
- **加分**：llama.cpp、RAG、OpenTelemetry

#### 前端开发
- **必须**：React、TypeScript、Vite、Zod
- **重要**：SSE 客户端、状态管理、图表库
- **加分**：移动端适配、PWA

#### 测试工程师
- **必须**：pytest、单元测试、集成测试
- **重要**：冒烟测试、契约测试、性能测试
- **加分**：自动化测试框架

---

## 质量保障措施

### 代码审查

- **强制要求**：所有代码必须经过 Code Review
- **审查重点**：
  - 契约一致性（Pydantic/Zod）
  - 错误处理（结构化错误模型）
  - 安全性（RBAC、脱敏、注入防护）
  - 证据链完整性
  - 测试覆盖率

### 测试策略

#### 单元测试
- **覆盖率要求**：核心模块 >= 80%
- **重点覆盖**：
  - 证据链组装规则
  - 错误模型映射
  - RBAC 拦截
  - SSE 事件序列化

#### 冒烟测试
- **强制要求**：每个任务完成后必须通过冒烟测试
- **真实服务**：必须使用真实 FastAPI + Postgres + llama.cpp
- **禁止 mock**：集成测试不得使用 mock

#### 契约测试
- **强制要求**：前后端契约必须一致
- **自动化**：契约变更自动触发测试
- **门禁**：契约不一致阻止合并

### 持续集成

- **触发条件**：每次 PR 提交
- **流水线**：
  1. 代码检查（lint、type check）
  2. 单元测试
  3. 契约测试
  4. 冒烟测试
  5. 性能基线测试（L2+）
  6. Golden Dataset 回归（L2+）
- **门禁**：所有测试通过才能合并

---

## 交付物清单

### L1 阶段交付物

#### 文档
- [x] 对外契约文档（`docs/contracts/api-and-events-draft.md`）
- [x] OpenAPI 规范（`docs/api/openapi.yaml`）
- [x] 数据库设计文档
- [x] 部署文档
- [x] 运维手册

#### 代码
- [x] 后端服务（FastAPI）
- [x] 前端应用（React + TypeScript）
- [x] 数据库迁移脚本
- [x] 造数脚本
- [x] 冒烟测试脚本

#### 配置
- [x] `.env.example`
- [x] Docker Compose 配置（可选）
- [x] CI/CD 配置

### L2 阶段交付物

#### 文档
- [x] RAG 文档库管理文档
- [x] 多模态处理文档
- [x] 可观测性配置文档
- [x] 移动端使用手册

#### 代码
- [x] RAG 模块
- [x] 多模态处理模块
- [x] OpenTelemetry 集成
- [x] 移动端适配

### L3 阶段交付物

#### 文档
- [x] 规程合规检查规则文档
- [x] 工艺参数优化文档
- [x] 数据质量评估文档

#### 代码
- [x] 规程合规检查模块
- [x] 工艺优化模块
- [x] 数据质量评估模块
- [x] 外部系统连接器

### L4 阶段交付物

#### 文档
- [x] 写操作审批流程文档
- [x] 回滚操作手册
- [x] 沙箱使用手册

#### 代码
- [x] 草案生成模块
- [x] 审批流程模块
- [x] 受控执行模块
- [x] 沙箱环境

---

## 总结

### 关键成功因素

1. **契约先行**：先定义契约，再实现功能
2. **测试驱动**：每个任务必须有单元测试和冒烟测试
3. **真实服务**：集成测试必须使用真实服务
4. **增量交付**：每个阶段都能产出可演示的功能
5. **风险前置**：技术风险高的任务尽早验证
6. **持续集成**：建立完善的 CI/CD 流水线
7. **质量门禁**：Golden Dataset 回归和性能基线测试

### 总体时间线

- **L1**：Week 1-8（8 周）
- **L2**：Week 9-16（8 周）
- **L3**：Week 17-22（6 周）
- **L4**：Week 23-27（5 周）
- **总计**：27 周（约 6.5 个月）

### 里程碑

- **Week 2**：数据层和契约完成
- **Week 4**：后端核心功能完成
- **Week 6**：编排层和证据链完成
- **Week 8**：L1 完成，端到端链路打通
- **Week 12**：可观测性完成
- **Week 16**：L2 完成，多模态和反馈闭环完成
- **Week 20**：数据质量增强完成
- **Week 22**：L3 完成，工具链扩展完成
- **Week 27**：L4 完成，受控写操作完成

### 下一步行动

1. **Week 1**：启动任务 1（契约基线）和任务 5（数据模型）
2. **Week 1**：组建团队，分配任务
3. **Week 1**：建立开发环境和 CI/CD 流水线
4. **Week 2**：完成第一批基础设施任务
5. **Week 2**：开始第二批后端核心任务

---

**文档版本**：1.0  
**生成日期**：2025-02-19  
**维护者**：项目架构师  
**更新频率**：每周更新进度
