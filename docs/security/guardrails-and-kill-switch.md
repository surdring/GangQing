# 只读默认（Guardrails）与 Kill Switch（熔断）策略（含 OT 写入门禁）
本文件固化 GangQing（钢擎）在 L1-L4 的“只读默认、写操作受控闭环、熔断、回滚、OT 写入隔离与二次确认”工程规范与验收口径，确保任何写/下发/控制均可审计、可观测、可复核。

## 0. 强制目标
- 默认只读：未显式授权与审批通过前，系统不得执行任何写操作。
- 写操作必须：草案 → 审批/多签 → 受控执行 → 回滚点记录 → 审计。
- OT 写入禁止直连反控：必须专用通道 + OT 侧二次确认 + 全程审计。
- Kill Switch 可一键切断所有写能力，并可审计、可观测、可告警。
- `requestId`/`tenantId`/`projectId` 必须贯穿：拦截、审批、执行、回滚、熔断启停等全部事件。

## 1. 只读默认（Read-Only Default）

### 1.1 适用范围
- 适用于所有对外入口：HTTP API、SSE/WS 流式对话、工具调用、后台任务。
- 适用于所有会导致外部状态变化的动作：
  - IT 写入（ERP/MES/EAM 等业务系统写）
  - OT 写入（DCS/PLC 下发、设定值调整、控制动作）
  - 策略与权限变更（也属于写操作）

### 1.2 默认策略（验收口径）
当用户提出 Action 意图或系统推导出写操作时：
- 若不满足“权限 + 审批状态 + 白名单范围 + Kill Switch 关闭”，则必须：
  - **拦截**
  - 返回结构化错误（英文 message）或返回“草案模式（未执行）”
  - 写入审计事件（至少 `query` + `tool_call`/`approval`/`write_operation` 中的相应类型）

## 2. 写操作受控闭环（L4）

### 2.1 阶段划分
- **Draft（草案）**：生成可编辑方案，不执行
- **Approval（审批/多签）**：按风险与域选择审批链，记录审批动作
- **Execution（受控执行）**：通过执行网关下发，具备幂等、超时、阈值限制
- **Rollback（回滚）**：回滚到上一个已确认版本/回滚点

### 2.2 门禁条件（必须全部满足）
- 权限：写权限独立于读权限（RBAC 最小权限）。
- 审批：审批状态必须为 `approved`（且满足多签规则）。
- 白名单：产线/设备/对象必须在允许范围内。
- Kill Switch：必须处于关闭状态。
- 风险策略：高风险动作必须升级更严格审批链或禁止。

### 2.3 审计要求（强制）
- 每个阶段都必须写审计：
  - Draft 创建/更新/提交
  - Approval submit/approve/reject/withdraw/timeout
  - Execution execute/success/failure
  - Rollback rollback/success/failure
- 审计字段必须包含：`requestId`、`tenantId`、`projectId`、`userId`、`role`、`actionType`、`resource`、`result`。
- 工具调用参数摘要必须脱敏。

## 3. Kill Switch（全局熔断开关）

### 3.1 功能定义
- 系统管理员拥有最高优先级权限，可一键切断 AI 对所有写操作工具/执行网关的调用能力。

### 3.2 模式定义
- **正常模式**：允许受控写（仍需草案+审批+白名单）。
- **熔断模式**：强制降级为“仅查询”，所有 Action 意图被安全网关拦截。

### 3.3 验收口径
- 开启熔断后：
  - `execution:execute:*` 必须不可用（强制拦截）
  - 已存在的 draft/approval 可读，但不可执行
- 熔断启停操作必须：
  - 权限检查（仅 admin）
  - 写审计事件（`write_operation` 或专用事件类型）
  - 可观测（状态可查询）
  - 可告警（如告警体系已启用）

## 4. OT 写入门禁（专用通道 + OT 二次确认）

### 4.1 基本约束（强制）
- 禁止任何“AI 服务直连 DCS/PLC 写接口”的路径。
- OT 写入必须通过：
  - **执行网关（Execution Gateway）**：白名单工具、阈值限制、幂等、超时、熔断
  - **专用通道（Secure Channel）**：跨网域安全链路（DMZ/网闸/加密通道等）
  - **OT 侧二次确认（Human Confirm in OT）**：由 `ot_operator` 或等价角色确认执行

### 4.2 二次确认验收口径
- OT 二次确认必须形成可复核记录（审计/系统记录/签名记录之一）。
- 记录至少包含：
  - 目标对象（设备/点位/参数）
  - 变更前值、变更后值
  - 生效时间
  - 确认人（OT 角色）
  - 关联的 `requestId`/`draftId`/`executionId`

## 5. 回滚策略（必须）
- 执行前必须记录回滚点（上一个已确认版本）。
- 回滚动作必须：
  - 权限检查
  - 写审计
  - 结果可验证

## 6. 结构化拦截响应（对外）
- 被拦截的 Action 意图应返回结构化错误（英文 message），建议错误码：
  - `GUARDRAIL_BLOCKED`（红线/只读默认拦截）
  - `AUTH_ERROR`/`FORBIDDEN`（权限不足）
  - `CONTRACT_VIOLATION`（审批状态不满足/缺少回滚点等）

## 7. 最小演练与验收用例（建议）
- 无审批尝试执行写：必须拦截 + 审计。
- 熔断开启后尝试执行写：必须拦截 + 审计。
- OT 写入：必须出现 OT 二次确认记录 + write_operation 审计。
- 回滚：必须可执行并可审计。
