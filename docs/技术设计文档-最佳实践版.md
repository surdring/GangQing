# GangQing 技术设计文档（最佳实践版，无代码示例）

- **项目名称**：GangQing（钢擎）—— 钢铁工业全域认知决策系统
- **文档定位**：在现有设计文档基础上，补齐“生产级工业 Agent 应用”的工程化最佳实践与验收口径（不包含任何代码示例）。
- **适用阶段**：L1（只读查询）→ L2（诊断/多模态）→ L3（决策辅助）→ L4（受控写操作）
- **核心原则（强制）**：安全第一、证据驱动、人机协同、私有化部署、渐进式演进。

## 1. 目标与范围

### 1.1 总体目标

- 提供钢厂全域系统（ERP/MES/DCS/LIMS/EAM 等）的统一自然语言交互入口。
- 在不接触底层控制权的前提下，提供可追溯、可审计的查询与辅助决策。
- 对高风险意图与关键数值建立“可验证—不可验证降级”的可靠输出机制。

### 1.2 非目标（本版不覆盖）

- 不规定具体某一家外部系统的字段级接口细节（留给工具适配层）。
- 不在本文中给出任何代码示例与实现片段。

### 1.3 权威参考（单一事实源）

- PRD：`docs/产品需求.md`
- 对外契约草案：`docs/contracts/api-and-events-draft.md`
- API 文档：`docs/api/openapi.yaml`
- 项目现状分析：`docs/项目现状分析.md`

## 2. 总体架构与分层边界

### 2.1 目标形态（逻辑分层）

- **交互层（Web/移动端）**
  - 三栏式布局：导航栏 / 对话区 / 证据面板（Context Panel）
  - 与后端的唯一交互通道：SSE（Server-Sent Events）流式协议
- **API 网关层（FastAPI）**
  - 会话与鉴权入口（RBAC）
  - SSE 事件编排与流控
  - 请求上下文贯穿（`requestId`）
  - 统一错误模型输出
- **编排层（Orchestration / Agent Runtime）**
  - 意图识别、计划、工具选择、反思/校验
  - 只读默认（Read-Only Default）策略执行
  - 人在回路（HITL）中断/继续（为 L4 预留）
- **工具与适配层（Tools / Connectors）**
  - 数据库查询工具（L1 最小闭环：Postgres）
  - 后续可扩展：ERP/MES/DCS/EAM 等连接器
  - 统一：参数校验、超时、重试、脱敏、审计
- **数据层（Postgres）**
  - L1：通过造数数据支持“真实查询—真实证据链—真实审计”闭环
  - L2+：知识库/文档库与向量索引（如后续引入 RAG）
- **模型推理层（llama.cpp）**
  - 本地私有化部署
  - 通过“模型网关/适配器”接入（支持超时、并发控制、配额与观测）
- **可观测与审计层**
  - 结构化日志、审计日志（不可篡改要求由部署与权限控制保障）
  - OpenTelemetry traces/metrics（建议）

### 2.2 数据流概览（L1：只读查询）

1. 前端发起对话请求（携带 `sessionId`、用户身份、问题文本）。
2. 后端生成 `requestId` 并创建 SSE 流。
3. 编排层完成：意图识别 → 工具调用（Postgres）→ 结果整理 → 证据链组装 → 生成回答。
4. 过程中逐步输出 SSE 事件：`progress`/`tool_call`/`tool_result`/`message.delta`/`evidence.update`。
5. 结束输出 `final` 事件，并落库审计（查询、工具调用、响应摘要）。

### 2.3 数据流概览（L4：受控写操作，预留）

- 任何写操作必须经过：**草案（prepare）→ 审批/多签（approve）→ 受控执行（execute）→ 回滚点记录（rollback point）→ 审计**。
- L4 需要额外引入：
  - 持久化执行与可恢复能力
  - 幂等键与重复执行保护
  - 安全网关与熔断开关

## 3. 非功能性需求（NFR）分解与工程化落实

### 3.1 安全性（强制）

- **私有化与数据不出厂**：模型与数据均在内网；外网访问需物理隔离策略保证。
- **RBAC**：用户可访问的工具、数据域、字段必须按角色控制。
- **最小权限原则**：模型不直接持有数据库/系统的高权限凭证；凭证由服务端代码持有并按工具粒度隔离。
- **输入/输出安全**：防止提示词注入、间接注入、敏感信息外泄。
- **审计与留痕**：覆盖用户查询、工具调用、审批动作（预留）、写操作（预留）。

### 3.2 准确性与“关键数值不可幻觉”（强制）

- **数值类回答必须来源可追溯**：必须绑定数据源、时间范围、口径版本。
- **不可验证降级**：缺少关键数据时不允许生成确定性数值；必须输出不确定项并提示补齐数据。
- **一致性校验**：关键指标/关键物理量应有合理区间与变化率边界（L3+ 强制）。

### 3.3 实时性（目标）

- SSE 流式输出：
  - 先给 `progress`（阶段/预计耗时），避免“长时间无反馈”。
  - 复杂分析可分步骤输出工具调用与阶段进度。

### 3.4 可靠性与降级

- 上游（Postgres/模型）不可用：
  - 返回结构化错误（`code` + 英文 `message` + `requestId` + `retryable`）。
  - 若可行：提供只读缓存/历史结果（后续阶段扩展）。

## 4. API 与流式事件协议（SSE）

### 4.1 协议选择理由

- SSE 更适合“服务端单向流式输出”，与 L1-L3 的对话与过程解释匹配。
- 易于穿透企业网络与网关，易于在浏览器端实现。

### 4.2 SSE 事件模型（建议作为对外契约的一部分）

统一字段：
- `requestId`：链路追踪 ID
- `sessionId`：会话 ID
- `timestamp`：事件时间
- `type`：事件类型
- `payload`：事件载荷（按类型定义 schema）

事件类型建议：
- `progress`：阶段进度（意图识别/检索/计算/生成/校验）
- `message.delta`：回答流式增量
- `tool.call`：工具调用开始（工具名、参数摘要、权限域）
- `tool.result`：工具结果摘要（严禁敏感字段直出）
- `evidence.update`：证据链增量更新
- `warning`：降级/不确定项提示
- `error`：结构化错误
- `final`：结束事件（包含最终汇总与证据链引用）

### 4.3 错误模型（强制）

对外错误必须结构化并可被前端解析：
- `code`：稳定错误码（例如 `VALIDATION_ERROR` / `AUTH_ERROR` / `UPSTREAM_TIMEOUT` / `CONTRACT_VIOLATION`）
- `message`：英文错误描述（便于检索）
- `details`：结构化上下文（禁止敏感信息）
- `retryable`：是否可重试
- `requestId`：链路追踪 ID

## 5. 证据链（Evidence）设计（强制）

### 5.1 证据链的目标

- 为每次回答提供“可审计、可复盘、可解释”的依据。
- 支持用户在前端 Context Panel 中追问：依据是什么、数据来自哪里、时间范围是什么、口径版本是什么。

### 5.2 Evidence 的组成建议

- **结论条目（Claims）**：每条关键结论/关键数值都应成为单独 claim。
- **数据源引用（Citations）**：
  - `source_system`：如 `POSTGRES`（后续扩展为 `ERP`/`MES`/`DCS`）
  - `table_or_report`：表/视图/报表名称
  - `time_range`：时间范围
  - `filters`：关键过滤条件（脱敏）
  - `extracted_at`：提取时间
- **计算口径（Lineage）**：
  - `metric_name`
  - `lineage_version`
  - `formula_id` 或 `definition_uri`（指向指标口径仓库条目）
- **工具调用轨迹（Tool Calls）**：
  - `toolName`
  - `durationMs`
  - `status`
  - `error`（如有，结构化）
- **置信度与不确定项（Confidence / Uncertainty）**：
  - `confidence`：高/中/低
  - `uncertainties[]`：缺失数据、质量问题、假设条件

### 5.3 证据链与“数值不可幻觉”的绑定规则

- 所有数值回答必须至少满足：
  - 可追溯到一个或多个 citations
  - 每个 citation 必须包含明确时间范围
  - 若涉及指标计算，必须引用 lineage_version
- 不满足则必须降级：
  - 输出 `warning` 事件
  - 最终回答中以“不确定/需要补齐数据”表达

## 6. 意图识别与策略路由

### 6.1 意图分类（建议）

- `QUERY`：只读查询（L1 优先）
- `ANALYZE`：分析与对比（L1/L2 可逐步引入）
- `ALERT`：预警与主动推送（L2/L3）
- `ACTION_PREPARE`：生成草案（L4 预留）
- `ACTION_EXECUTE`：执行写操作（L4 严格受控）

### 6.2 策略路由原则

- **默认只读**：任何不明确的请求一律按 `QUERY/ANALYZE` 处理。
- **高风险意图拦截**：
  - 涉及写入、权限提升、绕过审计、导出大批量敏感数据等请求，必须拒绝或进入 HITL。
- **模型行为约束**：模型只负责生成计划与解释，不直接执行“未授权工具调用”。

## 7. 工具与适配层（L1：Postgres 工具优先）

### 7.1 工具统一规范（强制）

每个工具必须具备：
- 参数 schema 校验（服务端校验）
- 超时与重试策略（按工具定义）
- 权限检查（RBAC + 数据域）
- 脱敏（字段级/行级策略）
- 输出证据对象（Evidence Citation + Tool Call Trace）
- 结构化日志与审计字段：`requestId`、`toolName`、`durationMs`、`status`

### 7.2 L1 Postgres 工具边界

- **只读查询**：仅允许 `SELECT`，禁止写入。
- **查询模板化**：避免模型自由拼接 SQL（降低注入与越权风险）。
- **字段白名单**：按角色限制可查询字段。
- **行级安全（建议）**：如多租户/项目隔离启用。

## 8. 数据层设计（Postgres）与“造数”策略

### 8.1 造数的目标

- 在没有真实 ERP/MES/DCS 数据的情况下，依然能实现：
  - 真实数据库查询
  - 真实证据链
  - 真实审计与可观测
  - 前端真实联调

### 8.2 造数原则

- **数据集必须可复现**：同一版本的种子与脚本可生成同样数据。
- **覆盖核心场景**：
  - 成本构成（吨钢成本、焦炭/矿石/电力等项）
  - 产量与能耗（班次/日维度）
  - 设备故障与维修记录（MTTR/MTBF 所需字段）
  - 事件模型（开炉/停机/报警等）
- **保留异常与边界**：
  - 缺失值、延迟到达、重复记录、极端波动
  - 用于验证“不可验证降级”和 guardrail

### 8.3 最小数据模型（建议）

- `dim_equipment`：设备维表（设备ID、名称、产线、关键属性）
- `dim_material`：物料维表（物料ID、名称、类别）
- `fact_production_daily`：日产量事实表（日期、产线/炉号、产量）
- `fact_energy_daily`：日能耗事实表（日期、产线/炉号、能耗项、消耗量）
- `fact_cost_daily`：日成本事实表（日期、产线/炉号、成本项、金额、口径版本）
- `fact_alarm_event`：报警/事件表（时间、设备、事件类型、严重级别）
- `fact_maintenance_workorder`：维修工单表（工单ID、设备、故障、开始/结束时间、用件）
- `metric_lineage`：指标口径仓库（指标名、版本、定义、责任人、变更记录）
- `audit_log`：审计日志（查询、工具调用、响应摘要、状态）

## 9. 模型推理层（llama.cpp）接入设计

### 9.1 目标与约束

- 本地部署，满足“数据不出厂”。
- 通过统一适配层接入，便于替换模型或推理后端。

### 9.2 关键工程点

- **并发控制**：限制并发与队列长度，避免挤压导致系统雪崩。
- **超时策略**：区分“模型推理超时”与“工具调用超时”。
- **上下文管理**：
  - L1 先以短上下文为主，避免无边界对话历史累积。
  - 为 L2/L3 预留“上下文工程”能力：写入、选择、压缩、隔离。
- **输出约束**：
  - 强制结构化输出（用于工具选择、证据链生成、错误码映射）。
  - 输出校验不通过则重试或降级。

## 10. 安全设计（提示词注入、防越权、脱敏、只读默认）

### 10.1 威胁模型（必须覆盖）

- 直接提示词注入（诱导泄露系统指令、绕过规则）
- 间接注入（来自知识库/文件的恶意指令，L2+ 重点）
- 数据外泄（批量导出敏感数据、Embedding/检索泄露）
- 过度代理（Excessive Agency）：未授权的工具/写操作调用

### 10.2 关键防线（强制）

- **结构化输入分区**：系统指令/用户输入/工具结果/外部内容必须逻辑隔离。
- **工具调用白名单**：按意图与角色控制可用工具。
- **参数级校验**：任何工具调用必须经过服务端校验与脱敏策略。
- **输出过滤/校验**：识别敏感信息、系统提示词泄露特征、异常长输出等。
- **HITL**：对高风险意图或写操作必须进入审批（L4）。

### 10.3 脱敏策略（建议）

- 按角色配置字段级脱敏（例如价格、配方、核心工艺参数）。
- 前端证据链展示默认脱敏，只在具备权限时可展开。

## 11. 审计与日志（强制）

### 11.1 审计覆盖面

- 用户查询（query）
- 工具调用（tool_call，参数摘要脱敏）
- 响应结果（response 摘要 + evidence 引用）
- 错误（error code/message/requestId）
- 审批动作与写操作（L4 预留）

### 11.2 审计记录最小字段集

- `requestId`、`sessionId`、`userId`、`role`、`timestamp`
- `intent`
- `toolsUsed[]`
- `dataScope`（时间范围/对象范围）
- `resultStatus`（success/fail）
- `error`（如有）

## 12. 可观测性（建议：OpenTelemetry）

### 12.1 Trace 设计建议

关键 span：
- `http.request`
- `intent.classify`
- `tool.postgres.query`（或更细粒度）
- `llm.generate`
- `evidence.build`

关键属性：
- `requestId`、`sessionId`
- `toolName`、`durationMs`、`status`、`errorCode`
- tokens/latency（如可观测）

### 12.2 Metrics 建议

- 请求量、错误率、P95/P99 延迟
- 工具调用延迟与失败率
- 模型推理延迟与队列长度

## 13. 测试策略与验收标准（强制：冒烟 + 单元测试都要实际运行）

### 13.1 单元测试（必须）

覆盖重点：
- 证据链组装规则（数值必须有 citation 与时间范围）
- 错误模型映射（英文 message + 稳定 code）
- RBAC 拦截（越权请求必须失败并审计）
- SSE 事件序列化契约（事件类型与字段完整性）

### 13.2 冒烟测试（必须，且需真实服务）

- 启动真实 FastAPI 服务
- 使用真实 Postgres 实例（包含造数数据）
- 使用真实 llama.cpp 推理服务
- 验证至少两条链路：
  - 成本查询成功链路（SSE 流式输出 + evidence.update）
  - 权限不足/上游超时失败链路（结构化 error 事件）

### 13.3 L1 验收口径（建议）

- SSE 联调成功：前端可实时渲染 `message.delta` 与证据链。
- 审计覆盖率 100%：每次请求均有审计记录。
- 数值回答可追溯：关键数值均可展开证据。
- 错误可定位：任何错误都包含 `requestId`。

## 14. 里程碑与交付拆分（建议）

### 14.1 L1（最小闭环）

- Postgres 造数 + 只读工具
- SSE 对话接口
- 证据链 schema + Context Panel 联动
- RBAC（最小角色集）
- 审计落库
- 单元 + 冒烟测试通过

### 14.2 L2（诊断/多模态）

- 文档库与 RAG（设备手册/故障库）
- 多模态输入（图片/音频）与安全隔离
- 幻觉检测与降级策略增强

### 14.3 L3（决策辅助）

- 事件模型与时序对齐
- 物理边界/变化率 guardrail
- 指标口径仓库版本化完善

### 14.4 L4（受控写操作）

- 草案-审批-执行-回滚全链路
- HITL 中断/继续与持久化执行
- 熔断开关与安全网关

---

## 附录 A：术语表

- **SSE**：Server-Sent Events
- **Evidence**：证据链
- **HITL**：Human-in-the-loop（人在回路）
- **RBAC**：Role-based access control
- **Lineage**：指标口径版本与血缘

## 附录 B：错误码建议（可扩展）

- `VALIDATION_ERROR`
- `AUTH_ERROR`
- `FORBIDDEN`
- `NOT_FOUND`
- `UPSTREAM_TIMEOUT`
- `UPSTREAM_UNAVAILABLE`
- `CONTRACT_VIOLATION`
- `GUARDRAIL_BLOCKED`
- `EVIDENCE_MISSING`
- `EVIDENCE_MISMATCH`
